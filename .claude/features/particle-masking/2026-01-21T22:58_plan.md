# Implementation Plan: BUG-003 - Particles Not Masked to Sky Pixels

## Metadata

- **Feature:** particle-masking (BUG-003)
- **Created:** 2026-01-21T22:58
- **Status:** Ready for Implementation
- **Based On:** `.claude/active-work/particle-masking/diagnosis.md`
- **Type:** Bug Fix (Critical)

---

## Problem Summary

Particles spawn uniformly across the entire screen via `random.nextDouble()`. Non-sky particles are correctly hidden during rendering but waste particle pool slots (~50% of particles may be invisible when half screen is non-sky). This creates a "video overlay" effect instead of a "particles in sky" AR effect.

---

## Architecture Overview

### Current Flow (Buggy)

```
┌─────────────────────────────────────────────────────────────────┐
│                      PARTICLE LIFECYCLE                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. INITIALIZATION (initState)                                   │
│     ┌────────────────────┐                                       │
│     │ Particle(          │                                       │
│     │   x: random()      │ ◄── Spawns ANYWHERE on screen        │
│     │   y: random()      │                                       │
│     │ )                  │                                       │
│     └────────────────────┘                                       │
│                                                                  │
│  2. UPDATE LOOP (_onTick)                                        │
│     ┌────────────────────┐                                       │
│     │ if (p.isExpired)   │                                       │
│     │   p.reset(random)  │ ◄── Resets to ANYWHERE               │
│     └────────────────────┘                                       │
│                                                                  │
│  3. RENDER (CustomPainter)                                       │
│     ┌────────────────────┐                                       │
│     │ if (!isPointInSky) │                                       │
│     │   continue;        │ ◄── Correctly SKIPS non-sky          │
│     └────────────────────┘                                       │
│                                                                  │
│  RESULT: ~50% of particles INVISIBLE but still UPDATE           │
└─────────────────────────────────────────────────────────────────┘
```

### Fixed Flow (Target)

```
┌─────────────────────────────────────────────────────────────────┐
│                      PARTICLE LIFECYCLE                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. INITIALIZATION (initState)                                   │
│     ┌────────────────────┐                                       │
│     │ Particle(          │                                       │
│     │   x: random()      │ ◄── OK: Sky mask not ready yet       │
│     │   y: random()      │                                       │
│     │ )                  │                                       │
│     └────────────────────┘                                       │
│                                                                  │
│  2. UPDATE LOOP (_onTick)                                        │
│     ┌──────────────────────────────────────┐                     │
│     │ if (p.isExpired ||                   │                     │
│     │     !skyMask.isPointInSky(p.x, p.y)) │                     │
│     │   _resetToSkyPosition(p, skyMask)    │ ◄── FIND SKY SPOT  │
│     └──────────────────────────────────────┘                     │
│                                                                  │
│  3. NEW METHOD (_resetToSkyPosition)                             │
│     ┌────────────────────────────────────┐                       │
│     │ for (attempt = 0; attempt < 10)    │                       │
│     │   x, y = random(), random()        │                       │
│     │   if (skyMask.isPointInSky(x, y))  │ ◄── TRY UP TO 10x    │
│     │     FOUND!                         │                       │
│     │ fallback: random anyway            │ ◄── AVOID INFINITE   │
│     └────────────────────────────────────┘                       │
│                                                                  │
│  4. RENDER (CustomPainter) - UNCHANGED                           │
│     ┌────────────────────┐                                       │
│     │ if (!isPointInSky) │                                       │
│     │   continue;        │ ◄── Safety net still in place        │
│     └────────────────────┘                                       │
│                                                                  │
│  RESULT: ~100% of particles VISIBLE in sky region               │
└─────────────────────────────────────────────────────────────────┘
```

---

## Tech Stack

- **Language:** Dart
- **Framework:** Flutter 3.x
- **Testing:** flutter_test
- **Key Dependencies:** SkyMask interface (already exists)

---

## File Structure

### Files to Modify

| File | Lines | Change Description |
|------|-------|-------------------|
| `lib/widgets/particle_overlay.dart` | 161-181, 246-249 | Add `_resetToSkyPosition()` method, update `_onTick()` reset logic, update `_adjustParticlePool()` |
| `test/widgets/particle_overlay_test.dart` | EOF | Add tests for sky-constrained spawning behavior |

### No New Files Required

This is a targeted bug fix modifying existing code only.

---

## Component Architecture

### ParticleOverlayState Changes

```
_ParticleOverlayState
├── _resetToSkyPosition(Particle p, SkyMask skyMask)  ◄── NEW METHOD
│   ├── Tries up to 10 random positions
│   ├── Accepts first position where isPointInSky() == true
│   └── Falls back to random if no sky found (prevents infinite loop)
│
├── _adjustParticlePool(int newCount)                  ◄── MODIFY
│   └── Use _resetToSkyPosition() for new particles
│
└── _onTick(Duration elapsed)                          ◄── MODIFY
    └── Reset particles that:
        a. Are expired (age >= 1.0)
        b. Have drifted out of sky region
```

### Method Signature

```dart
/// Resets a particle to a random position within sky regions.
///
/// Tries up to [maxAttempts] times to find a valid sky position.
/// Falls back to a random position if no sky is found to prevent
/// infinite loops when the user is pointing at mostly non-sky.
///
/// Parameters:
/// - [p]: The particle to reset
/// - [skyMask]: The current sky detection mask
/// - [maxAttempts]: Maximum sampling attempts (default: 10)
void _resetToSkyPosition(Particle p, SkyMask skyMask, {int maxAttempts = 10})
```

---

## Data Flow

```
┌─────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  SkyMask    │────▶│ _resetToSkyPos() │────▶│ Particle.x/y    │
│ isPointIn() │     │ (samples up to   │     │ (updated to     │
│ skyFraction │     │  10 positions)   │     │  sky position)  │
└─────────────┘     └──────────────────┘     └─────────────────┘
      ▲                     │
      │                     │ if no sky found
      │                     ▼
      │             ┌──────────────────┐
      │             │ Random fallback  │
      │             │ (particle hidden │
      │             │  by render check)│
      │             └──────────────────┘
      │
      └─── skyFraction used to optimize:
           if skyFraction < 0.1, use wider search
```

---

## Testing Strategy

### Unit Tests (6 tests)

| Test | Description |
|------|-------------|
| 1 | `_resetToSkyPosition` places particle in sky when sky available |
| 2 | `_resetToSkyPosition` falls back gracefully when no sky (skyFraction = 0) |
| 3 | `_resetToSkyPosition` respects maxAttempts limit |
| 4 | Particles drifting out of sky are reset |
| 5 | Expired particles reset to sky positions |
| 6 | New particles from pool expansion spawn in sky |

### Integration Tests (2 tests)

| Test | Description |
|------|-------------|
| 1 | After several frames, all visible particles are in sky region |
| 2 | Sky fraction changes trigger particle redistribution |

### Manual Device Tests

| Scenario | Expected Result |
|----------|-----------------|
| Point at sky with buildings | Particles only in sky, not on buildings |
| Pan camera left/right | Particles stay anchored to sky regions |
| Tilt down (no sky) | Particles sparse/absent, no crashes |
| Sky fraction changes rapidly | Smooth particle redistribution |

---

## Performance Considerations

### Critical Constraint: < 16ms per frame

The `_resetToSkyPosition` method adds overhead:

```
Worst case per particle reset:
- 10 random() calls: ~0.001ms
- 10 isPointInSky() calls: ~0.01ms (mask lookup is O(1))
- Total: ~0.011ms per particle reset

Particles reset per frame: ~67 (2000 particles / 30 frames lifespan)
Total overhead: ~0.7ms per frame

ACCEPTABLE: Well under 16ms budget
```

### Optimization: Skip Expensive Checks When Possible

```dart
// Quick check: if skyFraction is very high, almost any position works
if (skyMask.skyFraction > 0.9) {
  p.x = _random.nextDouble();
  p.y = _random.nextDouble() * 0.8; // Bias toward top
  p.age = 0.0;
  return;
}
```

---

## Implementation Notes

### Decision 1: Keep Rendering Check

The existing `if (!skyMask.isPointInSky(p.x, p.y)) continue;` in the painter is kept as a safety net. This handles:
- First frame before any resets
- Edge cases where sky mask updates faster than particle positions
- Particles that might slip through due to timing

### Decision 2: Reset Drifted Particles

Particles that drift out of sky (due to wind movement or camera pan) are immediately reset. This keeps all particles productive.

### Decision 3: 10 Attempt Limit

10 attempts balances:
- High success rate: With 50% sky, P(success) = 1 - 0.5^10 = 99.9%
- Low CPU cost: Only 10 random samples per reset
- No infinite loops: Guaranteed termination

### Decision 4: No Changes to Particle Model

The `Particle` class remains unchanged. Sky-awareness is handled in the overlay, keeping the model simple.

---

## Non-Goals

- **NOT changing the rendering logic** - It works correctly
- **NOT adding ML-based spawn optimization** - Overkill for this fix
- **NOT changing particle pool size dynamically based on sky** - Performance manager already handles this
- **NOT implementing spatial hashing for sky regions** - isPointInSky() is already O(1)

---

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| Performance degradation | 10-attempt limit caps worst case; profile before/after |
| Infinite loop | maxAttempts parameter with fallback |
| Visual discontinuity | Keep rendering check as safety net |
| Test flakiness | Use seeded Random for deterministic tests |

---

## Success Criteria

1. Particles visually appear ONLY in sky regions
2. No performance regression (maintain 60 FPS)
3. No crashes when sky fraction is 0
4. All existing tests pass
5. New tests cover sky-constrained spawning

---

## References

- Diagnosis report: `.claude/active-work/particle-masking/diagnosis.md`
- SkyMask interface: `lib/services/sky_detection/sky_mask.dart`
- Current implementation: `lib/widgets/particle_overlay.dart`
- Existing tests: `test/widgets/particle_overlay_test.dart`
