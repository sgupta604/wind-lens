# Plan: performance-optimization

## Metadata
- **Feature:** performance-optimization
- **Created:** 2026-02-02T21:51
- **Status:** plan-complete
- **Based On:** 2026-02-02T21:49_research.md
- **Planner:** plan-agent

---

## CRITICAL CONSTRAINT

> **"It is critical that you don't break what works already"** - User

All changes MUST:
1. Be incremental (one optimization at a time)
2. Include tests that verify existing behavior
3. Have clear rollback points
4. Verify FPS improvement after each change

---

## Executive Summary

The app runs at 5 FPS (target: 45-60 FPS). The PerformanceManager has already reduced particles to 976 (from 2000), but FPS is still at 5. This proves the bottleneck is NOT particle count - it's per-frame overhead.

**Root Causes Identified:**
1. `debugPrint()` spam on every frame/sensor update (HIGHEST IMPACT)
2. `setState(() {})` called every tick in ParticleOverlay (HIGH IMPACT)
3. Object allocations in render loop (MEDIUM IMPACT)
4. Inefficient data structures in PerformanceManager (LOW IMPACT)

**Expected Outcome:**
- Phase 2 (debugPrint removal): +40-80% FPS improvement
- Phase 3 (setState optimization): +20-40% FPS improvement
- Phase 4 (allocation reduction): +10-20% FPS improvement
- **Total: 45+ FPS achievable**

---

## Architecture Overview

### Current Data Flow (Performance Bottleneck)

```
+------------------+      +-------------------+      +------------------+
|  Camera Frame    |----->| Sky Detector      |----->| ParticleOverlay  |
|  (~30 FPS)       |      | processFrame()    |      | _onTick()        |
+------------------+      +-------------------+      +------------------+
         |                        |                          |
         v                        v                          v
  debugPrint()             debugPrint()               setState(() {})
  on init                  EVERY FRAME               EVERY TICK
                           (LINE 414)                (LINE 309)
                                |
                                v
                         +---------------+
                         |   Console     |
                         |   I/O Block   |  <-- MAIN BOTTLENECK
                         +---------------+

+------------------+
|  Compass Service |
|  (~50-100 Hz)    |
+------------------+
         |
         v
  debugPrint()
  EVERY SENSOR UPDATE
  (LINES 130-133)
```

### Optimized Data Flow (Target)

```
+------------------+      +-------------------+      +------------------+
|  Camera Frame    |----->| Sky Detector      |----->| ParticleOverlay  |
|  (~30 FPS)       |      | processFrame()    |      | _onTick()        |
+------------------+      +-------------------+      +------------------+
                                                             |
                                                             v
                                                    markNeedsPaint()
                                                    (CustomPainter only)

+------------------+
|  Compass Service |
|  (~50-100 Hz)    |
+------------------+
         |
         v
   [No console I/O]
```

---

## Tech Stack

- **Framework:** Flutter 3.x with Dart
- **Key Files:**
  - `lib/widgets/particle_overlay.dart` (411 lines)
  - `lib/services/sky_detection/auto_calibrating_sky_detector.dart` (509 lines)
  - `lib/services/compass_service.dart` (151 lines)
  - `lib/services/performance_manager.dart` (132 lines)
  - `lib/utils/color_utils.dart` (90 lines)

---

## File Structure

### Files to Modify

| File | Lines | Changes | Risk |
|------|-------|---------|------|
| `auto_calibrating_sky_detector.dart` | 414, 266, 506 | Remove/gate debugPrint | LOW |
| `compass_service.dart` | 130-133 | Remove/gate debugPrint | LOW |
| `particle_overlay.dart` | 309 | Replace setState with markNeedsPaint | MEDIUM |
| `particle_overlay.dart` | 392-393, 396, 400 | Pre-allocate Offsets, cache Colors | MEDIUM |
| `color_utils.dart` | 87 | Avoid List allocation in yuvToRgb | LOW |
| `performance_manager.dart` | 85-94 | Use circular buffer | LOW |

### Files to Create

None - this is optimization of existing code only.

### Files to Add Tests To

| Test File | Purpose |
|-----------|---------|
| `test/widgets/particle_overlay_test.dart` | Add regression tests for visual output |
| `test/services/sky_detection/auto_calibrating_sky_detector_test.dart` | Add test for logging behavior |
| `test/services/compass_service_test.dart` | Add test for logging behavior |
| `test/services/performance_manager_test.dart` | Add circular buffer tests |

---

## Component Architecture

### ParticleOverlay Optimization

**Current (SLOW):**
```
_ParticleOverlayState
    |
    +-- _onTick()
    |       |
    |       +-- Update particles
    |       +-- setState(() {})  <-- Triggers full widget rebuild
    |
    +-- build()
            |
            +-- CustomPaint(painter: ParticleOverlayPainter(...))
```

**Optimized (FAST):**
```
_ParticleOverlayState
    |
    +-- _onTick()
    |       |
    |       +-- Update particles
    |       +-- _repaintNotifier.value++  <-- Just increment counter
    |
    +-- build()
            |
            +-- RepaintBoundary
                    |
                    +-- CustomPaint(
                            repaint: _repaintNotifier,  <-- Listen to notifier
                            painter: ParticleOverlayPainter(...)
                        )
```

**Alternative (Simpler):**
- Keep setState but wrap in RepaintBoundary to isolate repaints
- Only rebuild the CustomPaint, not the whole widget tree

---

## Data Model Changes

No database/model changes required. This is pure optimization work.

---

## Testing Strategy

### Unit Tests (Existing - Must Pass)

All 254 existing tests must continue to pass after each change.

### Regression Tests (New)

| Test | File | Purpose |
|------|------|---------|
| `particle positions update correctly` | particle_overlay_test.dart | Verify particle movement unchanged |
| `compass updates still fire` | compass_service_test.dart | Verify events still emitted |
| `sky detection still works` | auto_calibrating_sky_detector_test.dart | Verify mask generation unchanged |

### Performance Tests (Manual on Device)

| Test | Method | Success Criteria |
|------|--------|------------------|
| FPS after debugPrint removal | Run on device, check debug panel | FPS >= 20 |
| FPS after setState optimization | Run on device, check debug panel | FPS >= 40 |
| FPS after all optimizations | Run on device, check debug panel | FPS >= 45 |

### Integration Tests

Run full test suite after each phase:
```bash
flutter test
```

---

## Implementation Notes

### Decision: setState vs markNeedsPaint

**Option A: Keep setState, wrap in RepaintBoundary**
- Pros: Minimal code change, lower risk
- Cons: Still triggers state rebuild (just isolated)

**Option B: Use ValueNotifier + repaint parameter**
- Pros: Most efficient, no setState at all
- Cons: More code change

**Decision:** Start with Option A (lower risk). If insufficient, try Option B.

### Decision: Color Caching Strategy

**Option A: Cache common alpha values**
```dart
late final Color _glowColor30; // color.withValues(alpha: 0.3)
late final Color _glowColor90; // color.withValues(alpha: 0.9)
```
- Pros: Simple
- Cons: Need pre-computed for each opacity level

**Option B: Cache base color, set alpha on paint**
```dart
_glowPaint.color = color;
// Alpha applied via paint.color = paint.color.withAlpha(...)
```
- Cons: Still allocates

**Decision:** Option A - pre-compute colors for common opacity values.

### Decision: Offset Allocation

**Option A: Reuse Offset instances**
- Not possible - Offset is immutable

**Option B: Use raw drawLine(x1, y1, x2, y2)**
- Flutter's Canvas doesn't support raw coordinates

**Option C: Accept Offset allocation, optimize elsewhere**
- 4000 Offsets/frame is manageable
- Focus on bigger wins first

**Decision:** Defer Offset optimization. Focus on debugPrint and setState first.

---

## Non-Goals

These are explicitly NOT part of this optimization:

1. **GPU-based particle rendering** - Too complex, not needed for target FPS
2. **ML-based sky detection optimization** - Not the bottleneck
3. **Advanced particle LOD system** - Existing PerformanceManager is sufficient
4. **Rewriting in native code** - Flutter is capable of 60 FPS
5. **Reducing particle count** - Already proven not to be the issue

---

## Risk Mitigation

### Risk 1: Breaking Visual Output
- **Mitigation:** Run all tests after each change
- **Rollback:** Git revert to previous commit

### Risk 2: Breaking Sensor Integration
- **Mitigation:** Test on real device after compass changes
- **Rollback:** Re-add debugPrint calls if issues found

### Risk 3: Insufficient Improvement
- **Mitigation:** Profile FPS after each phase
- **Escalation:** If <30 FPS after all optimizations, investigate further

### Risk 4: Platform-Specific Issues
- **Mitigation:** Test on both iOS and Android
- **Note:** User screenshot shows iOS; prioritize iOS testing

---

## Verification Checkpoints

### After Phase 1 (Baseline)
- [ ] All 254 tests pass
- [ ] FPS baseline documented (should be ~5)
- [ ] Regression tests added

### After Phase 2 (debugPrint removal)
- [ ] All tests pass
- [ ] FPS improved (expect 20-40 FPS)
- [ ] No console spam in debug mode

### After Phase 3 (setState optimization)
- [ ] All tests pass
- [ ] FPS improved (expect 40-50 FPS)
- [ ] Particle animation still smooth

### After Phase 4 (Allocation optimization)
- [ ] All tests pass
- [ ] FPS >= 45 (target met)
- [ ] No memory leaks

### After Phase 5 (Verification)
- [ ] All 254+ tests pass
- [ ] FPS >= 45 on real device
- [ ] Visual output unchanged
- [ ] All features working

---

## Success Criteria

1. **FPS >= 45** on real iOS device (from current 5)
2. **All 254+ tests passing**
3. **No visual regressions** in particle rendering
4. **Sky detection still works** correctly
5. **World anchoring still works** correctly
6. **Debug panel still shows** correct metrics
7. **No breaking changes** to existing functionality

---

## Next Step

**Ready for implementation.**

Run `/implement performance-optimization` to begin Phase 1 (Baseline & Safety).
