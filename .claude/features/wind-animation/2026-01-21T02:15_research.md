# Research: wind-animation

## Metadata
- **Feature:** wind-animation
- **Created:** 2026-01-21T02:15
- **Status:** research-complete

## Requirements from Spec

From `ROADMAP.md` Feature 5 and `WIND_LENS_MVP_SPEC.md`:

### What to Build
- WindData model (u, v components)
- FakeWindService (simulated data)
- Wind math:
  - speed = sqrt(u² + v²)
  - direction = atan2(-u, -v) (meteorological convention)
  - screenAngle = windDirection - compassHeading
- Particles flow in wind direction
- Particles stay "world-fixed" (compass integration)

### Acceptance Criteria
- [ ] Particles flow in consistent direction
- [ ] Direction changes when phone rotates (world-fixed)
- [ ] Wind speed affects particle velocity
- [ ] Smooth animation at 60 FPS

## From MVP Spec Section 5 - Data Models

### WindData Model
```dart
class WindData {
  final double uComponent;      // m/s, positive = eastward
  final double vComponent;      // m/s, positive = northward
  final double altitude;        // meters above sea level
  final DateTime timestamp;

  // Computed properties
  double get speed => sqrt(uComponent * uComponent + vComponent * vComponent);
  double get directionRadians => atan2(-uComponent, -vComponent); // meteorological convention
  double get directionDegrees => (directionRadians * 180 / pi + 360) % 360;
}
```

### From MVP Spec Section 7 - Fake Data Fallback

```dart
class FakeWindService {
  WindData getWindForAltitude(AltitudeLevel level) {
    final time = DateTime.now().millisecondsSinceEpoch / 1000;

    return switch (level) {
      AltitudeLevel.surface => WindData(
        uComponent: 3.0 + sin(time * 0.1) * 2.0,   // 1-5 m/s, varying
        vComponent: 2.0 + cos(time * 0.15) * 1.5,  // light breeze
        altitude: 10,
        timestamp: DateTime.now(),
      ),
      // ... other levels
    };
  }
}
```

**Fake Data Characteristics:**
| Level | Typical Speed | Direction | Visual Feel |
|-------|--------------|-----------|-------------|
| Surface | 2-6 m/s | Variable | Gentle drift |
| Mid-level | 5-15 m/s | More consistent | Steady flow |
| Jet Stream | 30-70 m/s | Predominantly West→East | FAST rivers |

### From MVP Spec Section 9 - Movement Calculation

```dart
void updateParticle(Particle p, WindData wind, double dt, double compassHeading) {
  // Convert wind vector to screen-space movement
  // Account for compass heading so wind appears world-fixed

  double windAngle = wind.directionRadians;
  double adjustedAngle = windAngle - (compassHeading * pi / 180);

  // Speed scaling: m/s → screen fraction per second
  double speedFactor = wind.speed * 0.002;

  // Update position
  p.x += cos(adjustedAngle) * speedFactor * dt;
  p.y -= sin(adjustedAngle) * speedFactor * dt; // screen Y is inverted

  // Age particle
  p.age += dt * 0.3; // particles live ~3 seconds

  // Calculate trail length based on speed
  p.trailLength = wind.speed * 0.5; // pixels
}
```

## Existing Code Analysis

### Current State
- Project at `/workspace/wind_lens`
- ParticleOverlay exists (`lib/widgets/particle_overlay.dart`) with:
  - Fixed `windAngle` parameter (currently hardcoded 0.0)
  - Ticker-based animation at 60 FPS
  - Pre-allocated particle pool (2000 particles)
  - 2-pass glow rendering
  - Sky mask integration
- CompassService exists (`lib/services/compass_service.dart`) with:
  - `heading` getter (0-360 degrees)
  - `pitch` getter (device tilt)
  - Smoothing and dead zones
- ARViewScreen integrates both but windAngle is fixed at 0.0

### Key Integration Points

1. **ParticleOverlay.windAngle** - Currently fixed, needs to receive dynamic value
2. **Particle movement** - Currently only ages, needs position updates based on wind
3. **ARViewScreen** - Needs to connect compass heading to wind calculation

### Architecture to Add
```
lib/
├── models/
│   └── wind_data.dart              # WindData with u/v components
└── services/
    └── fake_wind_service.dart      # Simulated wind data
```

### Files to Modify
- `lib/widgets/particle_overlay.dart` - Add particle movement logic
- `lib/screens/ar_view_screen.dart` - Connect compass to wind angle

## Technical Constraints

From CLAUDE.md and MVP Spec:
- **Performance:** Maintain 60 FPS with 2000 particles
- **No object allocation in render loop** - Critical for performance
- **World-fixed particles** - Rotate phone, particles stay in same direction
- **Smooth animation** - Use delta-time for frame-rate independence

### Wind Math Reference
```dart
// From CLAUDE.md
speed = sqrt(u² + v²)
direction = atan2(-u, -v)  // meteorological convention
screenAngle = windDirection - compassHeading
```

### Meteorological Conventions
- Wind direction: The direction wind is coming FROM (North wind blows southward)
- u-component: Positive = eastward (wind blowing toward east)
- v-component: Positive = northward (wind blowing toward north)

## Open Questions

All resolved from spec:
- [x] Wind source for MVP? → FakeWindService (simulated data)
- [x] Compass integration? → screenAngle = windDirection - compassHeading (in radians)
- [x] Movement speed? → speed * 0.002 screen fractions per second per m/s
- [x] Trail length? → wind.speed * 0.5 pixels

## Recommended Approach

### 1. Create WindData Model
```dart
class WindData {
  final double uComponent;
  final double vComponent;
  final double altitude;
  final DateTime timestamp;

  const WindData({
    required this.uComponent,
    required this.vComponent,
    required this.altitude,
    required this.timestamp,
  });

  double get speed => sqrt(uComponent * uComponent + vComponent * vComponent);
  double get directionRadians => atan2(-uComponent, -vComponent);
  double get directionDegrees => (directionRadians * 180 / pi + 360) % 360;

  static WindData zero() => WindData(
    uComponent: 0, vComponent: 0, altitude: 0, timestamp: DateTime.now(),
  );
}
```

### 2. Create FakeWindService
```dart
class FakeWindService {
  WindData getWind() {
    final time = DateTime.now().millisecondsSinceEpoch / 1000;

    // Surface-level wind for MVP (altitude levels come later)
    return WindData(
      uComponent: 3.0 + sin(time * 0.1) * 2.0,  // 1-5 m/s
      vComponent: 2.0 + cos(time * 0.15) * 1.5,
      altitude: 10,
      timestamp: DateTime.now(),
    );
  }
}
```

### 3. Update ParticleOverlay
- Add compass heading parameter
- Update _onTick to move particles based on wind direction
- Calculate screen angle: windDirection - compassHeading (in radians)
- Move particles: x += cos(angle) * speed * dt, y -= sin(angle) * speed * dt
- Update trail length based on wind speed

### 4. Update ARViewScreen
- Create FakeWindService instance
- Pass heading to ParticleOverlay
- Pass wind data to ParticleOverlay

### Architecture After Changes
```dart
ARViewScreen
├── CompassService (existing)
│   └── provides: heading, pitch
├── FakeWindService (NEW)
│   └── provides: WindData (u, v, speed, direction)
├── PitchBasedSkyMask (existing)
│   └── provides: skyFraction, isPointInSky()
└── ParticleOverlay (MODIFIED)
    ├── particles move based on WindData
    ├── direction adjusted by compass heading
    └── particles stay world-fixed
```

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Frame rate drop | Poor UX | Use delta-time, pre-allocate WindData |
| Jittery particles | Visual quality | Use smoothed compass heading |
| Wrong direction math | Looks fake | Use atan2(-u, -v) convention |
| Object allocation | GC stutter | Reuse WindData instance |

## Dependencies

- **Depends on:** `particle-system` (complete - provides ParticleOverlay)
- **Required by:** `altitude-depth` (will add per-altitude wind data)

## Performance Budget

| Operation | Budget | Expected |
|-----------|--------|----------|
| FakeWindService.getWind() | <1ms | ~0.01ms |
| Wind angle calculation | <1ms | ~0.001ms |
| Particle movement (2000) | 2ms | ~1ms |
| **Total added per frame** | **<4ms** | **~1ms** |

Current particle system budget: ~6ms per 16ms frame
With wind animation: ~7ms per 16ms frame → Still well within budget

## Next Step

Run `/plan wind-animation` to design detailed implementation.
