# Plan: Altitude Slider Drag Gesture (BUG-005)

## Metadata
- **Feature:** altitude-slider (bug fix)
- **Created:** 2026-01-22T10:30
- **Status:** plan-complete
- **Based On:** `.claude/active-work/altitude-slider/diagnosis.md`
- **Priority:** LOW

## Problem Summary

The altitude slider implements tap-to-select but not drag-to-select, despite the MVP spec requiring both:
> "Interaction: Tap segment OR drag"

Users perceive the control as "buttons" rather than a "slider" because they cannot drag between levels.

## Architecture Overview

### Current Structure
```
AltitudeSlider (StatelessWidget)
└── ClipRRect (rounded corners)
    └── BackdropFilter (glassmorphism blur)
        └── Container (styling)
            └── Column
                ├── GestureDetector (JET) → onTap only
                ├── GestureDetector (MID) → onTap only
                └── GestureDetector (SFC) → onTap only
```

### Target Structure
```
AltitudeSlider (StatelessWidget)
└── GestureDetector (NEW - handles drag for entire widget)
    └── ClipRRect (rounded corners)
        └── BackdropFilter (glassmorphism blur)
            └── Container (styling)
                └── Column
                    ├── GestureDetector (JET) → onTap (unchanged)
                    ├── GestureDetector (MID) → onTap (unchanged)
                    └── GestureDetector (SFC) → onTap (unchanged)
```

## Technical Approach

### Solution: Outer GestureDetector with Vertical Drag

Wrap the entire slider in a `GestureDetector` that handles vertical drag gestures. During drag, calculate which segment the finger is over based on Y position.

```
┌─────────────────────────────────────┐
│  Outer GestureDetector              │
│  - onVerticalDragUpdate             │
│                                     │
│  ┌─────────────────────────────┐    │
│  │ ClipRRect + BackdropFilter  │    │
│  │  ┌───────────────────────┐  │    │
│  │  │ JET (0 - 56px)        │  │    │  ← Segment 0 (index 0)
│  │  ├───────────────────────┤  │    │
│  │  │ MID (56 - 112px)      │  │    │  ← Segment 1 (index 1)
│  │  ├───────────────────────┤  │    │
│  │  │ SFC (112 - 168px)     │  │    │  ← Segment 2 (index 2)
│  │  └───────────────────────┘  │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### Hit-Testing Logic

```dart
AltitudeLevel _levelFromY(double localY) {
  // Segment height is 56px
  // JET: 0-56, MID: 56-112, SFC: 112-168
  final segmentIndex = (localY / _segmentHeight).floor().clamp(0, 2);

  return switch (segmentIndex) {
    0 => AltitudeLevel.jetStream,
    1 => AltitudeLevel.midLevel,
    _ => AltitudeLevel.surface,
  };
}
```

### Gesture Handler

```dart
onVerticalDragUpdate: (details) {
  final newLevel = _levelFromY(details.localPosition.dy);
  if (newLevel != value) {
    HapticFeedback.lightImpact();
    onChanged(newLevel);
  }
}
```

## Tech Stack

- **Flutter widgets:** GestureDetector with `onVerticalDragUpdate`
- **Haptics:** `HapticFeedback.lightImpact()` (already imported)
- **No new dependencies required**

## File Changes

### Modified Files

| File | Lines | Change Description |
|------|-------|-------------------|
| `lib/widgets/altitude_slider.dart` | 64-101 | Wrap build() return value in GestureDetector |
| `test/widgets/altitude_slider_test.dart` | (add) | Add drag gesture test |

### Code Change Details

**File: `lib/widgets/altitude_slider.dart`**

1. Add helper method `_levelFromY(double localY)` (~8 lines)
2. Wrap `ClipRRect` in `GestureDetector` with `onVerticalDragUpdate` (~10 lines)

**Estimated total:** ~18 lines of new code

## Component Architecture

```
AltitudeSlider
├── Properties
│   ├── value: AltitudeLevel (current selection)
│   └── onChanged: ValueChanged<AltitudeLevel>
├── Constants
│   ├── _width: 60.0
│   ├── _segmentHeight: 56.0
│   └── _borderRadius: 12.0
├── Methods (existing)
│   ├── _getLabel(AltitudeLevel) → String
│   └── _buildSegment(...) → Widget
└── Methods (NEW)
    └── _levelFromY(double localY) → AltitudeLevel
```

## Testing Strategy

### Unit Tests (1 new test)

| Test | Description |
|------|-------------|
| `calls onChanged when dragging between segments` | Simulate drag gesture, verify callback fires with correct level |

### Manual Testing

| Scenario | Expected Result |
|----------|-----------------|
| Drag from JET to SFC | All three levels selected in order, 2 haptic ticks |
| Drag from SFC to JET | All three levels selected in order, 2 haptic ticks |
| Tap JET while on SFC | JET selected, 1 haptic tick (existing behavior) |
| Drag and hold within segment | No repeated callbacks |
| Drag starting outside widget | No crash, no unexpected selection |

## Implementation Notes

### Design Decisions

1. **Outer GestureDetector vs replacing inner ones:** Using outer GestureDetector because:
   - Simpler implementation
   - Drag gesture needs to span all segments
   - Inner tap gestures still work (GestureDetector passes through)

2. **Stateless widget preserved:** No need for StatefulWidget since we track no internal state - the parent manages `value`.

3. **No debouncing needed:** With only 3 segments and discrete selection, rapid callbacks are acceptable.

### Patterns Used

- **Gesture hit-testing:** Convert Y position to segment index
- **Boundary clamping:** Prevent out-of-bounds when dragging past edges

### Trade-offs

| Decision | Pro | Con |
|----------|-----|-----|
| Outer GestureDetector | Simple, works with existing taps | Gesture arena complexity |
| No StatefulWidget | Simple, no unnecessary state | None |
| Direct callback | Responsive | Multiple callbacks if dragging fast |

## Non-Goals

- **NOT implementing:** Continuous slider (we have 3 discrete levels)
- **NOT changing:** Visual design or glassmorphism styling
- **NOT adding:** Animation between levels
- **NOT implementing:** Horizontal drag (vertical only per spec)

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Gesture conflict with inner taps | Low | Minor | Test both interactions work |
| Y coordinate off by border/padding | Low | Minor | Test edge cases |
| Performance impact | Very Low | None | Simple math, no allocations |

## Quality Gates

Before marking complete:
- [ ] Drag gesture changes altitude level
- [ ] Tap gesture still works (no regression)
- [ ] Haptic feedback on each level change during drag
- [ ] No duplicate callbacks when holding within same segment
- [ ] Widget tests pass

## Performance Impact

- **Additional per-frame cost:** 0ms (drag handler only fires on gesture events)
- **Memory impact:** None (no new objects allocated)

## Next Step

Run `/implement altitude-slider` to add drag gesture support.
