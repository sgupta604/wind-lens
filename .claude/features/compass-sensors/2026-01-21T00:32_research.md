# Research: compass-sensors

## Metadata
- **Feature:** compass-sensors
- **Created:** 2026-01-21T00:32
- **Status:** research-complete

## Requirements from Spec

From `ROADMAP.md` Feature 2 and `WIND_LENS_MVP_SPEC.md` Section 11:

### What to Build
- CompassService using sensors_plus
- Heading detection (magnetometer)
- Pitch detection (accelerometer)
- Smoothing (factor: 0.1)
- Dead zones (heading: 1.0°, pitch: 2.0°)

### Acceptance Criteria
- [ ] Heading updates as phone rotates
- [ ] Pitch updates as phone tilts
- [ ] Logs: "Heading: X°, Pitch: Y°"
- [ ] No jitter when stationary

### From MVP Spec Section 11 - Compass Integration

**Data Flow:**
```
Magnetometer (sensors_plus)          Accelerometer (sensors_plus)
    ↓                                     ↓
Raw heading (degrees from north)     Raw pitch (phone tilt)
    ↓                                     ↓
Smoothing filter (low-pass)          Smoothing filter
    ↓                                     ↓
compassHeading state                 pitchDegrees state
    ↓                                     ↓
    └──────────────┬──────────────────────┘
                   ↓
           Particle system
    (adjusts render angle + floor check)
```

**Key Constants (from spec):**
- Smoothing factor: 0.1 (lower = smoother, more lag)
- Heading dead zone: 1.0°
- Pitch dead zone: 2.0°

### CompassService Implementation (from spec)
```dart
class CompassService {
  double _smoothedHeading = 0;
  double _smoothedPitch = 0;
  static const double _smoothingFactor = 0.1;
  static const double _headingDeadZone = 1.0;  // degrees
  static const double _pitchDeadZone = 2.0;    // degrees

  void onMagnetometerEvent(MagnetometerEvent event) {
    double rawHeading = atan2(event.y, event.x) * 180 / pi;
    rawHeading = (rawHeading + 360) % 360;

    // Handle wraparound (359° → 1°)
    double delta = rawHeading - _smoothedHeading;
    if (delta > 180) delta -= 360;
    if (delta < -180) delta += 360;

    // DEAD ZONE: If change is tiny, ignore it
    if (delta.abs() < _headingDeadZone) {
      return;
    }

    _smoothedHeading = (_smoothedHeading + delta * _smoothingFactor + 360) % 360;
  }

  void onAccelerometerEvent(AccelerometerEvent event) {
    double rawPitch = atan2(-event.z, event.y) * 180 / pi;

    double delta = rawPitch - _smoothedPitch;

    if (delta.abs() < _pitchDeadZone) {
      return;
    }

    _smoothedPitch += delta * _smoothingFactor;
  }

  double get heading => _smoothedHeading;
  double get pitch => _smoothedPitch;
}
```

## Existing Code Analysis

### Current State
- Project at `/workspace/wind_lens`
- `sensors_plus: ^7.0.0` dependency already in pubspec.yaml
- No `lib/services/` directory exists yet
- CameraView and ARViewScreen already implemented
- iOS/Android motion permissions configured in project-setup

### Architecture from Spec
```
lib/
├── services/
│   └── compass_service.dart      # Wraps magnetometer stream
```

### sensors_plus Package API
```dart
// Magnetometer events
magnetometerEventStream().listen((MagnetometerEvent event) {
  // event.x, event.y, event.z - magnetic field in microteslas
});

// Accelerometer events
accelerometerEventStream().listen((AccelerometerEvent event) {
  // event.x, event.y, event.z - acceleration in m/s²
});
```

## Technical Constraints

From CLAUDE.md:
- **MUST test on real device** - simulator has no sensors
- Smoothing factor: 0.1
- Heading dead zone: 1.0°
- Pitch dead zone: 2.0°

### Performance Targets
- Sensor updates should not block UI
- Smoothing should eliminate jitter when stationary
- Heading wraparound must be handled (359° → 1°)

## Open Questions

All resolved:
- [x] Where to put CompassService? → `lib/services/compass_service.dart`
- [x] How to expose data? → Getters for `heading` and `pitch`, streams for reactive updates
- [x] Stream subscriptions lifecycle? → Service manages its own subscriptions, call `dispose()`
- [x] How to integrate with ARViewScreen? → Provider or direct service instance

## Recommended Approach

### 1. Create Services Directory
```
lib/
└── services/
    └── compass_service.dart
```

### 2. Implement CompassService
- Use sensors_plus for magnetometer and accelerometer streams
- Implement smoothing algorithm from spec
- Implement dead zones from spec
- Handle heading wraparound correctly
- Provide Stream for reactive updates (optional)
- Log heading and pitch: "Heading: X°, Pitch: Y°"

### 3. Service Interface
```dart
class CompassService {
  // Getters
  double get heading;
  double get pitch;

  // Stream for reactive updates
  Stream<CompassData> get stream;

  // Lifecycle
  void start();
  void dispose();
}

class CompassData {
  final double heading;
  final double pitch;
}
```

### 4. Integration with ARViewScreen
- Add CompassService to ARViewScreen state
- Start service in initState
- Dispose in dispose
- Could later pass to CameraView via callback or state management

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Magnetometer not available | App crashes | Check availability, show error |
| Sensor jitter | Particles vibrate | Dead zones + smoothing |
| Heading wraparound bugs | Jerky rotation | Use delta-based calculation |
| Testing limitations | Can't verify on simulator | Document real device testing |
| Sensor accuracy varies | Inaccurate heading | Recommend compass calibration |

## Dependencies

- **Depends on:** `project-setup` (sensors_plus dependency)
- **Required by:** `sky-detection` (pitch for sky fraction), `wind-animation` (heading for particles)

## Next Step

Run `/plan compass-sensors` to design detailed implementation.
