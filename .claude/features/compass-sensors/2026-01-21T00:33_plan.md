# Plan: compass-sensors

## Metadata
- **Feature:** compass-sensors
- **Created:** 2026-01-21T00:33
- **Status:** plan-complete
- **Based On:** 2026-01-21T00:32_research.md

---

## Architecture Overview

### Component Hierarchy

```
ARViewScreen (StatefulWidget)
    |
    +-- CompassService (manages sensor streams)
    |       |
    |       +-- MagnetometerStream (sensors_plus)
    |       +-- AccelerometerStream (sensors_plus)
    |
    +-- CameraView (existing)
    |
    +-- Debug Overlay (temporary, for verification)
            |
            +-- Heading display
            +-- Pitch display
```

### Data Flow

```
+-------------------+         +--------------------+
| Magnetometer      |         | Accelerometer      |
| (sensors_plus)    |         | (sensors_plus)     |
+--------+----------+         +---------+----------+
         |                              |
         v                              v
+--------+----------+         +---------+----------+
| Raw Heading       |         | Raw Pitch          |
| atan2(y, x)       |         | atan2(-z, y)       |
+--------+----------+         +---------+----------+
         |                              |
         v                              v
+--------+----------+         +---------+----------+
| Dead Zone Check   |         | Dead Zone Check    |
| (1.0 degree)      |         | (2.0 degrees)      |
+--------+----------+         +---------+----------+
         |                              |
         v                              v
+--------+----------+         +---------+----------+
| Low-Pass Filter   |         | Low-Pass Filter    |
| (factor: 0.1)     |         | (factor: 0.1)      |
+--------+----------+         +---------+----------+
         |                              |
         +---------------+--------------+
                         |
                         v
              +----------+-----------+
              | CompassData          |
              | (heading, pitch)     |
              +----------+-----------+
                         |
                         v
              +----------+-----------+
              | Stream<CompassData>  |
              | (for reactive UI)    |
              +----------------------+
```

---

## Tech Stack Summary

| Component | Technology | Version |
|-----------|------------|---------|
| Framework | Flutter | 3.x |
| Sensor Package | sensors_plus | ^7.0.0 |
| Math | dart:math | core |
| Async | dart:async | core |

---

## File Structure

### New Files to Create

| File | Purpose |
|------|---------|
| `lib/services/compass_service.dart` | Core service with sensor streams, smoothing, dead zones |
| `lib/models/compass_data.dart` | Data class for heading and pitch values |
| `test/services/compass_service_test.dart` | Unit tests for CompassService |

### Files to Modify

| File | Changes | Location |
|------|---------|----------|
| `lib/screens/ar_view_screen.dart` | Add CompassService integration and debug overlay | Lines 1-19 (convert to StatefulWidget) |

---

## Component Specifications

### CompassData Model

```dart
/// Immutable data class holding compass readings.
class CompassData {
  final double heading;  // 0-360 degrees from north
  final double pitch;    // Degrees of phone tilt

  const CompassData({
    required this.heading,
    required this.pitch,
  });
}
```

### CompassService Class

**Public API:**
```dart
class CompassService {
  // Current values
  double get heading;
  double get pitch;

  // Reactive stream
  Stream<CompassData> get stream;

  // Lifecycle
  void start();
  void dispose();
}
```

**Key Constants:**
- `_smoothingFactor`: 0.1 (lower = smoother, more lag)
- `_headingDeadZone`: 1.0 degrees
- `_pitchDeadZone`: 2.0 degrees

**Algorithm Details:**

1. **Heading Calculation:**
   - Raw: `atan2(event.y, event.x) * 180 / pi`
   - Normalize to 0-360: `(rawHeading + 360) % 360`
   - Handle wraparound (359->1): delta adjustment
   - Apply dead zone check
   - Apply smoothing filter

2. **Pitch Calculation:**
   - Raw: `atan2(-event.z, event.y) * 180 / pi`
   - Apply dead zone check
   - Apply smoothing filter

3. **Smoothing Formula:**
   ```
   smoothed = smoothed + (delta * smoothingFactor)
   ```

4. **Dead Zone Logic:**
   ```
   if (delta.abs() < deadZone) return; // Skip update
   ```

---

## Integration Plan

### ARViewScreen Changes

The current `ARViewScreen` is a `StatelessWidget`. It needs to become a `StatefulWidget` to:
1. Hold a `CompassService` instance
2. Call `start()` in `initState()`
3. Call `dispose()` in `dispose()`
4. Subscribe to compass stream for UI updates
5. Display debug overlay with heading/pitch values

### Debug Overlay (Temporary)

A simple overlay showing:
```
Heading: 127.3 degrees
Pitch: 12.5 degrees
```

Position: Top-left corner with semi-transparent background.

This overlay is for verification purposes and will be refined in the polish phase.

---

## Testing Strategy

### Unit Tests (test/services/compass_service_test.dart)

| Test Case | Description |
|-----------|-------------|
| `test_initial_values` | Heading and pitch start at 0 |
| `test_heading_calculation` | Verify atan2 calculation produces correct angles |
| `test_heading_wraparound_positive` | 359 -> 1 degree transition is smooth |
| `test_heading_wraparound_negative` | 1 -> 359 degree transition is smooth |
| `test_heading_dead_zone` | Small changes (<1.0) are ignored |
| `test_pitch_dead_zone` | Small changes (<2.0) are ignored |
| `test_smoothing_factor` | Changes are dampened by 0.1 factor |
| `test_stream_emits_updates` | Stream emits CompassData on sensor events |
| `test_dispose_cancels_subscriptions` | Subscriptions are properly cancelled |

**Note:** Sensor streams cannot be tested with real hardware in CI. Tests will use mock streams or verify algorithm logic with simulated data.

### Integration Tests (Manual - Real Device)

| Test | Expected Result |
|------|-----------------|
| Rotate phone 360 degrees | Heading smoothly cycles 0 -> 360 |
| Hold phone steady | Heading/pitch values stable (no jitter) |
| Tilt phone up | Pitch increases |
| Tilt phone down | Pitch decreases |
| Console logs | "Heading: X.X, Pitch: Y.Y" appears |

---

## Implementation Notes

### Decisions Made

1. **Stream-based updates:** CompassService exposes a `Stream<CompassData>` for reactive updates, enabling future integration with state management.

2. **Separate model class:** `CompassData` is a separate file to follow project conventions and enable reuse.

3. **Debug overlay in ARViewScreen:** Temporary display for verification. Will be moved to a proper debug panel in the polish phase.

4. **No dependency injection yet:** CompassService is directly instantiated in ARViewScreen. Can be refactored to use Provider pattern later.

### Patterns Used

- **Low-pass filter:** Exponential smoothing with factor 0.1
- **Dead zone:** Threshold-based change detection
- **Angle wraparound:** Delta-based calculation to handle 360->0 transition

### Trade-offs

| Decision | Trade-off |
|----------|-----------|
| Smoothing factor 0.1 | Smooth but laggy (acceptable for AR) |
| Dead zone values | May feel sluggish initially but prevents jitter |
| Direct instantiation | Simple but less testable (mocking harder) |

---

## Non-Goals

The following are explicitly NOT part of this feature:

- **Calibration UI:** No compass calibration prompts (future polish)
- **Sensor availability checking:** Basic error handling only
- **Absolute accuracy:** Relative heading is sufficient
- **GPS-based heading:** Only magnetometer is used
- **State management integration:** Direct service usage, no Provider/Riverpod yet

---

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Magnetometer unavailable | Service fails silently | Add availability check, log warning |
| Magnetic interference | Incorrect heading | Document limitation, recommend calibration |
| Performance overhead | UI lag | Sensor streams are lightweight, minimal risk |
| Testing limitations | Cannot verify on CI | Document manual device testing requirements |

---

## Dependencies

**Depends On:**
- `project-setup` (sensors_plus dependency already in pubspec.yaml)
- `camera-feed` (ARViewScreen exists)

**Required By:**
- `sky-detection` (uses pitch for pitch-based detection)
- `wind-animation` (uses heading for particle direction)

---

## Success Criteria

- [ ] CompassService implemented with smoothing and dead zones
- [ ] Heading updates smoothly as phone rotates
- [ ] Pitch updates smoothly as phone tilts
- [ ] Debug overlay shows current values
- [ ] Console logs: "Heading: X.X, Pitch: Y.Y"
- [ ] No jitter when phone is stationary
- [ ] Unit tests pass
- [ ] `flutter analyze` passes with no errors
- [ ] Manual device testing confirms functionality
