# Plan: sky-detection-regression (BUG-006)

## Metadata
- **Feature:** sky-detection-regression
- **Created:** 2026-02-02T23:15
- **Status:** plan-complete
- **Based On:** `.claude/active-work/sky-detection-regression/diagnosis.md`
- **Planner:** plan-agent

---

## Executive Summary

The sky detection calibration assumes the top of the camera frame is sky, which fails when the user is under an overhang (porch, awning, tree canopy). The system samples colors from the top 5-50% of the frame during calibration, learning wrong colors when obstructions are present.

**Root Cause:** Calibration sampling region assumption (top = sky) is incorrect in real-world scenarios.

**Fix Approach:**
1. **Multi-Region Sampling** - Sample from multiple regions, not just the top
2. **Sky Color Heuristics** - Add validation that sampled colors are sky-like (blue/gray, high brightness, uniform)
3. **Manual Recalibration Button** - Allow user to force recalibration when pointing at actual sky

**Expected Outcome:**
- Sky detection correctly identifies actual sky vs. overhangs
- User can manually recalibrate if automatic detection fails
- No regression in normal (unobstructed) sky conditions

---

## Architecture Overview

### Current Calibration Flow (PROBLEMATIC)

```
+------------------+       +---------------------+       +------------------+
|  Camera Frame    |------>| Sample Top 5-50%    |------>| Build Histogram  |
|  (any content)   |       | (pitch-dependent)   |       | from samples     |
+------------------+       +---------------------+       +------------------+
                                    |
                                    v
                           [ASSUMPTION: Top = Sky]
                                    |
                                    X  FAILS when porch/overhang at top
```

### New Calibration Flow (PROPOSED)

```
+------------------+       +---------------------+       +------------------+
|  Camera Frame    |------>| Sample from         |------>| Validate samples |
|                  |       | multiple regions    |       | are sky-like     |
+------------------+       +---------------------+       +------------------+
                                    |                            |
                           +--------+---------+                  v
                           |        |         |           +----------------+
                           v        v         v           | Sky Heuristics |
                        [TOP]   [CENTER]  [EDGES]         | - Blue/Gray    |
                                    |                     | - High V       |
                                    v                     | - Uniform      |
                           +----------------+             +----------------+
                           | Cluster colors |                    |
                           | Find dominant  |<-------------------+
                           | sky-like group |      (filter non-sky)
                           +----------------+
                                    |
                                    v
                           +----------------+
                           | Build Histogram|
                           | from sky-like  |
                           | samples only   |
                           +----------------+

+------------------+
| User Tap         |------> Force Recalibration
| "Recalibrate"    |        (same flow, immediate)
+------------------+
```

### Detection Flow (UPDATED)

The mask generation stays largely the same, but with one key change:

```
Current:
  positionWeight = 1.0 for top 20%  <-- PROBLEMATIC

Updated:
  positionWeight = adaptive based on calibration confidence
  OR reduced top bias (0.8 instead of 1.0)
```

---

## Tech Stack

- **Framework:** Flutter 3.x with Dart
- **Key Files:**
  - `lib/services/sky_detection/auto_calibrating_sky_detector.dart` (511 lines)
  - `lib/screens/ar_view_screen.dart` (316 lines)
  - `lib/services/sky_detection/hsv_histogram.dart` (181 lines)
- **Performance Target:** processFrame() < 16ms

---

## File Structure

### Files to Modify

| File | Lines | Changes | Risk |
|------|-------|---------|------|
| `auto_calibrating_sky_detector.dart` | 241-350 | Multi-region sampling, sky validation | MEDIUM |
| `auto_calibrating_sky_detector.dart` | 420-427 | Reduce position weight bias | LOW |
| `auto_calibrating_sky_detector.dart` | new | Add `forceRecalibrate()` method | LOW |
| `ar_view_screen.dart` | 268-300 | Add recalibrate button to debug panel | LOW |
| `hsv_histogram.dart` | new | Add `isSkyLike()` static method | LOW |

### Files to Create

None - all changes are modifications to existing files.

### Files to Add Tests To

| Test File | Purpose |
|-----------|---------|
| `auto_calibrating_sky_detector_test.dart` | Multi-region sampling, sky validation, forced recalibration |
| `hsv_histogram_test.dart` | Sky-like color detection |

---

## Component Specifications

### 1. Multi-Region Sampling Strategy

Instead of only sampling the top of the frame, sample from multiple regions:

```dart
/// Sampling regions (as fractions of frame dimensions)
enum SamplingRegion {
  topCenter,     // (0.25-0.75, 0.05-0.15) - Original top region
  middleCenter,  // (0.25-0.75, 0.35-0.50) - Center of frame
  topLeft,       // (0.05-0.25, 0.05-0.25) - Top-left corner
  topRight,      // (0.75-0.95, 0.05-0.25) - Top-right corner
}
```

Each region contributes samples. Non-sky samples are filtered out before building the histogram.

### 2. Sky Color Heuristics

A pixel is considered "sky-like" if it meets these criteria:

```dart
/// Returns true if HSV values are consistent with sky colors.
///
/// Sky characteristics:
/// - Hue: 180-250 (blue range) OR achromatic (saturation < 0.15)
/// - Saturation: 0.0-0.6 (sky is never super saturated)
/// - Value: 0.4-1.0 (sky is usually bright, but overcast can be mid-gray)
static bool isSkyLikeColor(HSV hsv) {
  // Very low saturation = gray (overcast sky, clouds)
  if (hsv.s < 0.15) {
    return hsv.v >= 0.35; // Gray but not too dark
  }

  // Blue sky range
  final isBlueHue = hsv.h >= 180 && hsv.h <= 250;
  final isReasonableSaturation = hsv.s >= 0.1 && hsv.s <= 0.7;
  final isBright = hsv.v >= 0.35;

  return isBlueHue && isReasonableSaturation && isBright;
}
```

This filters out:
- Brown/tan (porch ceiling) - Hue outside blue range
- Dark colors (shadows) - Value too low
- Highly saturated colors (painted surfaces) - Saturation too high
- Green/red/orange - Hue outside acceptable range

### 3. Reduced Position Weight Bias

Current position weight gives maximum weight (1.0) to top 20% of frame:

```dart
// Current (PROBLEMATIC):
if (normalizedY < 0.2) return 1.0;  // Top 20% = max weight
```

Updated to reduce the automatic assumption:

```dart
// Updated (MORE BALANCED):
if (normalizedY < 0.2) return 0.85;  // Reduce from 1.0
if (normalizedY > 0.85) return 0.0;  // Bottom 15% = zero
return 0.85 - (normalizedY - 0.2) / 0.65 * 0.65;  // Linear ramp down
```

This makes color matching more important than position for sky classification.

### 4. Forced Recalibration Method

```dart
/// Forces immediate recalibration from the next camera frame.
///
/// Call this when the user requests manual recalibration.
/// The next frame with sufficient pitch will trigger calibration.
void forceRecalibrate() {
  _lastCalibration = null;  // Reset timer
  _skyHistogram = null;     // Clear existing profile
}
```

### 5. UI Recalibration Button

Add a "Recal" button to the debug panel area (visible when debug panel is shown):

```dart
/// Recalibrate button in debug panel
GestureDetector(
  onTap: () {
    HapticFeedback.mediumImpact();
    _skyDetector.forceRecalibrate();
  },
  child: Container(
    padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
    decoration: BoxDecoration(
      color: Colors.blue.withOpacity(0.7),
      borderRadius: BorderRadius.circular(8),
    ),
    child: Text('Recal Sky', style: ...),
  ),
)
```

---

## Data Flow Changes

### Calibration with Multi-Region Sampling

```
1. Frame arrives, pitch >= 25 degrees, calibration needed
2. Sample pixels from 4 regions:
   - Top center (original behavior)
   - Middle center (new)
   - Top left corner (new)
   - Top right corner (new)
3. For each sample, check if sky-like using heuristics
4. Collect only sky-like samples
5. If >= 10 sky-like samples:
   - Build HSVHistogram from filtered samples
   - Mark calibration complete
6. If < 10 sky-like samples:
   - Log warning
   - Keep existing calibration (if any)
   - Or use fallback (pitch-based mask)
```

### Manual Recalibration

```
1. User taps "Recal Sky" button
2. forceRecalibrate() called
3. _lastCalibration = null, _skyHistogram = null
4. Next frame processes with needsCalibration = true
5. User should point at sky for best results
```

---

## Testing Strategy

### Unit Tests (New)

| Test | Purpose |
|------|---------|
| `isSkyLikeColor returns true for blue sky` | Validates blue sky detection |
| `isSkyLikeColor returns true for gray overcast` | Validates overcast detection |
| `isSkyLikeColor returns false for brown/tan` | Validates porch filtering |
| `isSkyLikeColor returns false for green foliage` | Validates tree filtering |
| `multi-region sampling covers expected areas` | Validates sampling geometry |
| `forceRecalibrate clears calibration state` | Validates manual recal |
| `calibration filters non-sky samples` | Validates filtering logic |

### Integration Tests (Existing - Must Pass)

All 254 existing tests must continue to pass.

### Manual Device Tests

| Test | Method | Success Criteria |
|------|--------|------------------|
| Under porch/overhang | Point at sky through porch | Particles in sky only, not on ceiling |
| Normal outdoor | Point at open sky | Particles fill sky region |
| Overcast conditions | Point at gray sky | Calibrates correctly |
| Manual recalibration | Tap "Recal Sky", point at sky | Calibration resets and succeeds |

---

## Implementation Notes

### Decision: Multi-Region vs. Single Region with Better Heuristics

**Option A: Multi-region sampling**
- Pros: More robust, finds sky even if top is blocked
- Cons: More complex, potentially slower

**Option B: Single region with sky heuristics**
- Pros: Simpler, faster
- Cons: May still fail if entire top region is blocked

**Decision:** Combine both approaches:
1. Sample from multiple regions (covers more scenarios)
2. Apply sky heuristics to filter samples (removes non-sky colors)
3. This dual approach handles most real-world cases

### Decision: Position Weight Adjustment

**Option A: Remove position weight entirely**
- Pros: Pure color-based detection
- Cons: May misclassify non-sky regions with similar colors

**Option B: Reduce but keep position weight**
- Pros: Balanced approach, still uses spatial prior
- Cons: May still bias toward top

**Decision:** Option B - reduce top weight from 1.0 to 0.85 and extend the ramp to 85% of frame. This balances color matching with reasonable spatial assumptions.

### Performance Considerations

- Multi-region sampling adds minimal overhead (same total sample count, just distributed)
- Sky heuristic check is O(1) per sample
- Overall calibration remains < 16ms
- Mask generation unchanged (no performance impact)

---

## Non-Goals

These are explicitly NOT part of this fix:

1. **ML-based sky segmentation** - Too complex, not needed for this fix
2. **Real-time adaptive calibration** - Would require significant refactor
3. **Multiple sky profiles** - Only one profile needed
4. **Cloud detection** - Not necessary for masking particles
5. **Building/tree edge detection** - Using color heuristics instead

---

## Risk Mitigation

### Risk 1: Over-filtering Valid Sky Samples
- **Mitigation:** Tune heuristics to be permissive for sky colors
- **Fallback:** If too few samples pass, use pitch-based fallback

### Risk 2: Performance Regression
- **Mitigation:** Multi-region sampling uses same total sample count
- **Verification:** Profile processFrame() after changes

### Risk 3: Breaking Existing Behavior
- **Mitigation:** All 254 tests must pass
- **Verification:** Test on device in normal conditions

### Risk 4: UI Button Doesn't Fit
- **Mitigation:** Button only visible in debug panel (not production UI)
- **Fallback:** Can trigger via 3-finger tap gesture instead

---

## Verification Checkpoints

### After Phase 1 (Sky Heuristics)
- [ ] isSkyLikeColor correctly identifies sky vs. non-sky
- [ ] All unit tests pass

### After Phase 2 (Multi-Region Sampling)
- [ ] Sampling covers 4 regions
- [ ] Non-sky samples filtered
- [ ] Calibration works under overhang

### After Phase 3 (Position Weight)
- [ ] Position weight reduced for top
- [ ] Color matching more influential
- [ ] No regression in normal conditions

### After Phase 4 (Manual Recalibration)
- [ ] forceRecalibrate() clears state
- [ ] Button visible in debug panel
- [ ] Recalibration triggers correctly

### After Phase 5 (Device Testing)
- [ ] Under-porch scenario works
- [ ] Normal outdoor scenario works
- [ ] All 254+ tests pass
- [ ] processFrame() < 16ms

---

## Success Criteria

1. **Particles appear ONLY in actual sky regions** when under overhang
2. **Manual recalibration button works** in debug panel
3. **All 254+ tests pass**
4. **No regression** in normal outdoor conditions
5. **processFrame() < 16ms** performance maintained

---

## Next Step

**Ready for implementation.**

Run `/implement sky-detection-regression` to begin Phase 1 (Sky Color Heuristics).
