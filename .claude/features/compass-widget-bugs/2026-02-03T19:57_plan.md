# Implementation Plan: Compass Widget Bugs (BUG-008)

## Metadata

| Field | Value |
|-------|-------|
| Feature | compass-widget-bugs |
| Type | Bug Fix |
| Timestamp | 2026-02-03T19:57 |
| Status | plan-complete |
| Based On | diagnosis.md |
| Diagnosis | `.claude/active-work/compass-widget-bugs/diagnosis.md` |

---

## Bug Summary

Two bugs were reported with the compass widget:

1. **Position Bug (Confirmed):** Compass widget overlaps InfoBar at bottom of screen
2. **Static Compass Bug (Needs Verification):** User reports compass doesn't rotate, but code analysis shows rotation IS applied correctly

---

## Architecture Overview

### Current Component Hierarchy

```
ARViewScreen (StatefulWidget)
└── Stack
    ├── Layer 1: CameraView
    ├── Layer 2: ParticleOverlay
    ├── Layer 3: Debug toggle button
    ├── Layer 4: Debug panel (conditional)
    ├── Layer 5: AltitudeSlider
    ├── Layer 6: InfoBar ← Positioned at bottom: bottomPadding + 16
    └── Layer 7: CompassWidget ← Positioned at bottom: bottomPadding + 76 (OVERLAP)
```

### Data Flow (Compass Heading)

```
CompassService
    │
    ├── magnetometerEventStream() → _onMagnetometerEvent()
    │                                    │
    │                                    ▼
    │                              _smoothedHeading
    │                                    │
    │                                    ▼
    │                              _emitUpdate()
    │                                    │
    ▼                                    ▼
stream ─────────────────────────────► _compassSubscription
                                           │
                                           ▼
                                    _onCompassUpdate(data)
                                           │
                                           ▼
                                    setState(() {
                                      _heading = data.heading;
                                    })
                                           │
                                           ▼
                                    CompassWidget(heading: _heading)
                                           │
                                           ▼
                                    CompassPainter(heading: heading)
                                           │
                                           ▼
                                    canvas.rotate(-heading * pi / 180)
```

---

## Bug 1: Position Overlap (Confirmed)

### Root Cause Analysis

**Current positioning in `ar_view_screen.dart`:**

```dart
// Layer 6: InfoBar positioned at:
bottom: bottomPadding + 16  // InfoBar bottom edge

// Layer 7: CompassWidget positioned at:
bottom: bottomPadding + 76  // Compass bottom edge
```

**Problem:** The calculation assumes:
- InfoBar height: ~60px (36px divider + 24px vertical padding)
- Compass bottom at 76px = InfoBar bottom (16px) + InfoBar height (60px)
- This places compass BOTTOM exactly at InfoBar TOP = no gap, possible overlap

**InfoBar actual dimensions:**
- Vertical padding: 12px top + 12px bottom = 24px
- Content height: 36px (divider) + additional content
- Estimated total: 60-65px

**CompassWidget dimensions:**
- Diameter: 68px (constant `_diameter`)

### Fix

Change compass position from `bottomPadding + 76` to `bottomPadding + 92` to add a 16px gap above InfoBar.

**Calculation:**
- InfoBar positioned at: `bottomPadding + 16`
- InfoBar height: ~60px
- InfoBar top edge: `bottomPadding + 16 + 60 = bottomPadding + 76`
- Desired gap: 16px
- Compass bottom: `bottomPadding + 76 + 16 = bottomPadding + 92`

---

## Bug 2: Static Compass (Investigation Required)

### Code Analysis Summary

The compass rotation code is **correctly implemented**:

**CompassWidget (`compass_widget.dart:59-61`):**
```dart
child: CustomPaint(
  painter: CompassPainter(heading: heading),
  size: Size(_diameter, _diameter),
),
```

**CompassPainter rotation (`compass_widget.dart:123, 149`):**
```dart
canvas.rotate(-heading * pi / 180);  // Applied to tick marks and labels
```

**shouldRepaint (`compass_widget.dart:221-223`):**
```dart
bool shouldRepaint(CompassPainter oldDelegate) {
  return oldDelegate.heading != heading;
}
```

**ARViewScreen heading updates (`ar_view_screen.dart:113-127`):**
```dart
void _onCompassUpdate(CompassData data) {
  setState(() {
    _heading = data.heading;  // Updates state
    // ... other updates
  });
}
```

**Stream subscription (`ar_view_screen.dart:99`):**
```dart
_compassSubscription = _compassService.stream.listen(_onCompassUpdate);
```

### Screenshot Analysis

In the diagnosis screenshot (heading: 137.9 degrees, facing SE):
- N is in lower-left quadrant (correct for heading 137.9)
- E is near top (correct)
- S is at right (correct)
- W is at bottom (correct)

**The screenshot shows the compass IS correctly rotated for the displayed heading.**

### Possible Explanations

1. **Compass is working correctly** - The screenshot proves rotation is applied
2. **"Static" may mean slow updates** - Compass service uses smoothing (factor 0.1) and dead zones (1.0 degrees)
3. **User expected different behavior** - May have expected faster/more responsive rotation

### Investigation Approach

Before implementing any fix, verify the actual behavior:
1. Add optional debug logging to confirm heading updates are flowing
2. Test on device to observe real-time behavior
3. If truly static, investigate CompassService stream emissions

---

## Tech Stack

- **Framework:** Flutter 3.x
- **Files to Modify:** 1 (ar_view_screen.dart)
- **Files to Create:** 0
- **Tests to Update:** 0 (existing tests don't verify position)
- **New Tests:** 1 integration test for position verification (optional)

---

## File Changes

### Modified Files

| File | Change | Lines |
|------|--------|-------|
| `lib/screens/ar_view_screen.dart` | Change compass bottom offset from 76 to 92 | Line 260 |

### No New Files Required

The fix is a single-line position adjustment. No new components or services needed.

---

## Testing Strategy

### Existing Tests (Must Pass)

All 375 existing tests must continue to pass:
- Compass widget tests: 17 tests in `compass_widget_test.dart`
- AR View screen tests: related tests must pass

### Manual Testing Required

**Position Bug Verification:**
1. Deploy to device
2. Verify compass has visible gap above InfoBar
3. Test in portrait orientation
4. Compare before/after screenshots

**Static Compass Verification:**
1. Open app on device
2. Face North - verify N is at top
3. Slowly rotate device 360 degrees
4. Verify compass dial rotates smoothly
5. Check debug panel shows heading changes

---

## Implementation Notes

### Design Decisions

1. **Fixed offset vs calculated:** Using fixed offset (92px) rather than complex calculation because:
   - InfoBar height is relatively stable
   - Simple fix is less error-prone
   - Can adjust later if InfoBar design changes

2. **Not adding dynamic gap calculation:** Would require:
   - Getting InfoBar height at runtime
   - Using Layout callbacks
   - Unnecessary complexity for this fix

3. **Not fixing "static compass" yet:** Code analysis shows it's working correctly. Need device verification first.

### Trade-offs

| Decision | Pros | Cons |
|----------|------|------|
| Fixed 92px offset | Simple, clear, predictable | May need adjustment if InfoBar changes |
| No widget tests for position | Faster implementation | Position not automatically verified |
| Defer Bug 2 investigation | Don't fix what isn't broken | User may still report issue |

---

## Non-Goals

- **Not** changing InfoBar position or height
- **Not** changing compass widget size
- **Not** adding dynamic position calculation
- **Not** adding new compass animations
- **Not** changing compass service smoothing parameters (unless Bug 2 confirmed)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Tests fail after change | Low | Medium | Run full test suite |
| Position still wrong | Low | Low | Adjust offset value |
| Bug 2 is real | Medium | Medium | Add debug logging to verify |

---

## Dependencies

None. This is a self-contained bug fix with no external dependencies.

---

## Success Criteria

1. Compass widget has visible gap (16px) above InfoBar
2. All 375 existing tests pass
3. Compass rotation verified working on device
4. No visual regressions in AR view
5. `flutter analyze lib/` shows no issues

---

## Handoff to Implementation

After `/plan` completes:
1. Implement the position fix (single line change)
2. Run full test suite to verify no regressions
3. Test on device to verify visual fix
4. If Bug 2 confirmed during device testing, add investigation tasks

**Next Command:** `/implement compass-widget-bugs`
