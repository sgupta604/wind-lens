# Implementation Plan: Streamline Ghosting Bug Fix (BUG-007)

## Metadata

- **Feature:** streamline-ghosting (BUG-007)
- **Created:** 2026-02-03T00:30
- **Status:** plan-complete
- **Based On:** `/workspace/.claude/active-work/streamline-ghosting/diagnosis.md`
- **Priority:** Critical - blocks streamlines mode usability

---

## Overview

### Problem Statement

In streamlines mode, particle trails persist incorrectly when particles are recycled or wrap around screen edges, creating severe visual artifacts ("ghosting"). The bug makes streamlines mode completely unusable.

### Root Cause Summary

1. **Primary:** `_resetToSkyPosition()` repositions particles without calling `resetTrail()`, causing old trail points to remain in the buffer
2. **Secondary:** Screen edge wrapping (x/y coordinate wrap) does not reset trails, causing cross-screen lines when particles wrap from one edge to another

### Fix Strategy

Simple, targeted fix: Add `resetTrail()` calls in the two locations where particle position is discontinuously changed:
1. After repositioning in `_resetToSkyPosition()`
2. After screen edge wrapping (in streamlines mode only)

---

## Architecture

### Current Flow (Buggy)

```
Particle at (0.8, 0.3) with trail buffer containing points near (0.8, 0.3)
                |
                v
Particle expires OR drifts out of sky
                |
                v
_resetToSkyPosition() called
                |
                v
Particle teleported to (0.2, 0.7)
Trail buffer still contains old points near (0.8, 0.3)  <-- BUG!
                |
                v
Renderer draws line from (0.2, 0.7) to (0.8, 0.3)  <-- GHOST LINE!
```

### Fixed Flow

```
Particle at (0.8, 0.3) with trail buffer containing points near (0.8, 0.3)
                |
                v
Particle expires OR drifts out of sky
                |
                v
_resetToSkyPosition() called
                |
                v
Particle teleported to (0.2, 0.7)
resetTrail() called - buffer cleared  <-- FIX
                |
                v
Renderer has no old trail points - no ghost line
```

### Edge Wrapping Flow (Fixed)

```
Particle at (1.05, 0.5) moves past right edge
                |
                v
Edge wrap: p.x = 0.05 (wraps to left side)
Trail buffer still contains points near x=1.0  <-- BUG in streamlines mode
                |
                v
[FIX] If streamlines mode, call resetTrail()
                |
                v
No cross-screen ghost line
```

---

## Tech Stack

- **Language:** Dart
- **Framework:** Flutter
- **Files Affected:** 2 files (1 source, 1 test)
- **Test Framework:** flutter_test

---

## File Structure

### Files to Modify

| File | Purpose | Changes |
|------|---------|---------|
| `/workspace/wind_lens/lib/widgets/particle_overlay.dart` | Particle lifecycle management | Add `resetTrail()` calls in 2 locations |
| `/workspace/wind_lens/test/widgets/particle_overlay_test.dart` | Unit tests | Add tests for trail reset behavior |

### New Files

None required - this is a targeted bug fix.

---

## Code Changes

### Change 1: `_resetToSkyPosition()` (Lines 199-223)

Add `p.resetTrail()` after setting position in all three code paths:

```dart
// Path 1: High sky fraction (line 206)
p.age = 0.0;
p.resetTrail();  // ADD THIS
return;

// Path 2: Found sky position in loop (line 215)
p.age = 0.0;
p.resetTrail();  // ADD THIS
return;

// Path 3: Fallback (line 222)
p.age = 0.0;
p.resetTrail();  // ADD THIS
```

### Change 2: Screen Edge Wrapping (Lines 324-328)

Add trail reset after wrap detection, only in streamlines mode:

```dart
// Before:
if (p.x < 0) p.x += 1.0;
if (p.x > 1) p.x -= 1.0;
if (p.y < 0) p.y += 1.0;
if (p.y > 1) p.y -= 1.0;

// After:
bool wrapped = false;
if (p.x < 0) { p.x += 1.0; wrapped = true; }
if (p.x > 1) { p.x -= 1.0; wrapped = true; }
if (p.y < 0) { p.y += 1.0; wrapped = true; }
if (p.y > 1) { p.y -= 1.0; wrapped = true; }
if (wrapped && isStreamlines) {
  p.resetTrail();
}
```

---

## Testing Strategy

### Unit Tests to Add (4 new tests)

1. **Trail reset on particle respawn via `_resetToSkyPosition()`**
   - Verify that after a particle is reset (expired/out-of-sky), `trailCount == 0`

2. **Trail reset on screen edge wrap in streamlines mode**
   - Verify that when a particle wraps x/y in streamlines mode, trail is cleared

3. **Trail NOT reset on screen edge wrap in dots mode**
   - Verify that dots mode behavior is unchanged (edge wrap does not reset trail)

4. **No ghost segments after particle recycle**
   - Integration test: run animation, force particle recycle, verify no long segments

### Existing Tests (Must Pass)

- All 354 existing tests must continue to pass
- Particularly relevant: `ParticleOverlay ViewMode Integration` tests
- Relevant: `reset() calls resetTrail()` in particle_test.dart

### Manual Testing Checklist

- [ ] Run app in streamlines mode for 5+ minutes
- [ ] Move phone rapidly to cause particle recycling
- [ ] Verify no ghost trails at screen edges
- [ ] Verify particles spawn cleanly without old trail artifacts
- [ ] Verify dots mode still works correctly
- [ ] Verify FPS remains 45+ with fix applied

---

## Implementation Notes

### Decisions Made

1. **Reset trail in `_resetToSkyPosition()` rather than extracting a helper method**
   - Simpler change, less risk of breaking existing behavior
   - The `Particle.reset()` method already calls `resetTrail()`, so this aligns with existing pattern

2. **Only reset trail on edge wrap in streamlines mode**
   - Dots mode does not use trail buffer for rendering
   - Resetting trail in dots mode is harmless but unnecessary
   - The check `if (wrapped && isStreamlines)` makes intent clear

3. **Did NOT implement optional "max segment length" renderer check**
   - With fixes 1 and 2, this should never be needed
   - Adding it would add complexity and performance overhead
   - Can be added later if edge cases appear

### Patterns Used

- Following existing pattern: `Particle.reset()` calls `resetTrail()` after repositioning
- Mode-specific behavior: checking `isStreamlines` before trail operations

### Trade-offs

- **Pro:** Simple, targeted fix with minimal code changes
- **Pro:** Clear, easy to understand changes
- **Pro:** No performance impact (resetTrail() is O(1) - just sets two ints to 0)
- **Con:** Does not add defensive max-segment-length check in renderer
- **Decision:** Acceptable trade-off - fix root cause rather than mask symptoms

---

## Non-Goals

The following are explicitly NOT addressed by this fix:

1. **ML-based sky detection** - Out of scope (deferred feature)
2. **Renderer segment length validation** - Unnecessary if root cause fixed
3. **Trail buffer redesign** - Current circular buffer design is correct
4. **Performance optimization** - No performance issues identified

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Fix breaks dots mode | Low | Medium | Test dots mode explicitly |
| Performance regression | Very Low | Medium | `resetTrail()` is O(1) |
| Incomplete fix | Low | High | Add tests for both code paths |
| New edge cases | Low | Medium | Test wrapping at all edges |

---

## Dependencies

### Required Before Implementation

- Diagnosis complete (DONE)
- Plan complete (THIS DOCUMENT)

### Blocks

- No other features blocked by this fix
- After fix: can continue with Phase 2 features (compass-widget recommended next)

---

## Success Criteria

1. No ghost trails visible after 5+ minutes of streamlines mode use
2. Particles spawn cleanly without cross-screen lines
3. All 354 existing tests pass
4. New tests (4) pass
5. Dots mode unchanged (verified by existing tests)
6. FPS remains 45+ on device

---

## References

- Diagnosis: `/workspace/.claude/active-work/streamline-ghosting/diagnosis.md`
- Particle model: `/workspace/wind_lens/lib/models/particle.dart`
- Particle overlay: `/workspace/wind_lens/lib/widgets/particle_overlay.dart`
- Related feature: wind-streamlines (P2A-002), commit 02f345a
