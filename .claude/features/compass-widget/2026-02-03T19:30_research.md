# Research: compass-widget

## Metadata
- **Feature:** compass-widget
- **Created:** 2026-02-03T19:30
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

**From ROADMAP_PHASE2.md:**
- Order: #3 (Phase 2a - Foundation & Visuals)
- Depends on: None (no blockers)
- Priority: Medium
- Complexity: Low
- Recommended next after wind-streamlines completion

**Current Pipeline State (from STATUS.md):**
- Previous feature: streamline-ghosting (BUG-007) - FINALIZED
- Ready for: compass-widget research

## Requirements from Spec

### Source Sections
- ROADMAP_PHASE2.md -> Feature 3: compass-widget

### Functional Requirements
- [ ] FR1: Small circular compass displayed in corner of screen
- [ ] FR2: Shows N/S/E/W cardinal directions
- [ ] FR3: Rotates based on device heading (from CompassService)
- [ ] FR4: Indicator showing which way camera is pointing
- [ ] FR5: Does not obscure other UI elements (altitude slider, debug panel)

### Technical Requirements
- [ ] TR1: Use existing CompassService heading data (already smoothed and filtered)
- [ ] TR2: CustomPainter implementation for compass dial rendering
- [ ] TR3: Semi-transparent background using glassmorphism (consistent with AltitudeSlider and InfoBar)
- [ ] TR4: Position in corner that doesn't interfere with existing UI

### UI Layout Analysis

Current screen layout (from ar_view_screen.dart):
```
+----------------------------------------+
| [DBG]                                  |  <- Debug toggle (top-left, 8px from edge)
| [Debug Panel]                          |  <- Positioned 56px from top when visible
|                                        |
|                                        |
|                              [JET]     |  <- Altitude slider (right side, centered)
|                              [MID]     |
|                              [SFC]     |
|                                        |
|                                        |
| [InfoBar: Wind/Altitude]         [___] |  <- InfoBar (bottom-left, 16px margin)
+----------------------------------------+
```

**Recommended Position:** Bottom-left corner, ABOVE the InfoBar
- Altitude slider is on the right side (16px from right edge)
- Debug panel is top-left (8px from left edge)
- InfoBar is at bottom-left (16px margin, leaves 80px space for slider)

**Alternative Position:** Top-right corner (above altitude slider)
- Would need to account for notch/status bar safe area
- Less natural viewing position

### Constraints

**Position Constraints:**
- Must not overlap debug toggle button (top-left, 8px from edges)
- Must not overlap debug panel when visible (top-left, starts at 56px from top)
- Must not overlap altitude slider (right side, vertically centered)
- Must not overlap InfoBar (bottom-left to bottom-right minus 80px)

**Size Constraints:**
- Suggested size: 60-80px diameter (similar to altitude slider width of 60px)
- Must maintain minimum 44pt touch target per iOS HIG (not interactive, so less critical)

**Styling Constraints:**
- Must use glassmorphism consistent with existing UI:
  - Background: `Colors.white.withValues(alpha: 0.15)`
  - Border: `Colors.white.withValues(alpha: 0.3)`, 1px width
  - Blur: `ImageFilter.blur(sigmaX: 10, sigmaY: 10)`
  - Border radius: 12px (existing pattern) or circular for compass

## Existing Code Analysis

### Project State
- Flutter project exists: YES (at `/workspace/wind_lens/`)
- All 358 tests passing
- Relevant existing files identified below

### Code to Reuse

**CompassService (`/workspace/wind_lens/lib/services/compass_service.dart`):**
- Provides smoothed heading (0-360 degrees from north)
- Already used by ARViewScreen
- Has dead zone filtering to prevent jitter
- Stream-based updates via `stream` property
- `heading` getter for current value

**CompassData (`/workspace/wind_lens/lib/models/compass_data.dart`):**
- Simple data class with `heading` and `pitch` properties
- Heading is in degrees (0-360)

**ARViewScreen already has:**
- `_heading` state variable (line 48): Current compass heading
- `_compassService` (line 39): Already initialized and running
- `_compassSubscription` (line 45): Already subscribed to updates
- `_onCompassUpdate` method (line 112): Updates `_heading` on each update

### Code to Modify

**ARViewScreen (`/workspace/wind_lens/lib/screens/ar_view_screen.dart`):**
- Add compass widget to the Stack (around line 197-258)
- Position with `Positioned` widget
- Pass `_heading` value to compass widget

### Patterns to Follow

**Widget Positioning Pattern (from ARViewScreen):**
```dart
// Layer X: Compass widget positioned in bottom-left corner
Positioned(
  left: 16,
  bottom: bottomPadding + [Y offset above InfoBar],
  child: CompassWidget(
    heading: _heading,
  ),
),
```

**Glassmorphism Pattern (from AltitudeSlider and InfoBar):**
```dart
ClipRRect(
  borderRadius: BorderRadius.circular(_borderRadius),
  child: BackdropFilter(
    filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
    child: Container(
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.15),
        borderRadius: BorderRadius.circular(_borderRadius),
        border: Border.all(
          color: Colors.white.withValues(alpha: 0.3),
          width: 1,
        ),
      ),
      // ... content
    ),
  ),
),
```

**CustomPainter Pattern (from ParticleOverlay):**
```dart
CustomPaint(
  painter: CompassPainter(
    heading: heading,
  ),
  size: Size(diameter, diameter),
)
```

### Files to Create

1. **`/workspace/wind_lens/lib/widgets/compass_widget.dart`**
   - New widget file following existing widget patterns
   - Contains CompassWidget StatelessWidget
   - Contains CompassPainter CustomPainter

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Jitter in compass rotation | Low | Low | CompassService already has smoothing (0.1 factor) and dead zone (1.0 degree) |
| Visual occlusion with other UI | Medium | Low | Careful positioning in bottom-left above InfoBar |
| Performance impact of CustomPainter | Low | Very Low | Single widget, minimal drawing operations |
| Inconsistent styling | Low | Low | Follow existing glassmorphism patterns exactly |

### Complexity
- **Level:** Low
- **Rationale:**
  - All required data (heading) is already available in ARViewScreen
  - Glassmorphism styling pattern is well-established in codebase
  - CustomPainter for simple compass dial is straightforward
  - No new services, state management, or complex calculations needed
  - Similar to existing widgets (AltitudeSlider, InfoBar)

## Open Questions

- [x] Q1: Where should the compass be positioned?
  - Resolution: Bottom-left corner, above InfoBar, left of altitude slider area
  - Rationale: Only clear open space not used by other UI elements

- [x] Q2: What size should the compass be?
  - Resolution: 64-72px diameter (similar to altitude slider width, circular shape)
  - Rationale: Consistent with existing UI element sizes, visible but not dominant

- [x] Q3: Should the compass be interactive?
  - Resolution: No - it's purely informational display
  - Rationale: Spec says "shows direction" - no interaction needed

- [x] Q4: Should it use the existing heading stream or current heading value?
  - Resolution: Use `_heading` state variable (already updated via stream subscription)
  - Rationale: Follows existing pattern, heading is already in state

- [x] Q5: What cardinal directions to show?
  - Resolution: All 4 (N, S, E, W) with N emphasized
  - Rationale: Standard compass design, spec says "N/S/E/W cardinal directions"

## Recommended Approach

### Implementation Strategy

1. **Create CompassWidget** - Single file with both widget and painter
   - StatelessWidget wrapper with glassmorphism styling
   - CustomPainter for compass dial rendering
   - Accept heading as parameter

2. **Compass Dial Design**
   - Circular dial with cardinal direction markers (N, S, E, W)
   - "N" should be emphasized (larger, bolder, or colored)
   - Direction indicator showing camera pointing direction (fixed triangle at top)
   - Dial rotates based on heading (N rotates to match compass heading)
   - Background is glassmorphism semi-transparent circle

3. **Integration**
   - Add to ARViewScreen Stack as new positioned layer
   - Position: bottom-left, above InfoBar
   - Pass `_heading` state variable

### Order of Work
1. Create `compass_widget.dart` with CompassWidget and CompassPainter
2. Implement glassmorphism container (following AltitudeSlider pattern)
3. Implement CustomPainter with:
   - Outer circle (border)
   - Cardinal direction labels (N/S/E/W) - rotated by heading
   - Direction indicator (fixed triangle pointing up)
4. Add to ARViewScreen Stack with proper positioning
5. Write unit tests for compass widget
6. Write widget tests for rendering

### What to Defer (Not MVP Critical)
- Intercardinal directions (NE, SE, SW, NW) - can add later if desired
- Tilt indicator (showing phone pitch) - separate feature
- Tap to show precise heading degrees - nice to have but not required

## Technical Specifications

### Compass Design
```
    [Direction indicator - fixed triangle]
              /\
             /  \
+-----------------------------+
|            N                |
|                             |
|     W             E         |  <- Rotate by -heading degrees
|                             |
|            S                |
+-----------------------------+
```

### Rotation Math
```dart
// Cardinal labels rotate with heading
// When heading = 0 (facing North), N is at top
// When heading = 90 (facing East), E should be at top
// So labels rotate by -heading degrees

// In CustomPainter:
canvas.save();
canvas.translate(center.dx, center.dy);
canvas.rotate(-heading * pi / 180); // Negative to counter-rotate with heading
// Draw N, S, E, W at their positions (N at top, E at right, etc.)
canvas.restore();
```

### Size and Position Constants
```dart
static const double _diameter = 68.0;  // Outer diameter
static const double _borderRadius = 34.0;  // Half diameter for circle
static const double _borderWidth = 1.0;
static const double _labelFontSize = 12.0;
static const double _northFontSize = 14.0;  // Larger for emphasis
```

## Next Step

**Research complete with all questions resolved.**

Run `/plan compass-widget` to create implementation plan.
