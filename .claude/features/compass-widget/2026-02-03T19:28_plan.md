# Implementation Plan: compass-widget

## Metadata
- **Feature:** compass-widget
- **Created:** 2026-02-03T19:28
- **Status:** plan-complete
- **Based On:** 2026-02-03T19:30_research.md

---

## Architecture Overview

### Component Hierarchy

```
ARViewScreen (existing)
└── Stack
    ├── CameraView (Layer 1)
    ├── ParticleOverlay (Layer 2)
    ├── DebugToggleButton (Layer 3)
    ├── DebugPanel (Layer 4)
    ├── AltitudeSlider (Layer 5)
    ├── InfoBar (Layer 6)
    └── CompassWidget (Layer 7 - NEW)
        └── CustomPaint
            └── CompassPainter
```

### Data Flow

```
CompassService
    │
    ▼ (stream subscription, already exists)
ARViewScreen._heading
    │
    ▼ (prop)
CompassWidget(heading: _heading)
    │
    ▼ (passed to painter)
CompassPainter(heading: heading)
    │
    ▼ (renders)
Canvas (dial rotates, indicator fixed)
```

---

## Tech Stack Summary

- **Widget Type:** StatelessWidget (compass is purely display-only)
- **Rendering:** CustomPainter for dial drawing
- **Styling:** Glassmorphism (BackdropFilter + semi-transparent)
- **Data Source:** `_heading` from ARViewScreen (already available)
- **Rotation Math:** Labels rotate by `-heading` degrees

---

## File Structure

### New Files

| File | Purpose |
|------|---------|
| `lib/widgets/compass_widget.dart` | CompassWidget and CompassPainter |
| `test/widgets/compass_widget_test.dart` | Widget and painter tests |

### Modified Files

| File | Lines | Changes |
|------|-------|---------|
| `lib/screens/ar_view_screen.dart` | ~245-254 | Add CompassWidget as Layer 7 in Stack |

---

## Component Architecture

### CompassWidget

```dart
class CompassWidget extends StatelessWidget {
  /// Current compass heading in degrees (0-360, 0 = North).
  final double heading;

  const CompassWidget({super.key, required this.heading});

  // Constants
  static const double _diameter = 68.0;
  static const double _borderRadius = 34.0; // circular
  // ...
}
```

**Responsibilities:**
- Render glassmorphism container (circular)
- Host CustomPaint with CompassPainter
- Pass heading to painter

### CompassPainter

```dart
class CompassPainter extends CustomPainter {
  final double heading;

  CompassPainter({required this.heading});

  @override
  void paint(Canvas canvas, Size size) {
    // 1. Draw outer ring
    // 2. Draw tick marks
    // 3. Rotate canvas by -heading
    // 4. Draw cardinal labels (N, S, E, W)
    // 5. Restore canvas
    // 6. Draw direction indicator (fixed at top)
  }

  @override
  bool shouldRepaint(CompassPainter oldDelegate) {
    return oldDelegate.heading != heading;
  }
}
```

**Rendering Steps:**
1. Calculate center and radius
2. Draw outer ring (circle stroke)
3. Save canvas, translate to center, rotate by `-heading * pi / 180`
4. Draw cardinal direction labels at fixed positions relative to center
5. Restore canvas
6. Draw direction indicator (triangle at top, fixed position)

---

## Visual Specifications

### Compass Design

```
        /\              <- Direction indicator (red triangle, fixed)
       /  \
   +----------+
   |    N     |         <- N label (red, rotates with dial)
   |          |
   | W    E   |         <- W, E labels (white, rotate with dial)
   |          |
   |    S     |         <- S label (white, rotates with dial)
   +----------+
```

### Dimensions

| Element | Value |
|---------|-------|
| Outer diameter | 68px |
| Border radius | 34px (circular) |
| Border width | 1px |
| Background alpha | 0.15 |
| Border alpha | 0.3 |
| Blur sigma | 10 |
| Cardinal font size | 12px |
| North font size | 14px (emphasized) |
| Indicator size | 8px triangle |

### Colors

| Element | Color |
|---------|-------|
| Background | `Colors.white.withValues(alpha: 0.15)` |
| Border | `Colors.white.withValues(alpha: 0.3)` |
| Labels (S, E, W) | `Colors.white.withValues(alpha: 0.9)` |
| North (N) label | `Colors.red` (emphasized) |
| Direction indicator | `Colors.red` |
| Tick marks | `Colors.white.withValues(alpha: 0.5)` |

### Screen Position

```
+----------------------------------------+
| [DBG]                                  |
| [Debug Panel]                          |
|                                        |
|                              [JET]     |
|                              [MID]     |
|                              [SFC]     |
|                                        |
| [Compass]                              |  <- Bottom-left, above InfoBar
| [InfoBar: Wind/Altitude]         [___] |
+----------------------------------------+
```

**Positioning:**
- `left: 16`
- `bottom: bottomPadding + 76` (16px margin + ~60px InfoBar height)

---

## Rotation Math

```dart
// In CompassPainter.paint():

// Labels rotate OPPOSITE to heading so North stays at top when facing North
// When heading = 0 (facing North), N is at top
// When heading = 90 (facing East), dial rotates -90, so E is at top

canvas.save();
canvas.translate(center.dx, center.dy);
canvas.rotate(-heading * pi / 180);  // Negative rotation

// Draw N at top (0, -radius + offset)
// Draw S at bottom (0, radius - offset)
// Draw E at right (radius - offset, 0)
// Draw W at left (-radius + offset, 0)

canvas.restore();
```

---

## Testing Strategy

### Unit Tests (8 tests)

1. **CompassWidget renders without crashing**
2. **CompassWidget passes heading to painter**
3. **CompassWidget has glassmorphism (BackdropFilter)**
4. **CompassWidget has ClipRRect for rounded corners**
5. **CompassWidget has correct size (68px)**
6. **CompassPainter shouldRepaint returns true when heading changes**
7. **CompassPainter shouldRepaint returns false when heading unchanged**
8. **CompassWidget accepts heading boundary values (0, 180, 360)**

### Widget Tests (4 tests)

1. **CompassWidget displays all cardinal directions (N, S, E, W)**
2. **CompassWidget uses CustomPaint for rendering**
3. **CompassWidget uses correct dimensions**
4. **CompassWidget handles heading edge cases (0, 359, 360)**

### Integration Tests (2 tests)

1. **CompassWidget appears in ARViewScreen**
2. **CompassWidget does not overlap with other UI elements**

---

## Implementation Notes

### Decisions

1. **Single file for widget + painter:** Following existing pattern (see particle_overlay.dart), keep CompassWidget and CompassPainter in same file.

2. **StatelessWidget:** Compass has no internal state; heading is passed from parent. No need for StatefulWidget.

3. **Direction indicator fixed:** The triangle at top stays fixed, representing "where the camera is pointing." The dial behind it rotates.

4. **N emphasized in red:** Standard compass convention, makes it easy to orient.

5. **Circular container:** Use `_borderRadius = _diameter / 2` for perfect circle.

### Patterns Used

- **Glassmorphism:** Same pattern as AltitudeSlider and InfoBar (ClipRRect + BackdropFilter + Container)
- **CustomPainter:** Same pattern as ParticleOverlay
- **Positioned widget:** Same pattern as other UI layers in ARViewScreen

### Trade-offs

- **No intercardinal directions (NE, SE, etc.):** Keeps dial clean and readable at small size. Can add later if needed.
- **No tap interaction:** Compass is purely informational. Adding tap to show exact degrees would add complexity with minimal benefit.
- **No pitch indicator:** Separate feature if needed (research noted this as a future possibility).

---

## Non-Goals

These are explicitly NOT part of this feature:

1. **Intercardinal directions (NE, SE, SW, NW)** - Can add later
2. **Tap to show exact heading degrees** - Nice-to-have, not MVP
3. **Pitch/tilt indicator** - Separate feature
4. **Animations/transitions** - Unnecessary complexity
5. **Dynamic sizing** - Fixed 68px is sufficient

---

## Handoff to Implementation

**Ready for `/implement compass-widget`**

Prerequisites verified:
- [x] CompassService exists and provides heading
- [x] ARViewScreen already has `_heading` state variable
- [x] Glassmorphism pattern documented
- [x] Screen positioning determined
- [x] Test patterns established

Implementation order:
1. Write tests first (TDD)
2. Create compass_widget.dart with CompassWidget + CompassPainter
3. Add to ARViewScreen Stack
4. Run all tests
