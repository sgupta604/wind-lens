# Implementation Plan: wind-streamlines

## Metadata
- **Feature:** wind-streamlines
- **Created:** 2026-02-02T23:55
- **Status:** plan-complete
- **Based on:** 2026-02-02T23:45_research.md
- **Planner:** plan-agent

---

## Architecture Overview

### Current vs Target State

```
CURRENT STATE (Dots)                    TARGET STATE (Streamlines)
+-------------------------+             +-------------------------+
|  Particle               |             |  Particle               |
|  - x, y (position)      |             |  - x, y (position)      |
|  - age                  |             |  - age                  |
|  - trailLength          |             |  - trailLength          |
|                         |             |  + trailX[]  (Float32)  |
|                         |             |  + trailY[]  (Float32)  |
|                         |             |  + trailHead (int)      |
|                         |             |  + speed (double)       |
+-------------------------+             +-------------------------+
           |                                       |
           v                                       v
+-------------------------+             +-------------------------+
| ParticleOverlayPainter  |             | ParticleOverlayPainter  |
| - drawLine (dot)        |             | - drawLine (dots mode)  |
| - 2-pass glow           |             | - drawPath (streamlines)|
|                         |             | - ViewMode switch       |
+-------------------------+             +-------------------------+
```

### Component Hierarchy

```
ARViewScreen
    |
    +-- ParticleOverlay
    |       |
    |       +-- ParticleOverlayPainter
    |               |
    |               +-- [ViewMode.dots] -> drawLine() (existing)
    |               |
    |               +-- [ViewMode.streamlines] -> drawPath() (new)
    |
    +-- ViewModeToggle (new - in debug panel initially)
    |
    +-- AltitudeSlider (existing)
    |
    +-- InfoBar (existing)
```

### Data Flow Diagram

```
                              +------------------+
                              |   WindData       |
                              | speed, direction |
                              +--------+---------+
                                       |
                                       v
+------------------+           +------------------+           +------------------+
|  _onTick()       |           |  getSpeedColor() |           |  AltitudeLevel   |
|  (animation)     +---------->|  (wind_colors)   |<----------+ streamlineTrail  |
|                  |           |                  |           |  Length          |
+--------+---------+           +--------+---------+           +------------------+
         |                              |
         v                              v
+------------------+           +------------------+
| Particle         |           | ParticleOverlay  |
| - update pos     |           | Painter          |
| - record trail   |           | - pick color     |
| - circular buf   |           | - draw path      |
+------------------+           +------------------+
```

---

## Tech Stack Summary

| Component | Technology | Notes |
|-----------|------------|-------|
| Trail Storage | `Float32List` | Pre-allocated circular buffer per particle |
| Color Gradient | Custom function | `getSpeedColor(speedMs)` with Color.lerp |
| Path Rendering | `Path` + `canvas.drawPath` | Quadratic bezier curves |
| State Management | Existing `ParticleOverlay` | Add ViewMode parameter |
| Persistence | `SharedPreferences` | Save view mode preference |
| UI Toggle | Debug panel button | Initial location |

---

## File Structure

### New Files

| File | Purpose | Lines Est. |
|------|---------|------------|
| `lib/models/view_mode.dart` | ViewMode enum (dots, streamlines) | ~30 |
| `lib/utils/wind_colors.dart` | Speed-to-color gradient function | ~60 |
| `test/models/view_mode_test.dart` | Tests for ViewMode enum | ~40 |
| `test/utils/wind_colors_test.dart` | Tests for speed color function | ~80 |

### Files to Modify

| File | Changes | Line Numbers (approx) |
|------|---------|----------------------|
| `lib/models/particle.dart` | Add trail storage (Float32List), speed field, resetTrail() | Lines 1-60 -> 1-120 |
| `lib/models/altitude_level.dart` | Add `streamlineTrailPoints` property | Lines 100-120 |
| `lib/widgets/particle_overlay.dart` | Add ViewMode parameter, streamline rendering | Lines 1-447 -> 1-600 |
| `lib/screens/ar_view_screen.dart` | Add ViewMode state, toggle in debug panel | Lines 60-80, 280-320 |
| `test/models/particle_test.dart` | Add trail storage tests | Lines 1-135 -> 1-200 |
| `test/widgets/particle_overlay_test.dart` | Add ViewMode and streamline tests | Add ~100 lines |
| `test/models/altitude_level_test.dart` | Add streamlineTrailPoints tests | Add ~20 lines |

---

## Data Model Changes

### Particle Model Extension

```dart
// Current
class Particle {
  double x, y;
  double age;
  double trailLength;
}

// Extended (with trail history)
class Particle {
  double x, y;
  double age;
  double trailLength;

  // NEW: Trail history as circular buffer
  late Float32List trailX;  // Pre-allocated X coordinates
  late Float32List trailY;  // Pre-allocated Y coordinates
  int trailHead = 0;        // Current head index in circular buffer
  int trailCount = 0;       // Number of valid points (0 to maxTrailPoints)
  double speed = 0.0;       // Current speed for color calculation

  // Allocated once in constructor
  static const int maxTrailPoints = 30;

  void recordTrailPoint() {
    // Circular buffer: overwrite oldest point
    trailX[trailHead] = x;
    trailY[trailHead] = y;
    trailHead = (trailHead + 1) % maxTrailPoints;
    if (trailCount < maxTrailPoints) trailCount++;
  }

  void resetTrail() {
    trailHead = 0;
    trailCount = 0;
  }
}
```

### Trail Points by Altitude

| Level | Trail Points | Screen % | Rationale |
|-------|-------------|----------|-----------|
| Jet Stream | 25 | 15-20% | Fast winds, dramatic trails |
| Mid-level | 18 | 8-12% | Medium winds |
| Surface | 12 | 4-6% | Slow winds, short trails |

### AltitudeLevel Extension

```dart
extension AltitudeLevelProperties on AltitudeLevel {
  // NEW: Trail point count for streamlines mode
  int get streamlineTrailPoints => switch (this) {
    AltitudeLevel.surface => 12,
    AltitudeLevel.midLevel => 18,
    AltitudeLevel.jetStream => 25,
  };
}
```

---

## Component Architecture

### ViewMode Enum

```dart
/// View modes for particle rendering.
enum ViewMode {
  /// Current behavior - short line segments (sprinkles/dots)
  dots,

  /// Flowing wind streamlines with trailing paths
  streamlines,
}
```

### Speed-to-Color Function

```dart
/// Returns color for wind speed visualization.
///
/// Speed ranges:
/// - 0-5 m/s: Blue (#3B82F6)
/// - 5-10 m/s: Cyan (#06B6D4)
/// - 10-20 m/s: Green (#22C55E)
/// - 20-35 m/s: Yellow (#EAB308)
/// - 35-50 m/s: Orange (#F97316)
/// - 50+ m/s: Red to Purple (#EF4444 -> #A855F7)
Color getSpeedColor(double speedMs) {
  // Interpolation between color stops
}
```

### Streamline Rendering

```dart
// In ParticleOverlayPainter.paint()
if (viewMode == ViewMode.streamlines) {
  for (final p in particles) {
    if (!skyMask.isPointInSky(p.x, p.y)) continue;
    if (p.trailCount < 2) continue;  // Need at least 2 points

    final path = Path();
    final color = getSpeedColor(p.speed);

    // Build path from trail points (circular buffer)
    // Use quadraticBezierTo for smooth curves
    // Apply opacity gradient from head to tail

    canvas.drawPath(path, _streamlinePaint);
  }
}
```

---

## State Management

### ParticleOverlay Changes

```dart
class ParticleOverlay extends StatefulWidget {
  // Existing fields...

  // NEW: View mode for rendering style
  final ViewMode viewMode;

  ParticleOverlay({
    // Existing params...
    this.viewMode = ViewMode.dots,  // Default to current behavior
  });
}
```

### ARViewScreen Changes

```dart
class _ARViewScreenState extends State<ARViewScreen> {
  // Existing fields...

  // NEW: View mode state
  ViewMode _viewMode = ViewMode.dots;

  // NEW: Toggle handler
  void _toggleViewMode() {
    setState(() {
      _viewMode = _viewMode == ViewMode.dots
          ? ViewMode.streamlines
          : ViewMode.dots;
    });
    // Save to SharedPreferences
  }
}
```

---

## Testing Strategy

### Unit Tests (45 tests estimated)

| Test File | Tests | Description |
|-----------|-------|-------------|
| `test/models/view_mode_test.dart` | 5 | ViewMode enum values, defaults |
| `test/utils/wind_colors_test.dart` | 15 | Speed thresholds, color interpolation, edge cases |
| `test/models/particle_test.dart` (additions) | 15 | Trail storage, circular buffer, resetTrail |
| `test/models/altitude_level_test.dart` (additions) | 5 | streamlineTrailPoints property |

### Widget Tests (20 tests estimated)

| Test File | Tests | Description |
|-----------|-------|-------------|
| `test/widgets/particle_overlay_test.dart` (additions) | 15 | ViewMode parameter, streamline rendering |
| `test/screens/ar_view_screen_test.dart` (additions) | 5 | ViewMode toggle, debug panel button |

### Integration Tests

| Test | Description |
|------|-------------|
| Dots mode renders correctly | Existing behavior unchanged |
| Streamlines mode renders trails | Path-based rendering works |
| Toggle switches between modes | UI toggle updates rendering |
| Performance: 45+ FPS in streamlines | PerformanceManager adapts particle count |

### Device Validation

| Test | How to Verify |
|------|--------------|
| Streamlines visible | Visual inspection on device |
| Colors match wind speed | Compare with debug panel wind speed |
| Trail length by altitude | Check surface vs jet stream trails |
| Performance: 45+ FPS | Check debug panel FPS counter |
| Toggle works | Tap toggle, observe rendering change |

---

## Performance Considerations

### Memory Impact

| Component | Per-Particle | 2000 Particles | 1000 Particles |
|-----------|-------------|----------------|----------------|
| Trail X (Float32List) | 30 * 4 = 120 bytes | 240 KB | 120 KB |
| Trail Y (Float32List) | 30 * 4 = 120 bytes | 240 KB | 120 KB |
| Speed field | 8 bytes | 16 KB | 8 KB |
| **Total Additional** | 248 bytes | **496 KB** | **248 KB** |

### Particle Count Strategy

```
ViewMode.dots:
  - Start at 2000 particles
  - PerformanceManager adjusts (existing behavior)

ViewMode.streamlines:
  - Start at 1000 particles (50% reduction)
  - PerformanceManager adjusts down to 500 if needed
  - Streamlines are more visually dense, fewer needed
```

### Optimization Techniques

1. **Pre-allocated Float32List** - No allocations in render loop
2. **Circular buffer** - O(1) trail point insertion
3. **Cached colors** - Pre-compute opacity variants
4. **Path reuse** - Consider Path pool (optional optimization)
5. **Reduced particle count** - 1000 streamlines vs 2000 dots

---

## Implementation Notes

### Key Decisions

1. **Float32List over List<Offset>** - Avoids object allocation per trail point
2. **Circular buffer** - Efficient trail point management without shifting
3. **30 max trail points** - Covers jet stream needs, reasonable memory
4. **ViewMode enum** - Simple, extensible (could add more modes later)
5. **Debug panel toggle first** - Easier testing, can move UI later

### Patterns to Follow

1. **Pre-allocation** - All trail arrays allocated in Particle constructor
2. **Cached colors** - Pre-compute speed colors for common values
3. **ValueNotifier repaint** - Same pattern as existing ParticleOverlay
4. **Mutable models** - Continue using mutable Particle for performance

### Trade-offs

| Decision | Pros | Cons |
|----------|------|------|
| Float32List | No GC, fast | More complex buffer logic |
| 30 trail points | Smooth curves | 248 bytes per particle |
| 1000 particles default | Better performance | Slightly less dense |
| Debug panel toggle | Easy to implement | Not ideal UX location |

---

## Non-Goals (Explicitly NOT Doing)

1. **Per-segment color variation** - All trail segments same color (simpler)
2. **Animated color along trail** - Static gradient only
3. **Fancy UI for toggle** - Simple button in debug panel
4. **Multiple streamline widths** - Single width for all altitudes
5. **Shader-based rendering** - CustomPainter only (no custom shaders)
6. **GPU path rendering** - Standard Flutter canvas only

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Performance drop | Start with 1000 particles, PerformanceManager adapts |
| Bezier too slow | Can fall back to straight line segments |
| Trail memory pressure | Float32List pre-allocated, no runtime allocation |
| Color computation slow | Pre-cache common speed-color mappings |
| Path allocation | Reuse Path object across frames |

---

## Success Criteria

- [ ] Particles render as flowing streamlines
- [ ] Trail length varies by altitude level (12/18/25 points)
- [ ] Colors shift based on wind speed (blue -> purple gradient)
- [ ] Toggle switches between Dots and Streamlines views
- [ ] Performance maintained at 45+ FPS
- [ ] Trails fade smoothly from head (opaque) to tail (transparent)
- [ ] Direction of flow clearly visible
- [ ] All existing tests pass (295+)
- [ ] New tests pass (~65 new tests)

---

## Handoff to Implement Agent

Implementation order:
1. ViewMode enum (simple, no dependencies)
2. Wind colors utility (independent)
3. Particle model extension (trail storage)
4. AltitudeLevel extension (trail points property)
5. ParticleOverlay streamline rendering
6. ARViewScreen toggle UI
7. Performance testing and tuning

All tests written BEFORE implementation (TDD).
