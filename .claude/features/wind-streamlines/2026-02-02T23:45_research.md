# Research: wind-streamlines

## Metadata
- **Feature:** wind-streamlines
- **Created:** 2026-02-02T23:45
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

**From ROADMAP_PHASE2.md:**
- Order: #9 (but recommended as next after performance-optimization)
- Depends on: None (but combines well with particle-colors)
- Dependency for: None
- Priority: HIGH
- Complexity: High

**From STATUS.md:**
- Previous feature completed: performance-optimization (FPS fixed from 5 to 45+)
- Current state: idle, waiting for wind-streamlines
- All 295 tests passing

## Requirements from Spec

### Source Sections
- ROADMAP_PHASE2.md -> Feature 9: wind-streamlines
- CLAUDE.md -> Particle Rendering (2-pass glow)
- CLAUDE.md -> Performance Targets

### Functional Requirements
- [ ] FR1: Replace current dot/sprinkle particles with flowing wind streamlines like Windy.com
- [ ] FR2: Particles leave animated trails showing wind direction and flow
- [ ] FR3: Trail length varies by altitude (longer at jet stream, shorter at surface)
- [ ] FR4: Color gradient based on wind speed (blue -> green -> yellow -> red -> purple)
- [ ] FR5: Toggle option to switch between "Dots" and "Streamlines" view modes
- [ ] FR6: Save view mode preference to local storage
- [ ] FR7: Direction of flow must be clearly visible in streamlines

### Technical Requirements
- [ ] TR1: Performance maintained at 45+ FPS
- [ ] TR2: Trail fades from full opacity (head) to transparent (tail)
- [ ] TR3: Use quadratic bezier curves for smooth flow (not straight lines)
- [ ] TR4: Pre-allocate trail point arrays to avoid GC
- [ ] TR5: Consider using Float32List for trail coordinates if needed

### Trail Length by Altitude (from user input)
| Level | Trail Length (% screen width) |
|-------|-------------------------------|
| Jet Stream | 15-20% |
| Mid-level | 8-12% |
| Surface | 4-6% |

### Speed-Based Color Gradient (from user input)
| Speed (m/s) | Color | Hex |
|-------------|-------|-----|
| 0-5 | Blue | #3B82F6 |
| 5-10 | Cyan | #06B6D4 |
| 10-20 | Green | #22C55E |
| 20-35 | Yellow | #EAB308 |
| 35-50 | Orange | #F97316 |
| 50+ | Red/Purple | #EF4444 -> #A855F7 |

### Code Example from Spec
```dart
class StreamlineParticle {
  List<Offset> trailPoints;  // History of positions (10-30 points)
  double age;
  double speed;
  double direction;

  void update(double dt, WindData wind) {
    // Add current position to trail
    trailPoints.add(currentPosition);
    // Remove oldest point if trail too long
    if (trailPoints.length > maxTrailLength) {
      trailPoints.removeAt(0);
    }
    // Move particle based on wind
    currentPosition += windVelocity * dt;
  }
}
```

### Warnings/Critical Notes from Spec
> Performance: May need to reduce particle count for performance (streamlines more expensive)
> Pre-allocate trail point arrays to avoid GC
> Use Float32List for trail coordinates if needed
> Test on device - ensure 45+ FPS maintained

## Existing Code Analysis

### Project State
- Flutter project exists: YES (at /workspace/wind_lens/)
- Tests: 295 passing
- Performance: Optimized to 45+ FPS

### Relevant Existing Files

1. **`/workspace/wind_lens/lib/models/particle.dart`** (59 lines)
   - Current particle model with: x, y, age, trailLength
   - Uses normalized coordinates (0.0-1.0)
   - Mutable for in-place updates (GC-optimized)
   - `reset()` method for particle recycling
   - **Needs modification:** Add trail history storage

2. **`/workspace/wind_lens/lib/widgets/particle_overlay.dart`** (447 lines)
   - `ParticleOverlay` StatefulWidget with Ticker animation
   - `ParticleOverlayPainter` CustomPainter for rendering
   - Pre-allocated particle pool (2000 particles)
   - 2-pass glow rendering (glow + core)
   - Performance-optimized with:
     - `ValueNotifier<int>` for repaint triggering (no setState)
     - Pre-cached colors for opacity levels
     - Pre-allocated Paint objects
   - **Needs modification:** Add streamline rendering mode

3. **`/workspace/wind_lens/lib/models/altitude_level.dart`** (119 lines)
   - `AltitudeLevel` enum: surface, midLevel, jetStream
   - Properties: particleColor, trailScale, parallaxFactor
   - Current trailScale values: 1.0 (surface), 0.7 (mid), 0.5 (jet)
   - **Needs modification:** Add streamline-specific trail lengths

4. **`/workspace/wind_lens/lib/screens/ar_view_screen.dart`** (346 lines)
   - Main screen composing all layers
   - Has debug panel toggle (3-finger tap or button)
   - **Needs modification:** Add view mode toggle UI

5. **`/workspace/wind_lens/lib/services/performance_manager.dart`** (152 lines)
   - Adaptive particle count (2000 -> 500 based on FPS)
   - FPS thresholds: <45 reduce, >58 increase
   - **May need modification:** Adjust thresholds for streamlines

### Code to Reuse
- `Particle` class structure (extend, don't replace)
- `ParticleOverlay` widget structure (add rendering mode)
- Pre-allocated paint objects pattern
- Cached color pattern for opacity levels
- `PerformanceManager` for adaptive performance
- `ValueNotifier` repaint pattern (no setState)

### Code to Modify
1. `particle.dart`: Add trail points storage (List<Offset> or Float32List)
2. `particle_overlay.dart`: Add streamline rendering path alongside dot rendering
3. `altitude_level.dart`: Add streamlineTrailLength property
4. `ar_view_screen.dart`: Add view mode toggle button/gesture

### Patterns to Follow
- Pre-allocation everywhere (no allocations in render loop)
- Cached colors for common values
- `ValueNotifier` for triggering repaints
- `RepaintBoundary` for isolation
- Mutable models with reset() methods

## Visual Analysis

### Current State (from /workspace/images/app_img.PNG)
- Particles render as short line segments ("dots/sprinkles")
- Single color per altitude level (currently showing purple for jet stream)
- Trail length is very short (current trailLength = speed * 0.5 * trailScale)
- No position history - just a single line from current position backward
- 2-pass glow effect working (glow + core)

### Target State (from /workspace/images/windy_img_goal.png)
- Flowing curved streamlines showing wind patterns
- Color varies by wind speed (blue -> green -> yellow -> orange -> pink/purple)
- Trails have multiple points creating smooth curves
- Clear directional flow visible
- Trails fade from head (bright) to tail (transparent)
- Higher density of particles creates flowing pattern effect

### Key Visual Differences
1. **Trail length:** Current ~10px, target ~50-100+ px depending on altitude
2. **Trail shape:** Current straight line, target curved path with multiple points
3. **Color:** Current single color per altitude, target gradient by speed
4. **Opacity gradient:** Current uniform along trail, target fading tail
5. **Particle density:** May need adjustment for visual flow effect

## Technical Approach Recommendations

### Option A: Extend Particle Model with Trail History (RECOMMENDED)

**Approach:**
- Add `List<double>` for trail X/Y coordinates (using doubles not Offsets to avoid object allocation)
- Store last N positions (10-30 points based on altitude)
- Render using `Path` with quadratic bezier curves
- Add opacity gradient from head to tail

**Pros:**
- Clean extension of existing model
- Smooth curved trails possible
- Easy to toggle between modes

**Cons:**
- Memory increase per particle (~200 bytes for 30 points)
- May need to reduce particle count

### Option B: Use Float32List for Trail Coordinates (PERFORMANCE-OPTIMIZED)

**Approach:**
- Pre-allocate `Float32List` per particle for trail coordinates
- Circular buffer for position history
- Render using Path.quadraticBezierTo

**Pros:**
- Best memory layout for performance
- No allocations during updates

**Cons:**
- More complex implementation
- Circular buffer logic needed

### Option C: Single Path Per Altitude Level (SIMPLER)

**Approach:**
- Instead of per-particle trails, maintain fewer, longer streamlines
- Particles become "heads" that advance along streamlines

**Pros:**
- Fewer objects to manage
- Potentially simpler rendering

**Cons:**
- Different from existing architecture
- May not look as natural

### RECOMMENDED: Option A with Float32List optimization

Start with Option A for cleaner code, optimize to Option B (Float32List) if needed for performance.

### Implementation Strategy

1. **Phase 1: Data Model Extension**
   - Add trail storage to Particle model
   - Add streamlineTrailLength to AltitudeLevel
   - Add speed-based color utility function

2. **Phase 2: Rendering**
   - Create StreamlineOverlayPainter (or add mode to existing)
   - Implement Path-based trail rendering with bezier curves
   - Add opacity gradient from head to tail

3. **Phase 3: Toggle UI**
   - Add view mode state to ARViewScreen
   - Add toggle button/gesture
   - Persist preference to SharedPreferences

4. **Phase 4: Performance Tuning**
   - Reduce particle count for streamlines mode (maybe 1000 instead of 2000)
   - Profile and optimize if needed
   - Ensure 45+ FPS on device

### Trail Point Count by Altitude

Based on screen width percentages and assuming ~20px per trail point:
| Level | Trail Length | Points Needed |
|-------|--------------|---------------|
| Jet Stream | 15-20% (~60-80px on 390px screen) | 20-25 points |
| Mid-level | 8-12% (~30-50px) | 15-20 points |
| Surface | 4-6% (~15-25px) | 10-15 points |

### Color Interpolation Function

```dart
Color getSpeedColor(double speedMs) {
  if (speedMs < 5) return const Color(0xFF3B82F6);   // Blue
  if (speedMs < 10) return Color.lerp(Color(0xFF3B82F6), Color(0xFF06B6D4), (speedMs - 5) / 5)!;
  if (speedMs < 20) return Color.lerp(Color(0xFF06B6D4), Color(0xFF22C55E), (speedMs - 10) / 10)!;
  if (speedMs < 35) return Color.lerp(Color(0xFF22C55E), Color(0xFFEAB308), (speedMs - 20) / 15)!;
  if (speedMs < 50) return Color.lerp(Color(0xFFEAB308), Color(0xFFF97316), (speedMs - 35) / 15)!;
  return Color.lerp(Color(0xFFF97316), Color(0xFFA855F7), ((speedMs - 50) / 50).clamp(0, 1))!;
}
```

## Constraints

### Performance
- Frame rate: 45+ FPS minimum (currently achieving this)
- processFrame() < 16ms
- NO object allocation in render loop (critical)
- May need to reduce particle count from 2000 to 1000-1500 for streamlines

### Platform
- iOS 14.0+, Android API 24+
- Real device testing required (no simulator for camera/sensors)

### Memory
- Trail history adds ~200 bytes per particle (30 points * 2 floats * 4 bytes)
- 2000 particles * 200 bytes = 400KB additional memory
- 1000 particles * 200 bytes = 200KB additional memory

### Dependencies
- No new packages required
- SharedPreferences needed for view mode persistence (already in Flutter SDK)

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Performance drop below 45 FPS with trails | High | Medium | Reduce particle count, use Float32List, profile early |
| Bezier curves too expensive | Medium | Low | Fallback to straight line segments |
| Memory pressure from trail history | Medium | Low | Limit trail points, use compact storage |
| Color interpolation too slow | Low | Low | Pre-compute color table |

### Complexity
- **Level:** High
- **Rationale:**
  - Significant rendering logic changes
  - New data structures for trail history
  - Performance-critical with tight constraints
  - UI toggle with persistence
  - Must maintain backward compatibility (dot mode)

## Open Questions

- [x] Q1: Should we reduce particle count in streamlines mode?
  - Resolution: Yes, likely need to reduce from 2000 to 1000-1500 for performance
  - Status: RESOLVED (recommended approach)

- [x] Q2: Should speed colors override altitude colors or combine?
  - Resolution: Speed colors should be primary in streamlines mode (matches Windy.com style)
  - Status: RESOLVED (matches spec)

- [x] Q3: What's the minimum trail points needed for smooth curves?
  - Resolution: 10-15 points minimum for bezier smoothness, 20-25 for jet stream
  - Status: RESOLVED

- [x] Q4: Should trail length be in screen % or pixels?
  - Resolution: Screen % for device independence, convert to pixels at render time
  - Status: RESOLVED (matches spec)

- [x] Q5: Toggle UI location - where should it be placed?
  - Resolution: Add to debug panel initially, or long-press altitude slider
  - Status: RESOLVED (user specified options in spec)

## Recommended Approach

### Implementation Strategy
1. **Start with data model changes** - extend Particle with trail history
2. **Add rendering mode** - create separate painter or mode switch in existing
3. **Implement incrementally** - get basic trails working before curves/colors
4. **Add UI toggle last** - once rendering is solid
5. **Profile throughout** - catch performance issues early

### Order of Work
1. Extend `Particle` model with trail point storage
2. Add `streamlineTrailLength` to `AltitudeLevel` extension
3. Create speed-to-color utility function in color_utils.dart
4. Add `ViewMode` enum (dots, streamlines)
5. Update `ParticleOverlay._onTick()` to record trail history
6. Create `StreamlinePainter` or add mode to `ParticleOverlayPainter`
7. Implement Path-based rendering with bezier curves
8. Add opacity gradient to trail
9. Add toggle UI to ARViewScreen
10. Add SharedPreferences persistence
11. Performance test and optimize

### What to Defer (Not MVP Critical)
- Advanced bezier smoothing (start with simpler quadratic)
- Per-particle color variations (uniform speed color is fine)
- Animation of color along trail (static color gradient is fine)
- Fancy UI animations for toggle

## Acceptance Criteria (from ROADMAP)

- [ ] Particles render as flowing streamlines (not dots)
- [ ] Trail length varies by altitude level
- [ ] Colors shift based on wind speed (blue -> purple gradient)
- [ ] Toggle to switch between Dots and Streamlines views
- [ ] Performance maintained at 45+ FPS
- [ ] Trails fade smoothly from head to tail
- [ ] Direction of flow clearly visible

## Files to Create/Modify

### New Files
- `lib/models/view_mode.dart` - ViewMode enum (dots, streamlines)
- `lib/utils/wind_colors.dart` - Speed-to-color utility (or add to color_utils.dart)

### Files to Modify
- `lib/models/particle.dart` - Add trail storage
- `lib/models/altitude_level.dart` - Add streamline trail lengths
- `lib/widgets/particle_overlay.dart` - Add streamline rendering
- `lib/screens/ar_view_screen.dart` - Add toggle UI
- `test/` - Add corresponding tests

## Next Step

**Status: research-complete**

Run `/plan wind-streamlines` to create implementation plan with task breakdown.
