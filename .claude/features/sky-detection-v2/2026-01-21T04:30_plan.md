# Implementation Plan: Sky Detection Level 2a (Auto-Calibrating)

## Metadata
- **Feature:** sky-detection-v2
- **Created:** 2026-01-21T04:30
- **Status:** plan-complete
- **Based On:**
  - Diagnosis: `.claude/active-work/sky-detection/diagnosis.md`
  - Research: `.claude/features/sky-detection/2026-01-21T00:51_research.md`
  - MVP Spec: `WIND_LENS_MVP_SPEC.md` Section 3 (Level 2a)

---

## 1. Feature Overview

### Problem Statement
The current pitch-based sky detection (Level 1) has critical limitations:
- Cannot distinguish sky from ceiling indoors
- Ignores actual blue sky at low tilt angles
- No per-pixel understanding of what is actually sky

### Solution: Auto-Calibrating Color-Based Detection
Implement Level 2a as specified in MVP Spec:
1. When user points phone up (pitch > 45 deg), app samples sky colors from top 10-40% of frame
2. Builds HSV histogram with statistical profile (mean, std dev, percentile ranges)
3. Uses learned profile to score each pixel as sky/not-sky
4. Auto-recalibrates every 5 minutes for lighting changes
5. Falls back to pitch-based when not calibrated

### Key Requirements
- Must process frames in < 16ms for 60 FPS
- Must work cross-platform (iOS BGRA, Android YUV)
- Must integrate with existing SkyMask interface
- Must provide fallback when not calibrated

---

## 2. Architecture Overview

### Component Hierarchy
```
                     +------------------+
                     |    ARViewScreen  |
                     +--------+---------+
                              |
                              | uses
                              v
+---------------------------+----------------------------+
|              AutoCalibratingSkyDetector                |
|  (implements SkyMask, manages calibration lifecycle)   |
+---------------------------+----------------------------+
        |                   |                    |
        v                   v                    v
+---------------+   +---------------+   +------------------+
| HSVHistogram  |   | ColorUtils    |   | PitchBasedSkyMask|
| (learned sky  |   | (RGB->HSV,    |   | (fallback when   |
|  profile)     |   |  YUV->RGB)    |   |  not calibrated) |
+---------------+   +---------------+   +------------------+
```

### Data Flow
```
CameraImage (BGRA/YUV420)
       |
       v
+-----------------------------+
|  AutoCalibratingSkyDetector |
|  1. Check needsCalibration  |
|  2. If pitch>45 & needs:    |
|     - Extract RGB pixels    |
|     - Convert to HSV        |
|     - Build HSVHistogram    |
|  3. For detection:          |
|     - For each pixel:       |
|       - RGB -> HSV          |
|       - matchScore() * pos  |
|       - Store in mask       |
|  4. Return Uint8List mask   |
+-----------------------------+
       |
       v
ParticleOverlay.isPointInSky(x, y)
```

---

## 3. Tech Stack Summary

| Component | Technology |
|-----------|------------|
| Language | Dart 3.x |
| Framework | Flutter 3.x |
| Camera | camera ^0.11.3 |
| Image Format | BGRA (iOS), YUV420 (Android) |
| State | Stateful widget integration |
| Testing | flutter_test |

---

## 4. File Structure

### New Files to Create

| File | Purpose | Lines (est) |
|------|---------|-------------|
| `lib/utils/color_utils.dart` | RGB-HSV conversion, platform image extraction | ~120 |
| `lib/models/hsv.dart` | Simple HSV data class | ~25 |
| `lib/services/sky_detection/hsv_histogram.dart` | Statistical sky color profile | ~100 |
| `lib/services/sky_detection/auto_calibrating_sky_detector.dart` | Main detector implementation | ~250 |
| `test/utils/color_utils_test.dart` | Unit tests for color conversion | ~80 |
| `test/models/hsv_test.dart` | Unit tests for HSV class | ~40 |
| `test/services/sky_detection/hsv_histogram_test.dart` | Unit tests for histogram | ~120 |
| `test/services/sky_detection/auto_calibrating_sky_detector_test.dart` | Unit tests for detector | ~200 |

### Files to Modify

| File | Changes | Lines Affected |
|------|---------|----------------|
| `lib/widgets/camera_view.dart` | Enable image streaming when onFrame provided | ~20 lines (lines 77-85) |
| `lib/screens/ar_view_screen.dart` | Use AutoCalibratingSkyDetector, wire camera callback | ~30 lines (lines 11, 51, 83, 155) |
| `lib/services/sky_detection/sky_mask.dart` | Add optional processFrame method signature | ~5 lines |

---

## 5. Data Model

### HSV Class
```dart
class HSV {
  final double h;  // Hue: 0-360 degrees
  final double s;  // Saturation: 0.0-1.0
  final double v;  // Value: 0.0-1.0

  const HSV(this.h, this.s, this.v);
}
```

### HSVHistogram Class
```dart
class HSVHistogram {
  // Range values (5th and 95th percentile for robustness)
  final double hueMin, hueMax, hueMean, hueStd;
  final double satMin, satMax, satMean, satStd;
  final double valMin, valMax, valMean, valStd;

  // Factory constructor
  factory HSVHistogram.fromSamples(List<HSV> samples);

  // Gaussian-like match scoring
  double matchScore(HSV pixel);
}
```

### AutoCalibratingSkyDetector Interface
```dart
class AutoCalibratingSkyDetector implements SkyMask {
  // Calibration state
  HSVHistogram? _skyHistogram;
  DateTime? _lastCalibration;

  // Configuration
  static const Duration recalibrationInterval = Duration(minutes: 5);
  static const double calibrationPitchThreshold = 45.0;
  static const double sampleRegionTop = 0.1;
  static const double sampleRegionBottom = 0.4;

  // Current pitch (updated externally)
  double _pitch = 0;

  // Fallback detector
  final PitchBasedSkyMask _fallback;

  // Core methods
  void updatePitch(double pitchDegrees);
  void processFrame(CameraImage image);
  bool get isCalibrated;
  bool get needsCalibration;

  // SkyMask interface
  double get skyFraction;
  bool isPointInSky(double normalizedX, double normalizedY);
}
```

---

## 6. Component Architecture

### State Management
The detector maintains internal state:
- `_skyHistogram`: Learned sky color profile (null until calibrated)
- `_lastCalibration`: Timestamp of last calibration
- `_pitch`: Current device pitch (updated each frame)
- `_currentMask`: Cached pixel mask (Uint8List)
- `_maskWidth`, `_maskHeight`: Dimensions of cached mask

### Calibration State Machine
```
         +-------------+
         |  UNCALIBRATED|
         +------+------+
                |
    pitch > 45 && processFrame called
                |
                v
         +-------------+
         | CALIBRATING |
         |  (sampling) |
         +------+------+
                |
    histogram built
                |
                v
         +-------------+
         | CALIBRATED  |<----+
         +------+------+     |
                |            |
    5 minutes elapsed        |
                |            |
                v            |
         +-------------+     |
         | RECALIBRATING|----+
         +-------------+
```

### Mask Caching Strategy
- Downscale camera frame to 128x96 for processing
- Cache mask at downscaled resolution
- `isPointInSky()` samples from cached mask using bilinear interpolation
- Mask is regenerated each frame when calibrated

---

## 7. Testing Strategy

### Unit Tests (TDD - Write First)

| Test File | Test Count | Coverage |
|-----------|------------|----------|
| `color_utils_test.dart` | ~12 | RGB->HSV conversion accuracy, edge cases |
| `hsv_test.dart` | ~6 | HSV construction, equality, edge values |
| `hsv_histogram_test.dart` | ~15 | fromSamples, matchScore, percentiles, edge cases |
| `auto_calibrating_sky_detector_test.dart` | ~20 | Calibration flow, fallback, mask generation |

**Total Unit Tests: ~53**

### Key Test Cases

**Color Utils:**
- Pure red (255,0,0) -> HSV(0, 1.0, 1.0)
- Pure green (0,255,0) -> HSV(120, 1.0, 1.0)
- Pure blue (0,0,255) -> HSV(240, 1.0, 1.0)
- White (255,255,255) -> HSV(0, 0, 1.0)
- Black (0,0,0) -> HSV(0, 0, 0)
- Sky blue (135,206,235) -> HSV(~197, ~0.43, ~0.92)

**HSVHistogram:**
- fromSamples with uniform values -> tight ranges
- fromSamples with varied values -> appropriate std dev
- matchScore returns 1.0 for exact mean match
- matchScore returns 0.0 for out-of-range values
- Percentile calculation robustness to outliers

**AutoCalibratingSkyDetector:**
- Returns fallback skyFraction when not calibrated
- Triggers calibration when pitch > 45 and needs calibration
- Does not calibrate when pitch < 45
- isPointInSky uses fallback before calibration
- isPointInSky uses learned mask after calibration
- Recalibrates after 5 minutes
- processFrame updates mask correctly

### Integration Tests (Manual - Real Device)
- Calibrate by pointing at clear sky
- Verify particles appear only in sky region
- Test indoor (should show ceiling as non-sky after calibration)
- Test recalibration with changing lighting

---

## 8. Implementation Notes

### Performance Optimization

**Target: < 16ms per frame**

1. **Downscaling**: Process at 128x96 instead of full resolution
   - 128 * 96 = 12,288 pixels vs 1920 * 1080 = 2,073,600 pixels
   - 169x reduction in pixel processing

2. **Sampling for Calibration**: Every 10th pixel
   - ~1,200 samples instead of ~12,000

3. **Early Termination**: Skip bottom 20% of frame during detection
   - Position weight < 0.2 -> skip entirely

4. **Cached Mask**: Don't regenerate if camera frame unchanged
   - Track frame timestamp

5. **Pre-allocated Buffers**:
   - Mask buffer: `Uint8List(128 * 96)` allocated once
   - HSV buffer: Reuse single HSV object for conversion

### Platform Image Format Handling

**iOS (BGRA8888):**
```dart
// planes[0] contains BGRA data
final bytes = image.planes[0].bytes;
final idx = (y * width + x) * 4;
final b = bytes[idx];
final g = bytes[idx + 1];
final r = bytes[idx + 2];
final a = bytes[idx + 3];
```

**Android (YUV420):**
```dart
// planes[0] = Y, planes[1] = U, planes[2] = V
// Need YUV -> RGB conversion
final y = image.planes[0].bytes[yIndex];
final u = image.planes[1].bytes[uvIndex];
final v = image.planes[2].bytes[uvIndex];
// Convert using standard formula
```

### Algorithm Details

**RGB to HSV Conversion:**
```dart
HSV rgbToHsv(int r, int g, int b) {
  final rf = r / 255.0;
  final gf = g / 255.0;
  final bf = b / 255.0;

  final max = [rf, gf, bf].reduce((a, b) => a > b ? a : b);
  final min = [rf, gf, bf].reduce((a, b) => a < b ? a : b);
  final delta = max - min;

  double h;
  if (delta == 0) {
    h = 0;
  } else if (max == rf) {
    h = 60 * (((gf - bf) / delta) % 6);
  } else if (max == gf) {
    h = 60 * (((bf - rf) / delta) + 2);
  } else {
    h = 60 * (((rf - gf) / delta) + 4);
  }
  if (h < 0) h += 360;

  final s = max == 0 ? 0.0 : delta / max;
  final v = max;

  return HSV(h, s, v);
}
```

**Gaussian Match Scoring:**
```dart
double _gaussianScore(double value, double mean, double std) {
  if (std < 0.01) std = 0.01; // Prevent division by zero
  final diff = (value - mean).abs();
  return exp(-(diff * diff) / (2 * std * std));
}
```

**Position-Based Sky Prior:**
```dart
double _calculateSkyPrior(double pitchDegrees) {
  if (pitchDegrees < 0) return 0.2;
  if (pitchDegrees > 60) return 1.0;
  return 0.3 + (pitchDegrees / 60) * 0.7;
}
```

---

## 9. Non-Goals (Explicitly Not Building)

1. **Level 2b (Integral Images)** - O(1) variance check for uniformity
2. **Level 3 (ML/TFLite)** - Deep learning sky segmentation
3. **Cloud detection** - Distinguishing clouds from blue sky
4. **Building edge detection** - Sharp boundary detection for buildings
5. **Temporal smoothing** - Frame-to-frame mask consistency
6. **User-visible calibration UI** - Progress indicator, calibration feedback

These are documented for potential future enhancements but out of scope for this implementation.

---

## 10. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Performance > 16ms | Medium | High | Downscale aggressively, profile early |
| Android YUV conversion complex | Medium | Medium | Test on Android device early |
| Calibration fails on overcast sky | Low | Medium | Fallback to pitch-based always available |
| Memory pressure from mask buffers | Low | Medium | Single pre-allocated buffer |
| Color matching too strict/loose | Medium | Medium | Tunable thresholds, test with real sky |

---

## 11. Success Criteria

Planning is complete when:
- [x] Architecture designed with diagrams
- [x] File structure planned (new + modified files)
- [x] Data models defined (HSV, HSVHistogram)
- [x] Tasks broken into discrete units
- [x] Dependencies identified and ordered
- [x] Testing strategy defined
- [x] Performance considerations documented
- [x] Both plan.md and tasks.md created

Implementation is complete when:
- [ ] All unit tests pass (53+ tests)
- [ ] Build succeeds with no errors
- [ ] Real device shows color-based sky detection working
- [ ] Indoor test correctly identifies ceiling as non-sky
- [ ] Frame processing stays under 16ms
- [ ] Fallback to pitch-based works when not calibrated
