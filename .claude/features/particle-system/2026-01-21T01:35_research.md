# Research: particle-system

## Metadata
- **Feature:** particle-system
- **Created:** 2026-01-21T01:35
- **Status:** research-complete

## Requirements from Spec

From `ROADMAP.md` Feature 4 and `WIND_LENS_MVP_SPEC.md` Section 9:

### What to Build
- Particle model (x, y, age, trailLength)
- ParticleOverlay widget (CustomPainter)
- 2-pass glow rendering:
  - Glow pass: width=4.0, opacity=0.3, blur
  - Core pass: width=1.5, opacity=0.9
- Particles render ONLY in sky mask region
- Target: 2000 particles at 60 FPS

### Acceptance Criteria
- [ ] Particles visible only in sky region
- [ ] Particles stop at sky/ground boundary
- [ ] Glow effect visible
- [ ] Logs: "Rendering N particles at X FPS"
- [ ] No object allocation in render loop

### From MVP Spec Section 9 - Particle System

**Particle Model:**
```dart
class Particle {
  double x;           // 0.0 to 1.0 (normalized screen coordinates)
  double y;           // 0.0 to 1.0
  double age;         // 0.0 to 1.0 (for fade in/out)
  double trailLength; // pixels, based on wind speed

  void reset(Random random) {
    x = random.nextDouble();
    y = random.nextDouble();
    age = 0.0;
  }
}
```

**Core Algorithm:**
1. Maintain pool of N particles (start with N=2000)
2. Each frame:
   - Move each particle based on wind vector
   - Age each particle
   - If particle is off-screen OR too old → reset to random position
3. Draw each particle as a short line (trail) in direction of movement
4. Fade opacity based on age (fade in at birth, fade out at death)

**2-Pass Glow Rendering:**
```dart
// PASS 1: The glow
glowPaint.strokeWidth = 4.0;
glowPaint.color = color.withOpacity(baseOpacity * 0.3);
glowPaint.maskFilter = MaskFilter.blur(BlurStyle.normal, 2.0);
canvas.drawLine(start, end, glowPaint);

// PASS 2: The core
corePaint.strokeWidth = 1.5;
corePaint.color = color.withOpacity(baseOpacity * 0.9);
canvas.drawLine(start, end, corePaint);
```

**Sky Mask Integration:**
```dart
for (final p in particles) {
  // SKY MASK CHECK: Only render if this point is in sky
  if (!skyMask.isPointInSky(p.x, p.y)) {
    continue;  // Skip particles over buildings/ground
  }
  // ... render particle
}
```

**Opacity Calculation:**
```dart
double baseOpacity = sin(p.age * pi).clamp(0.0, 1.0);
```
This creates fade-in at birth, peak at middle age, fade-out at death.

## Existing Code Analysis

### Current State
- Project at `/workspace/wind_lens`
- SkyMask interface exists (`lib/services/sky_detection/sky_mask.dart`)
- PitchBasedSkyMask exists (`lib/services/sky_detection/pitch_based_sky_mask.dart`)
- CompassService provides heading/pitch
- ARViewScreen has SkyMask integration
- No particle code exists yet

### Architecture to Add
```
lib/
├── models/
│   └── particle.dart              # Particle data class
└── widgets/
    └── particle_overlay.dart      # CustomPainter widget
```

### Integration Points
- `SkyMask.isPointInSky()` - filter which particles render
- ARViewScreen - add ParticleOverlay to Stack
- Animation - use Ticker for 60 FPS updates

## Technical Constraints

From CLAUDE.md and MVP Spec:
- **Performance:** 2000 particles at 60 FPS
- **No object allocation in render loop** - critical for performance
- **Pre-allocate particle pool** - don't create/destroy particles
- **Use Ticker for animation** - not Timer
- If FPS < 45, reduce to 1000 particles

### Performance Warning from Spec
> Bilinear interpolation for 2000 particles × 60 FPS = **120,000 calculations/second**.
> DO NOT create new objects inside the render loop — triggers GC stutter.

### Rendering Details
- Glow pass: width=4.0, opacity=0.3, MaskFilter.blur(BlurStyle.normal, 2.0)
- Core pass: width=1.5, opacity=0.9
- StrokeCap.round for smooth ends

## Open Questions

All resolved:
- [x] Wind direction source? → For now, use fixed angle (wind-animation feature adds real wind)
- [x] Particle color? → White (Colors.white) for now, altitude colors in altitude-depth feature
- [x] Trail length source? → Fixed value for now, wind speed in wind-animation feature
- [x] Animation approach? → SingleTickerProviderStateMixin with Ticker

## Recommended Approach

### 1. Create Particle Model
```dart
class Particle {
  double x;
  double y;
  double age;
  double trailLength;

  Particle({this.x = 0, this.y = 0, this.age = 0, this.trailLength = 10});

  void reset(Random random) {
    x = random.nextDouble();
    y = random.nextDouble();
    age = 0.0;
  }

  bool get isExpired => age >= 1.0;
}
```

### 2. Create ParticleOverlay Widget
- StatefulWidget with SingleTickerProviderStateMixin
- Pre-allocate particle pool in initState
- Use Ticker for animation loop
- CustomPainter for rendering
- Pass SkyMask for filtering

### 3. Create ParticleOverlayPainter
- Implement CustomPainter
- 2-pass glow rendering
- Skip particles outside sky mask
- FPS logging

### 4. Integration
- Add ParticleOverlay to ARViewScreen Stack
- Pass current pitch and sky mask
- Add particle count/FPS to debug overlay

### Architecture
```dart
ParticleOverlay (StatefulWidget)
├── _ParticleOverlayState
│   ├── Ticker for animation
│   ├── List<Particle> pool (pre-allocated)
│   ├── Random for resets
│   └── lastFrameTime for delta calculation
└── ParticleOverlayPainter (CustomPainter)
    ├── particles list
    ├── skyMask reference
    ├── windAngle (fixed for now)
    └── 2-pass rendering
```

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| GC stutter from allocations | Frame drops | Pre-allocate all particles, no new objects in loop |
| Too many particles | <60 FPS | Start with 2000, auto-reduce to 1000 if needed |
| Sky mask check overhead | Performance | O(1) check is negligible |
| Animation not smooth | Visual quality | Use Ticker, not Timer |
| Particles visible on ground | Looks fake | Use SkyMask.isPointInSky() |

## Dependencies

- **Depends on:** `sky-detection` (complete - provides SkyMask)
- **Required by:** `wind-animation` (will add wind direction), `altitude-depth` (will add colors/parallax)

## Performance Budget

| Operation | Budget | Expected |
|-----------|--------|----------|
| Particle updates (2000) | 8ms | ~2ms |
| Rendering (2000 particles × 2 passes) | 8ms | ~4ms |
| Sky mask checks (2000) | <1ms | ~0.1ms |
| **Total per frame** | **16ms** | **~6ms** |

## Next Step

Run `/plan particle-system` to design detailed implementation.
