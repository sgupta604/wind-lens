# Plan: particle-system

## Metadata
- **Feature:** particle-system
- **Created:** 2026-01-21T01:37
- **Status:** plan-complete
- **Based On:** 2026-01-21T01:35_research.md

---

## Architecture Overview

```
+------------------+     +-------------------+     +--------------------+
|  ARViewScreen    |     |  ParticleOverlay  |     | ParticleOverlay-   |
|  (existing)      |---->|  (StatefulWidget) |---->| Painter            |
+------------------+     +-------------------+     +--------------------+
        |                        |                        |
        v                        v                        v
+------------------+     +-------------------+     +--------------------+
| PitchBasedSkyMask|     | Ticker Animation  |     | 2-Pass Glow        |
| (provides mask)  |     | (60 FPS updates)  |     | Rendering          |
+------------------+     +-------------------+     +--------------------+
                                 |
                                 v
                         +-------------------+
                         | List<Particle>    |
                         | (pre-allocated    |
                         |  pool of 2000)    |
                         +-------------------+
```

### Data Flow

```
1. Ticker fires (every frame, ~16ms)
         |
         v
2. Update all particle positions and ages
         |
         v
3. Reset expired/off-screen particles
         |
         v
4. Call setState() to trigger repaint
         |
         v
5. CustomPainter.paint() called
         |
         v
6. For each particle:
   - Check if in sky region (SkyMask.isPointInSky)
   - Skip if not in sky
   - Draw glow pass (width=4.0, blur, opacity=0.3)
   - Draw core pass (width=1.5, opacity=0.9)
```

---

## Tech Stack Summary

- **Widget Type:** StatefulWidget with SingleTickerProviderStateMixin
- **Animation:** Ticker for 60 FPS frame callbacks
- **Rendering:** CustomPainter (ParticleOverlayPainter)
- **Dependency:** SkyMask interface for sky region filtering
- **State Management:** Local state with List<Particle> pool

---

## File Structure

### New Files to Create

| File | Purpose |
|------|---------|
| `lib/models/particle.dart` | Particle data class with x, y, age, trailLength |
| `lib/widgets/particle_overlay.dart` | StatefulWidget + CustomPainter |
| `test/models/particle_test.dart` | Unit tests for Particle model |
| `test/widgets/particle_overlay_test.dart` | Widget tests for ParticleOverlay |

### Existing Files to Modify

| File | Changes | Location |
|------|---------|----------|
| `lib/screens/ar_view_screen.dart` | Add ParticleOverlay to Stack, pass SkyMask | Lines 71-84 (Stack children) |

---

## Component Specifications

### 1. Particle Model (`lib/models/particle.dart`)

```dart
class Particle {
  /// Normalized X position (0.0 = left, 1.0 = right)
  double x;

  /// Normalized Y position (0.0 = top, 1.0 = bottom)
  double y;

  /// Age from 0.0 (birth) to 1.0 (death)
  double age;

  /// Trail length in screen pixels
  double trailLength;

  /// Constructor with defaults
  Particle({
    this.x = 0,
    this.y = 0,
    this.age = 0,
    this.trailLength = 10,
  });

  /// Reset to random position (no object allocation)
  void reset(Random random) {
    x = random.nextDouble();
    y = random.nextDouble();
    age = 0.0;
  }

  /// Check if particle has completed its lifecycle
  bool get isExpired => age >= 1.0;
}
```

**Design Decisions:**
- Mutable fields for in-place updates (no allocations)
- Normalized coordinates (0-1) for screen-size independence
- `reset()` method reuses object instead of creating new one

### 2. ParticleOverlay Widget (`lib/widgets/particle_overlay.dart`)

```dart
class ParticleOverlay extends StatefulWidget {
  /// Sky mask for filtering particles to sky region
  final SkyMask skyMask;

  /// Number of particles in pool (default 2000)
  final int particleCount;

  /// Fixed wind angle in radians (for this feature)
  final double windAngle;

  const ParticleOverlay({
    super.key,
    required this.skyMask,
    this.particleCount = 2000,
    this.windAngle = 0.0,  // Default: particles move right
  });
}

class _ParticleOverlayState extends State<ParticleOverlay>
    with SingleTickerProviderStateMixin {

  /// Pre-allocated particle pool (NO allocations in render loop)
  late List<Particle> _particles;

  /// Random number generator for particle resets
  late Random _random;

  /// Animation ticker for 60 FPS updates
  Ticker? _ticker;

  /// Last frame time for delta calculation
  Duration _lastFrameTime = Duration.zero;

  /// FPS tracking
  int _frameCount = 0;
  DateTime _lastFpsTime = DateTime.now();
  double _currentFps = 0;
}
```

**Key Implementation Details:**
- Pre-allocate entire particle pool in `initState()`
- Use Ticker (not Timer) for frame-synchronized updates
- Track FPS by counting frames over 1-second intervals
- Log "Rendering N particles at X FPS" per spec

### 3. ParticleOverlayPainter (`lib/widgets/particle_overlay.dart`)

```dart
class ParticleOverlayPainter extends CustomPainter {
  final List<Particle> particles;
  final SkyMask skyMask;
  final double windAngle;
  final Color color;

  /// Pre-allocated Paint objects (NO allocations in paint())
  final Paint _glowPaint = Paint()
    ..style = PaintingStyle.stroke
    ..strokeCap = StrokeCap.round
    ..strokeWidth = 4.0
    ..maskFilter = const MaskFilter.blur(BlurStyle.normal, 2.0);

  final Paint _corePaint = Paint()
    ..style = PaintingStyle.stroke
    ..strokeCap = StrokeCap.round
    ..strokeWidth = 1.5;
}
```

**Rendering Algorithm (paint method):**
```
for each particle in particles:
  if not skyMask.isPointInSky(p.x, p.y):
    continue  // Skip non-sky particles

  // Calculate opacity from age (fade in/out curve)
  baseOpacity = sin(p.age * pi).clamp(0.0, 1.0)

  // Convert normalized coords to screen coords
  startX = p.x * size.width
  startY = p.y * size.height

  // Calculate trail end point based on wind angle
  endX = startX - cos(windAngle) * p.trailLength
  endY = startY - sin(windAngle) * p.trailLength

  // PASS 1: Glow
  glowPaint.color = color.withOpacity(baseOpacity * 0.3)
  canvas.drawLine(start, end, glowPaint)

  // PASS 2: Core
  corePaint.color = color.withOpacity(baseOpacity * 0.9)
  canvas.drawLine(start, end, corePaint)
```

**shouldRepaint:** Always return `true` since particles animate every frame.

---

## Animation System Design

### Ticker Lifecycle

```
initState():
  1. Create particle pool (2000 particles)
  2. Randomize initial positions and ages (stagger lifecycle)
  3. Create Ticker
  4. Start Ticker

_onTick(Duration elapsed):
  1. Calculate delta time since last frame
  2. For each particle:
     a. age += delta * ageSpeed (0.3-0.5 per second)
     b. x += cos(windAngle) * speed * delta
     c. y += sin(windAngle) * speed * delta
     d. If expired OR off-screen: reset()
  3. Track FPS (frameCount++, log every second)
  4. setState() to trigger repaint

dispose():
  1. Stop and dispose Ticker
```

### Initial Particle Distribution

To avoid all particles appearing at once, stagger initial ages:
```dart
for (int i = 0; i < particleCount; i++) {
  particles.add(Particle(
    x: random.nextDouble(),
    y: random.nextDouble(),
    age: random.nextDouble(),  // Stagger ages 0-1
    trailLength: 10.0,
  ));
}
```

---

## Performance Considerations

### Critical: No Allocations in Render Loop

| Operation | Approach |
|-----------|----------|
| Particle positions | Update in-place, never create new Particle |
| Paint objects | Pre-allocate in painter constructor |
| Offset objects | Reuse or accept minimal allocation |
| List operations | No add/remove during animation |

### FPS Monitoring

```dart
void _updateFps() {
  _frameCount++;
  final now = DateTime.now();
  if (now.difference(_lastFpsTime).inMilliseconds >= 1000) {
    _currentFps = _frameCount.toDouble();
    debugPrint('Rendering ${widget.particleCount} particles at ${_currentFps.toStringAsFixed(0)} FPS');
    _frameCount = 0;
    _lastFpsTime = now;
  }
}
```

### Future: Adaptive Particle Count

(Not implemented in this feature, but designed for future):
```dart
if (_currentFps < 45 && _particleCount > 1000) {
  _particleCount = 1000;  // Reduce for better performance
}
```

---

## Integration with ARViewScreen

### Changes to ARViewScreen Stack

```dart
// In build() method, update Stack children:
Stack(
  children: [
    // Layer 1: Camera feed (existing)
    const CameraView(),

    // Layer 2: Particle overlay (NEW)
    ParticleOverlay(
      skyMask: _skyMask,
      windAngle: 0.0,  // Fixed for now, wind-animation feature adds real angle
    ),

    // Layer 3: Debug overlay (existing, update to show particles)
    Positioned(
      top: MediaQuery.of(context).padding.top + 16,
      left: 16,
      child: _buildDebugOverlay(),
    ),
  ],
),
```

### Debug Overlay Updates

Add particle count and FPS to debug overlay (optional enhancement):
- Could pass FPS value up via callback
- For now, FPS logged to console per spec requirements

---

## Testing Strategy

### Unit Tests (test/models/particle_test.dart)

| Test | Description |
|------|-------------|
| `creates with default values` | x=0, y=0, age=0, trailLength=10 |
| `creates with custom values` | All fields set correctly |
| `reset() randomizes position` | x and y become random values |
| `reset() resets age to 0` | age becomes 0.0 |
| `isExpired true when age >= 1.0` | Returns true at end of lifecycle |
| `isExpired false when age < 1.0` | Returns false during lifecycle |
| `position stays in 0-1 range after reset` | Normalized coords |

### Widget Tests (test/widgets/particle_overlay_test.dart)

| Test | Description |
|------|-------------|
| `creates with required parameters` | Builds without error |
| `respects particleCount parameter` | Correct number of particles |
| `uses CustomPaint widget` | Has CustomPaint in widget tree |
| `painter receives particle list` | Painter has access to particles |
| `painter receives sky mask` | Painter has access to SkyMask |
| `calls Ticker on frame` | Animation system working |

### Integration Tests (manual on device)

| Test | Expected Behavior |
|------|-------------------|
| Point at sky | Particles visible in sky region |
| Point at ground | No particles visible (skyFraction = 0) |
| Tilt up | Particles fill more of screen |
| Console output | "Rendering 2000 particles at 60 FPS" |
| Visual quality | Glow effect visible around particles |

---

## Implementation Notes

### Design Decisions Made

1. **Fixed wind angle for now** - Will be replaced in wind-animation feature
2. **White particles** - Will add altitude colors in altitude-depth feature
3. **Fixed trail length (10px)** - Will vary by wind speed in wind-animation
4. **Ticker over Timer** - Frame-synchronized for smooth animation
5. **Pre-allocation** - Critical for 60 FPS performance

### Patterns Used

1. **Strategy Pattern** - SkyMask interface allows different detection algorithms
2. **Object Pool** - Pre-allocated particle list, reset instead of recreate
3. **CustomPainter** - Efficient canvas rendering with shouldRepaint

### Trade-offs

| Decision | Benefit | Cost |
|----------|---------|------|
| Mutable Particle | No GC pressure | Less "pure" design |
| 2-pass rendering | Glow effect | 2x draw calls |
| Fixed pool size | No allocation | Can't dynamically grow |

---

## Non-Goals (Explicitly NOT Doing)

- Wind direction from real weather data (future: wind-animation feature)
- Altitude-based colors (future: altitude-depth feature)
- Parallax depth effects (future: altitude-depth feature)
- Adaptive particle count based on FPS (nice-to-have, not in spec)
- Touch interaction with particles
- Particle physics (gravity, turbulence)

---

## Risks and Mitigations

| Risk | Impact | Mitigation | Status |
|------|--------|------------|--------|
| GC stutter | Frame drops | Pre-allocate all objects | Designed |
| Too many draw calls | <60 FPS | 2-pass is acceptable per spec | Accepted |
| Sky mask overhead | Performance | O(1) check is negligible | Low risk |
| Ticker not firing | No animation | Use proper mixin lifecycle | Testing |

---

## Verification Checklist

After implementation, verify:

- [ ] Particles visible ONLY in sky region
- [ ] Particles stop at sky/ground boundary
- [ ] Glow effect visible (subtle blur around bright core)
- [ ] Console logs: "Rendering 2000 particles at X FPS"
- [ ] No visible frame drops or stutter
- [ ] `flutter analyze` passes with no errors
- [ ] All unit tests pass
- [ ] All widget tests pass
