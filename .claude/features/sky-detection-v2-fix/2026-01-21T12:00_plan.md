# Implementation Plan: BUG-002.5 - Sky Detection Not Working on Real Device

## Feature Metadata

| Field | Value |
|-------|-------|
| Feature | sky-detection-v2-fix |
| Type | Bug Fix |
| Created | 2026-01-21T12:00 |
| Status | Ready for Implementation |
| Based On | `.claude/active-work/sky-detection-v2-fix/diagnosis.md` |
| Severity | Critical |

---

## Problem Summary

The auto-calibrating sky detector requires users to point their phone at a 45-degree angle or higher to trigger calibration. However, users naturally view the sky at 20-40 degree angles. This causes:

1. Calibration never triggers during normal use
2. System stays in pitch-based fallback mode permanently
3. Color-based detection is effectively disabled
4. Particles only appear in a small portion at the top of the screen

---

## Architecture Overview

### Current Flow (Broken)

```
User points at sky (25-40 deg)
         |
         v
+---------------------+
| Check pitch >= 45?  |-----> NO (most cases)
+---------------------+         |
         |                      v
         | YES              +-------------------+
         v                  | Use pitch fallback|
+------------------+        | (small sky area)  |
| Sample sky colors|        +-------------------+
| from top 10-40%  |
+------------------+
         |
         v
+------------------+
| Color detection  |
| works at ANY     |
| pitch angle      |
+------------------+
```

### Fixed Flow

```
User points at sky (25+ deg)
         |
         v
+---------------------+
| Check pitch >= 25?  |-----> YES (natural viewing angle)
+---------------------+         |
         |                      v
         | NO               +-----------------------+
         v                  | Calculate sample      |
+-------------------+       | region based on pitch |
| Use pitch fallback|       | (more conservative    |
| (sky still visible|       |  at lower angles)     |
| at low angles)    |       +-----------------------+
+-------------------+               |
                                    v
                            +------------------+
                            | Sample sky colors|
                            | from safe region |
                            +------------------+
                                    |
                                    v
                            +------------------+
                            | Color detection  |
                            | works at ANY     |
                            | pitch angle      |
                            +------------------+
```

---

## Tech Stack (No Changes)

- Flutter 3.x / Dart
- Existing `camera` package for frame access
- Existing HSV color processing utilities

---

## File Structure

### Files to Modify

| File | Changes | Lines |
|------|---------|-------|
| `lib/services/sky_detection/auto_calibrating_sky_detector.dart` | Lower threshold, dynamic sample region | 46-52, new method |
| `test/services/sky_detection/auto_calibrating_sky_detector_test.dart` | Update tests for new threshold, add tests | Throughout |

### No New Files Required

This is a focused bug fix - all changes are within existing files.

---

## Component Changes

### 1. Lower Calibration Threshold

**File:** `lib/services/sky_detection/auto_calibrating_sky_detector.dart`
**Line:** 46

**Before:**
```dart
static const double calibrationPitchThreshold = 45.0;
```

**After:**
```dart
static const double calibrationPitchThreshold = 25.0;
```

**Rationale:** 25 degrees is a natural sky-viewing angle. Users typically look at 20-40 degrees when viewing the sky. This change allows calibration to trigger during normal use.

### 2. Dynamic Sample Region Based on Pitch

**Current behavior:** Fixed sample region (top 10-40% of frame)

**New behavior:** Dynamic sample region that adjusts based on pitch angle:
- Higher pitch (60+): Sample larger region (top 5-50%) - more sky visible
- Moderate pitch (45-59): Sample medium region (top 5-40%) - current behavior
- Lower pitch (25-44): Sample conservative region (top 5-25%) - avoid buildings

**Implementation:** Add a method to calculate dynamic sample region bounds:

```dart
/// Calculates the sample region bottom boundary based on current pitch.
///
/// At lower pitch angles, we sample more conservatively (smaller region)
/// to avoid accidentally sampling buildings/trees near the horizon.
/// At higher pitch angles, we can sample more aggressively.
///
/// Returns the bottom boundary as a fraction of frame height (0.0-1.0).
double _getSampleRegionBottom() {
  if (_pitch >= 60) return 0.50;  // Looking quite high - sample 5-50%
  if (_pitch >= 45) return 0.40;  // Original behavior - sample 5-40%
  if (_pitch >= 35) return 0.30;  // Moderate angle - sample 5-30%
  return 0.20;                     // Low angle (25-34) - sample 5-20%
}
```

**Why this is safe:** At lower pitch angles, the top portion of the frame is more likely to be pure sky. Buildings and trees typically occupy the middle and lower portions. By sampling only the top 5-20% at lower angles, we reduce the risk of contaminating the sky color profile.

### 3. Update Sample Region Top (Minor Adjustment)

**Current:** `sampleRegionTop = 0.1` (start at 10%)

**New:** `sampleRegionTop = 0.05` (start at 5%)

**Rationale:** At lower pitch angles, the very top of the frame is the safest sky region. Starting at 5% gives us a bit more safe sky samples while staying away from edge artifacts.

### 4. Update Calibration Method to Use Dynamic Region

**File:** `lib/services/sky_detection/auto_calibrating_sky_detector.dart`
**Methods:** `_calibrateFromFrame`, `_samplePixelsBGRA`, `_samplePixelsYUV`

These methods currently use the static `sampleRegionBottom` constant. They need to call the new `_getSampleRegionBottom()` method instead.

---

## Testing Strategy

### Unit Tests (TDD - Write First)

| Test | Description |
|------|-------------|
| `calibration threshold is 25 degrees` | Verify constant change |
| `sample region top is 5%` | Verify constant change |
| `getSampleRegionBottom returns 0.20 for pitch 25-34` | Test dynamic calculation |
| `getSampleRegionBottom returns 0.30 for pitch 35-44` | Test dynamic calculation |
| `getSampleRegionBottom returns 0.40 for pitch 45-59` | Test dynamic calculation |
| `getSampleRegionBottom returns 0.50 for pitch 60+` | Test dynamic calculation |
| `calibration can trigger at 25 degree pitch` | Integration test |

### Update Existing Tests

| Test | Required Change |
|------|-----------------|
| `calibration threshold is 45 degrees` | Change expected value to 25 |
| `sample region top is 10%` | Change expected value to 5% |
| `sample region bottom is 40%` | Remove or modify (now dynamic) |

### Real Device Testing (Manual)

| Scenario | Expected Result |
|----------|-----------------|
| Point at sky at 25-30 degrees | Calibration triggers, "Sky Cal: Yes" in debug |
| Point at sky at 35-40 degrees | Calibration triggers with slightly larger sample region |
| Pan around after calibration | Particles appear correctly in sky regions |
| Point at buildings | No false sky detection |
| Sunset/overcast conditions | Calibration still works with varied sky colors |

---

## Implementation Notes

### Decisions Made

1. **Threshold of 25 degrees chosen** because:
   - 20 degrees is too close to level viewing (risk of sampling non-sky)
   - 30 degrees would miss some natural viewing angles
   - 25 degrees provides a good balance

2. **Dynamic sample region** instead of fixed smaller region because:
   - At higher angles, larger sample gives better color statistics
   - At lower angles, conservative sampling prevents contamination
   - This adapts to user behavior rather than forcing specific angles

3. **No UI changes** because:
   - Debug panel already shows "Sky Cal: Yes/No"
   - Adding user prompts could be annoying
   - If calibration works at natural angles, no prompting needed

### Patterns Used

- **Progressive enhancement:** At low angles, sample conservatively. At high angles, sample more.
- **Graceful degradation:** If calibration fails, pitch-based fallback still works.

### Trade-offs

| Trade-off | Decision | Rationale |
|-----------|----------|-----------|
| Risk of sampling buildings at low angles | Mitigated by conservative sampling | Top 5-20% at low angles is safe |
| Potential for poor calibration | Acceptable | Recalibration happens every 5 min |
| Complexity vs simplicity | Added one method | Minimal complexity for significant gain |

---

## Non-Goals (Explicitly NOT Doing)

1. **Not adding visual calibration feedback** - The fix should make calibration automatic
2. **Not changing pitch-based fallback thresholds** - Those work correctly
3. **Not adding ML-based detection** - Out of scope for this bug fix
4. **Not changing recalibration interval** - 5 minutes is appropriate
5. **Not modifying the HSV histogram algorithm** - It works once calibrated

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Sampling buildings at low angles | Low | Medium | Conservative sample region (top 5-20%) |
| Calibration with mixed sky/building | Low | Low | Histogram averaging handles some noise |
| Performance impact | Very Low | Low | No additional per-frame computation |

---

## Success Criteria

1. Calibration triggers at pitch angles >= 25 degrees
2. "Sky Cal: Yes" appears in debug panel during normal sky viewing
3. Particles appear correctly in sky regions after calibration
4. No false positives (particles in building/tree areas)
5. All existing tests pass (with updated expected values)
6. New tests for dynamic sample region pass

---

## Estimated Complexity

- **Code Changes:** ~30 lines modified, ~15 lines added
- **Test Changes:** ~10 lines modified, ~25 lines added
- **Effort:** 1-2 hours
- **Risk:** Low (isolated changes, good fallback behavior)

---

## Handoff to Implement Agent

This plan is ready for implementation. The Implement Agent should:

1. Write tests first (TDD) for new threshold and dynamic sample region
2. Implement the constant changes
3. Implement the `_getSampleRegionBottom()` method
4. Update the sampling methods to use dynamic region
5. Update existing tests with new expected values
6. Verify all tests pass
7. Test on real device if available
