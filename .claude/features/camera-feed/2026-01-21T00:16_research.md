# Research: camera-feed

## Metadata
- **Feature:** camera-feed
- **Created:** 2026-01-21T00:16
- **Status:** research-complete

## Requirements from Spec

From `ROADMAP.md` Feature 1 and `WIND_LENS_MVP_SPEC.md`:

### What to Build
- Camera preview widget (`camera_view.dart`)
- Camera initialization service
- Handle camera permissions
- Display live camera feed as background

### Acceptance Criteria
- [ ] Camera feed displays on real device
- [ ] Handles permission denied gracefully
- [ ] Logs: "Camera initialized, resolution: WxH"

### From MVP Spec Phase 1, Step 2
- Implement `camera_view.dart`
- Request camera permissions
- Display fullscreen camera preview
- **MUST use real device** - simulator has no camera

## Existing Code Analysis

### Current State
- Project created at `/workspace/wind_lens`
- `camera: ^0.11.3` dependency already in pubspec.yaml
- iOS/Android permissions already configured in project-setup
- `lib/main.dart` contains default Flutter counter app template
- No `lib/widgets/`, `lib/services/`, or `lib/screens/` directories exist yet

### Architecture from Spec
```
lib/
├── widgets/
│   └── camera_view.dart          # Camera preview widget
├── services/
│   └── (camera service logic)
└── screens/
    └── ar_view_screen.dart       # Main screen composing all widgets
```

### Camera Package Usage Pattern (from spec context)
The spec shows `CameraPreview` widget with `onFrame` callback:
```dart
CameraPreview(onFrame: onCameraFrame),
```

This suggests:
- Widget handles camera initialization internally
- Exposes frame callback for processing (sky detection later)
- Should be fullscreen background

## Technical Constraints

From CLAUDE.md:
- **MUST test on real device** - iOS simulator has no camera
- Camera package: `camera: ^0.11.3`
- iOS permissions already configured: NSCameraUsageDescription
- Android permissions already configured: CAMERA permission

### Performance Targets
- Camera should initialize quickly
- Frame callback should not block UI
- Resolution: Use device's native resolution (log it)

## Open Questions

All resolved:
- [x] Where to put camera code? → `lib/widgets/camera_view.dart` + `lib/screens/ar_view_screen.dart`
- [x] How to handle permissions? → Use camera package's built-in permission handling
- [x] What resolution to use? → Use high resolution preset (will be needed for sky detection)
- [x] Frame callback needed? → Yes, for future sky detection integration

## Recommended Approach

### 1. Create Directory Structure
```
lib/
├── main.dart              # Update to use AR view
├── widgets/
│   └── camera_view.dart   # Camera preview widget
└── screens/
    └── ar_view_screen.dart # Main AR screen
```

### 2. Implement CameraView Widget
- StatefulWidget with camera lifecycle management
- Initialize camera on initState
- Dispose camera on dispose
- Handle permission errors gracefully
- Expose optional `onFrame` callback for future sky detection
- Use `CameraPreview` from camera package
- Log resolution on initialization

### 3. Implement ARViewScreen
- Simple screen that displays CameraView fullscreen
- Will later add particle overlay and other widgets
- Dark theme / no app bar (fullscreen AR experience)

### 4. Update main.dart
- Replace counter app with ARViewScreen
- Set up dark theme
- Remove debug banner

### 5. Camera Configuration
- Use back camera (for pointing at sky)
- High resolution preset
- Enable image stream for frame processing (future)

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Camera permission denied | App unusable | Show friendly error message with settings link |
| No camera available | App crashes | Check availableCameras() first, show error if empty |
| Camera fails to initialize | Black screen | Catch errors, show retry option |
| Testing limitations | Can't verify on simulator | Document as "requires real device testing" |

## Dependencies

- **Depends on:** `project-setup` (complete)
- **Required by:** `sky-detection`, `particle-system` (camera frames needed)

## Code Patterns to Follow

### Camera Initialization Pattern
```dart
late CameraController _controller;
bool _isInitialized = false;

Future<void> _initCamera() async {
  final cameras = await availableCameras();
  if (cameras.isEmpty) {
    // Handle no camera
    return;
  }

  _controller = CameraController(
    cameras.first,  // Back camera
    ResolutionPreset.high,
    enableAudio: false,
  );

  await _controller.initialize();
  print('Camera initialized, resolution: ${_controller.value.previewSize}');
  setState(() => _isInitialized = true);
}
```

### Permission Handling
The camera package handles permissions automatically on initialize().
Catch `CameraException` for permission denied cases.

## Next Step

Run `/plan camera-feed` to design detailed implementation.
