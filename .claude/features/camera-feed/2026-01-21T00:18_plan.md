# Implementation Plan: camera-feed

## Metadata
- **Feature:** camera-feed
- **Created:** 2026-01-21T00:18
- **Status:** plan-complete
- **Based On:** 2026-01-21T00:16_research.md

---

## Architecture Overview

```
+------------------------------------------+
|              WindLensApp                 |
|  (MaterialApp with dark theme)           |
+------------------------------------------+
                    |
                    v
+------------------------------------------+
|            ARViewScreen                  |
|  (Scaffold, fullscreen, no app bar)      |
+------------------------------------------+
                    |
                    v
+------------------------------------------+
|             CameraView                   |
|  (StatefulWidget with lifecycle mgmt)    |
|                                          |
|  States:                                 |
|  - loading: CircularProgressIndicator    |
|  - error: Error message with icon        |
|  - ready: CameraPreview (fullscreen)     |
|                                          |
|  Callbacks:                              |
|  - onFrame(CameraImage)? (optional)      |
+------------------------------------------+
```

### Data Flow

```
App Start
    |
    v
ARViewScreen mounted
    |
    v
CameraView.initState()
    |
    v
_initCamera() async
    |
    +---> availableCameras()
    |         |
    |         +---> Empty? --> Show "No camera" error
    |         |
    |         v
    |     Find back camera (or use first)
    |         |
    |         v
    +---> CameraController(
    |       camera,
    |       ResolutionPreset.high,
    |       enableAudio: false
    |     )
    |         |
    |         v
    +---> controller.initialize()
    |         |
    |         +---> CameraException? --> Show permission error
    |         |
    |         v
    +---> Log: "Camera initialized, resolution: WxH"
    |         |
    |         v
    +---> setState(_isInitialized = true)
              |
              v
          CameraPreview displayed
```

---

## Tech Stack

| Component | Technology | Notes |
|-----------|------------|-------|
| Camera | `camera: ^0.11.3` | Already in pubspec.yaml |
| State Management | StatefulWidget | Simple local state for camera lifecycle |
| UI Framework | Flutter Material | Dark theme for AR experience |

---

## File Structure

### New Files to Create

| File | Purpose |
|------|---------|
| `lib/widgets/camera_view.dart` | Camera preview widget with lifecycle management |
| `lib/screens/ar_view_screen.dart` | Main AR screen, composes camera + future overlays |
| `test/widgets/camera_view_test.dart` | Unit tests for CameraView widget |
| `test/screens/ar_view_screen_test.dart` | Unit tests for ARViewScreen |

### Files to Modify

| File | Changes | Line Numbers |
|------|---------|--------------|
| `lib/main.dart` | Replace counter app with ARViewScreen, set dark theme, remove debug banner | Lines 1-122 (full rewrite) |

### Directory Structure After Implementation

```
lib/
├── main.dart                    # MODIFIED: WindLensApp with ARViewScreen
├── widgets/
│   └── camera_view.dart         # NEW: Camera preview widget
└── screens/
    └── ar_view_screen.dart      # NEW: Main AR screen

test/
├── widgets/
│   └── camera_view_test.dart    # NEW: CameraView tests
└── screens/
    └── ar_view_screen_test.dart # NEW: ARViewScreen tests
```

---

## Component Architecture

### CameraView Widget

```dart
class CameraView extends StatefulWidget {
  /// Optional callback for processing camera frames
  /// Used by sky detection in future features
  final void Function(CameraImage image)? onFrame;

  const CameraView({super.key, this.onFrame});

  @override
  State<CameraView> createState() => _CameraViewState();
}

class _CameraViewState extends State<CameraView> with WidgetsBindingObserver {
  CameraController? _controller;
  bool _isInitialized = false;
  String? _errorMessage;

  @override
  void initState() { /* ... */ }

  @override
  void dispose() { /* ... */ }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) { /* ... */ }

  Future<void> _initCamera() async { /* ... */ }

  @override
  Widget build(BuildContext context) { /* ... */ }
}
```

### State Management

| State | Type | Description |
|-------|------|-------------|
| `_controller` | `CameraController?` | Camera controller instance |
| `_isInitialized` | `bool` | Whether camera is ready |
| `_errorMessage` | `String?` | Error message if initialization failed |

### Lifecycle Handling

| Event | Action |
|-------|--------|
| `initState` | Start camera initialization, add lifecycle observer |
| `dispose` | Dispose controller, remove lifecycle observer |
| App paused | Dispose controller (free resources) |
| App resumed | Reinitialize camera |

---

## Testing Strategy

### Unit Tests (4 tests)

| Test | Description |
|------|-------------|
| `CameraView shows loading indicator initially` | Verify CircularProgressIndicator shown before init |
| `CameraView shows error when no camera available` | Mock empty camera list, verify error UI |
| `CameraView shows error on permission denied` | Mock CameraException, verify error UI |
| `ARViewScreen renders without crashing` | Basic smoke test for screen widget |

### Integration Tests (Manual - Real Device Required)

| Test | Description |
|------|-------------|
| Camera displays on iOS device | Run on physical iPhone, verify camera feed |
| Camera displays on Android device | Run on physical Android, verify camera feed |
| Permission denied flow | Deny permission, verify friendly error message |
| App backgrounding | Background and resume app, verify camera reinitializes |

### Test Mocking Strategy

Since camera requires real device, tests will:
1. Mock `availableCameras()` to return empty list or test cameras
2. Mock `CameraController` to simulate initialization states
3. Use `TestWidgetsFlutterBinding` for widget tests

---

## Implementation Notes

### Decisions Made

1. **Back camera selection**: Use `cameras.firstWhere((c) => c.lensDirection == CameraLensDirection.back, orElse: () => cameras.first)` to prefer back camera but fall back gracefully.

2. **Resolution preset**: Use `ResolutionPreset.high` for future sky detection quality, not `max` to avoid performance issues.

3. **Audio disabled**: Set `enableAudio: false` since we only need video for wind visualization.

4. **onFrame callback optional**: Make it optional so camera works standalone now, ready for sky detection later.

5. **WidgetsBindingObserver**: Use lifecycle observer to properly handle app backgrounding (iOS requirement).

### Patterns to Follow

```dart
// Camera initialization with error handling
try {
  await _controller!.initialize();
  debugPrint('Camera initialized, resolution: ${_controller!.value.previewSize}');
} on CameraException catch (e) {
  setState(() => _errorMessage = _getErrorMessage(e.code));
}

// Error message mapping
String _getErrorMessage(String code) {
  switch (code) {
    case 'CameraAccessDenied':
    case 'CameraAccessDeniedWithoutPrompt':
      return 'Camera permission denied. Please enable in Settings.';
    case 'CameraAccessRestricted':
      return 'Camera access restricted on this device.';
    default:
      return 'Failed to initialize camera: $code';
  }
}
```

### Trade-offs

| Trade-off | Decision | Rationale |
|-----------|----------|-----------|
| Resolution vs Performance | High (not Max) | Balance quality for sky detection with performance |
| Eager vs Lazy init | Eager in initState | Camera is core feature, start immediately |
| Image stream | Disabled initially | Enable only when onFrame callback provided |

---

## Non-Goals

The following are explicitly NOT part of this feature:

1. Sky detection logic (future feature)
2. Image stream processing (added when needed)
3. Camera settings UI (zoom, focus, etc.)
4. Photo/video capture
5. Camera switching (front/back toggle)
6. Orientation handling (portrait only for MVP)

---

## Dependencies

### Upstream Dependencies
- `project-setup` (complete) - Project structure, pubspec.yaml with camera dependency

### Downstream Dependencies
- `sky-detection` - Will use CameraView's onFrame callback
- `particle-system` - Will overlay on CameraView

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Cannot test on simulator | Certain | Medium | Document real device requirement, basic smoke tests |
| Camera permission denied | Medium | High | Friendly error message, instructions for Settings |
| Camera init fails on some devices | Low | High | Robust error handling, fallback messages |
| Memory leak on lifecycle events | Medium | Medium | Proper dispose, WidgetsBindingObserver |

---

## Verification Checklist

After implementation, verify:

- [ ] `flutter analyze` passes with no errors
- [ ] `flutter test` passes all unit tests
- [ ] On real device: camera feed displays fullscreen
- [ ] On real device: console shows "Camera initialized, resolution: WxH"
- [ ] Permission denied shows friendly error message
- [ ] App backgrounding/resuming works correctly
