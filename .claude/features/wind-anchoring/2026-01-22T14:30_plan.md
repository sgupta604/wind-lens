# Implementation Plan: Wind Animation World-Fixed Anchoring (BUG-004)

## Feature Metadata

| Field | Value |
|-------|-------|
| Feature | wind-anchoring |
| Type | Bug Fix |
| Timestamp | 2026-01-22T14:30 |
| Status | planned |
| Based On | `.claude/active-work/wind-anchoring/diagnosis.md` |
| Priority | High |
| Estimated Effort | 1-2 hours |

## Problem Statement

Particles at different altitude levels have inconsistent world-anchoring behavior:
- **Surface (parallax 1.0):** 100% world-fixed (correct)
- **Mid-level (parallax 0.6):** Only 60% world-fixed (broken)
- **Jet stream (parallax 0.3):** Only 30% world-fixed (broken)

This causes higher-altitude particles to feel "stuck to the screen" rather than fixed in world space, breaking the AR illusion.

## Root Cause

The current implementation conflates two distinct concepts:

1. **World Anchoring:** How much particles stay fixed in real-world space when phone rotates
2. **Parallax Depth:** Subtle additional shift to create 3D depth perception

Currently, `parallaxFactor` controls BOTH:
```dart
// Current broken implementation (line 266)
p.x -= (headingDelta / 360.0) * parallaxFactor;
```

This means jet stream particles (parallax 0.3) only shift 30% as much as they should when the phone rotates.

## Solution Architecture

### Conceptual Model

```
                        CURRENT (BROKEN)
                        +----------------+
                        |  parallaxFactor |
                        |    (0.3-1.0)   |
                        +--------+-------+
                                 |
                                 v
                        World Anchoring
                        (inconsistent)


                        FIXED (CORRECT)
                        +----------------+
                        | worldAnchoring |
                        |     = 1.0      |
                        +--------+-------+
                                 |
                                 v
                        +----------------+
                        | parallaxDepth  |
                        |  (0.0-0.1)     |<-- subtle secondary effect
                        +--------+-------+
                                 |
                                 v
                        Particle Position
                        (world-fixed + depth)
```

### Mathematical Fix

**Before (broken):**
```dart
p.x -= (headingDelta / 360.0) * parallaxFactor;
// 90 degree rotation results:
// - Surface:   -0.25 * 1.0 = -0.25 (25% shift - correct)
// - Mid-level: -0.25 * 0.6 = -0.15 (15% shift - wrong)
// - Jet stream: -0.25 * 0.3 = -0.075 (7.5% shift - wrong)
```

**After (fixed):**
```dart
// Primary: 100% world anchoring for ALL altitudes
p.x -= (headingDelta / 360.0) * 1.0;

// Secondary: Subtle parallax depth effect (optional)
// Higher altitude = further away = slightly less parallax shift
// This is a SMALL additional effect (0-10% of heading delta)
final parallaxDepthOffset = (1.0 - parallaxFactor) * 0.1;
p.x -= (headingDelta / 360.0) * parallaxDepthOffset;

// 90 degree rotation results:
// - Surface:   -0.25 - (-0.25 * 0.0 * 0.1) = -0.25 (25% shift)
// - Mid-level: -0.25 - (-0.25 * 0.4 * 0.1) = -0.26 (26% shift)
// - Jet stream: -0.25 - (-0.25 * 0.7 * 0.1) = -0.268 (26.8% shift)
```

Wait - the parallax depth formula above would make distant objects shift MORE, which is backwards. Let me correct:

**Correct parallax depth model:**
- Close objects (surface): shift most with phone rotation (full world anchor)
- Distant objects (jet stream): shift slightly less to create depth illusion

But this creates a conflict: we want 100% world anchoring, yet also want depth perception.

### Resolution: Two-Stage Approach

**Option A (Recommended): Full World Anchoring, No Secondary Parallax**

The simplest fix - all particles are 100% world-fixed:
```dart
// All altitudes shift identically - full world anchoring
p.x -= (headingDelta / 360.0);
```

The depth illusion comes from OTHER visual properties (already implemented):
- Particle color (white -> cyan -> purple)
- Trail length (trailScale: 1.0 -> 0.7 -> 0.5)
- Particle speed multiplier (1.0x -> 1.5x -> 3.0x)

**Option B: Full World Anchoring + Subtle Parallax**

If we want to ADD parallax depth:
```dart
// Primary: 100% world anchoring
p.x -= (headingDelta / 360.0);

// Secondary: Subtle parallax (close objects shift slightly more)
// parallaxFactor: surface=1.0, mid=0.6, jet=0.3
// Extra shift: surface=0.1, mid=0.06, jet=0.03
final extraParallax = parallaxFactor * 0.1;
p.x -= (headingDelta / 360.0) * extraParallax;
```

This gives:
- Surface: 25% + 2.5% = 27.5% shift per 90 degrees
- Mid-level: 25% + 1.5% = 26.5% shift
- Jet stream: 25% + 0.75% = 25.75% shift

The difference is subtle (2% max) but reinforces depth perception.

### Recommended Solution: Option A

**Rationale:**
1. Simpler implementation (one line change)
2. Matches spec exactly ("particles stay world-fixed")
3. Depth perception already achieved via color/size/speed
4. No risk of over-engineering a subtle effect
5. Easier to test and verify

## File Structure

### Files to Modify

| File | Location | Change |
|------|----------|--------|
| `lib/widgets/particle_overlay.dart` | Lines 264-266 | Fix world anchoring formula |
| `lib/models/altitude_level.dart` | Lines 84-98 | Update documentation |
| `test/widgets/particle_overlay_test.dart` | End of file | Add world anchoring tests |

### No New Files

This is a targeted bug fix - no new files required.

## Detailed Changes

### 1. particle_overlay.dart (Lines 262-266)

**Current Code:**
```dart
// Update all particles
for (final p in _particles) {
  // Apply parallax offset based on heading change
  // Higher altitude (lower parallax factor) = less movement when phone rotates
  p.x -= (headingDelta / 360.0) * parallaxFactor;
```

**New Code:**
```dart
// Update all particles
for (final p in _particles) {
  // WORLD ANCHORING: All particles are 100% anchored to world space
  // When phone rotates X degrees, particles shift X/360 of screen width
  // This makes particles appear fixed in the sky regardless of phone orientation
  // Spec: "Particles should appear to stay fixed in world space"
  p.x -= (headingDelta / 360.0);
```

**Optional Enhancement (if depth effect desired):**
```dart
  // Optional: Subtle parallax depth (close objects shift slightly more)
  // Disabled for now - depth achieved via color/size/speed instead
  // p.x -= (headingDelta / 360.0) * parallaxFactor * 0.1;
```

### 2. altitude_level.dart (Lines 84-98)

**Current Documentation (misleading):**
```dart
/// Parallax factor for creating depth perception.
///
/// Lower values = objects appear further away (less movement when rotating phone).
/// - surface: 1.0 (close, moves most when phone rotates)
/// - midLevel: 0.6 (moderate distance)
/// - jetStream: 0.3 (far away, barely moves when phone rotates)
```

**New Documentation:**
```dart
/// Parallax factor for visual depth effects.
///
/// Originally intended to control world-anchoring differential, but this was
/// found to break the AR illusion. Now used only for potential future depth
/// effects. All altitudes use 100% world anchoring.
///
/// Note: Depth perception is achieved through:
/// - Particle color (white -> cyan -> purple)
/// - Trail scale (1.0 -> 0.7 -> 0.5)
/// - Speed multiplier (1.0x -> 1.5x -> 3.0x)
///
/// Values retained for potential subtle parallax enhancement:
/// - surface: 1.0
/// - midLevel: 0.6
/// - jetStream: 0.3
```

### 3. particle_overlay_test.dart (New Tests)

Add a new test group for world anchoring verification:

```dart
group('ParticleOverlay World Anchoring', () {
  // Test 1: All altitude levels shift equally on heading change
  // Test 2: 90-degree rotation produces ~25% particle shift
  // Test 3: Heading wraparound (359 -> 1) handled correctly
});
```

## Testing Strategy

### Unit Tests (3 new tests)

1. **World anchoring consistency test**
   - Create overlays at each altitude level
   - Simulate 90-degree heading change
   - Verify all altitudes produce same shift amount

2. **World anchoring magnitude test**
   - Simulate 360-degree rotation
   - Verify particles shift ~100% of screen width

3. **Heading wraparound test**
   - Test 359 -> 1 degree transition
   - Verify correct 2-degree delta (not 358-degree jump)

### Manual Verification (Real Device)

1. Point phone at sky
2. Rotate phone 90 degrees clockwise
3. Verify ALL particles (all altitudes) shift equally left
4. Verify particles don't feel "stuck to screen"

## Implementation Notes

### What Changes
- Line 266 in particle_overlay.dart: Remove `* parallaxFactor`
- Documentation in altitude_level.dart: Clarify parallaxFactor is no longer used for anchoring

### What Doesn't Change
- parallaxFactor property retained (for potential future use)
- All other particle behavior (wind direction, speed, color, trails)
- Wind direction calculation (already correct)

### Performance Impact
- None: Same number of operations, just simpler formula

### Backward Compatibility
- Fully backward compatible (widget API unchanged)

## Non-Goals

1. **ML-based depth perception** - Out of scope for this bug fix
2. **Stereo/3D rendering** - Not part of MVP
3. **Real-world coordinate mapping** - Would require GPS/SLAM
4. **Altitude-specific wind layers** - Separate feature

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Fix breaks visual depth | Low | Medium | Other depth cues (color/size) remain |
| Incorrect formula | Low | High | Test with 90-degree rotation |
| Performance regression | Very Low | Low | Formula simplified, not complicated |

## Success Criteria

1. [ ] All altitude levels shift equally when phone rotates
2. [ ] 90-degree rotation produces ~25% screen shift
3. [ ] Particles feel "fixed in sky" not "stuck to screen"
4. [ ] All existing tests pass
5. [ ] New world-anchoring tests pass
6. [ ] Manual verification on real device confirms fix

## References

- MVP Spec Section 11: Compass Integration
- Diagnosis Report: `.claude/active-work/wind-anchoring/diagnosis.md`
- Issue: BUG-004 Wind Animation Not World-Fixed
