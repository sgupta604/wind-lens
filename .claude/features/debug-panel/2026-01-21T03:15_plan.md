# Plan: BUG-001 Debug Panel Toggle Fix

## Metadata
- **Feature:** debug-panel
- **Type:** Bug Fix
- **Created:** 2026-01-21T03:15
- **Status:** planning-complete
- **Based-on:** `.claude/active-work/debug-panel/diagnosis.md`

## Problem Summary

The debug panel implementation is complete and correct, but the 3-finger tap gesture using `onScaleStart` does not work reliably on real iOS/Android devices because:

1. `onScaleStart` requires finger movement to trigger (a tap without movement may not fire)
2. iOS system gestures (3-finger undo/copy/paste) intercept the touch
3. Nested GestureDetectors may cause gesture arena conflicts

## Solution Overview

Add a small, semi-transparent "DBG" toggle button in the top-left corner as the primary debug panel trigger. Keep the existing 3-finger gesture as a secondary (power user) option.

## Architecture

```
+----------------------------------+
| [DBG]                            |  <-- NEW: Toggle button (top-left)
| +----------------+               |
| | Debug Panel    | (when shown)  |
| | Heading: 127.3 |               |
| | Pitch: 12.5    |               |
| | ...            |               |
| +----------------+               |
|                                  |
|     [Camera + Particles]         |
|                                  |
|                           [Slider]
|  +-------------------------+     |
|  | Info Bar               |      |
|  +-------------------------+     |
+----------------------------------+
```

### Widget Tree (Updated)

```
ARViewScreen
├── GestureDetector (3-finger tap - keep for power users)
│   └── Stack
│       ├── CameraView
│       ├── ParticleOverlay
│       ├── _buildDebugToggleButton()  <-- NEW
│       ├── if (_showDebugPanel) _buildDebugPanel()
│       ├── AltitudeSlider
│       └── InfoBar
```

## Tech Stack

No new dependencies. Uses existing Flutter widgets:
- `GestureDetector` with `onTap`
- `Container` with glassmorphism styling
- `Text` widget

## File Changes

### Files to Modify

| File | Changes | Lines |
|------|---------|-------|
| `lib/screens/ar_view_screen.dart` | Add debug toggle button, extract to method | ~25 lines added |
| `test/screens/ar_view_screen_test.dart` | Add tests for toggle button | ~30 lines added |

### No New Files Required

This is a minimal bug fix. All changes fit within the existing `ar_view_screen.dart` file.

## Component Details

### Debug Toggle Button

**Location:** Top-left corner, below safe area
**Size:** 40x40 pixels (minimum touch target)
**Style:** Semi-transparent background matching debug panel style
**Content:** "DBG" text, monospace font

```dart
Widget _buildDebugToggleButton() {
  return Positioned(
    top: MediaQuery.of(context).padding.top + 8,
    left: 8,
    child: GestureDetector(
      onTap: _toggleDebugPanel,
      child: Container(
        width: 40,
        height: 40,
        decoration: BoxDecoration(
          color: Colors.black.withOpacity(0.4),
          borderRadius: BorderRadius.circular(8),
        ),
        alignment: Alignment.center,
        child: const Text(
          'DBG',
          style: TextStyle(
            color: Colors.white70,
            fontSize: 12,
            fontWeight: FontWeight.w600,
            fontFamily: 'monospace',
          ),
        ),
      ),
    ),
  );
}
```

### Position Adjustment for Debug Panel

When debug panel is shown, it should be positioned below the toggle button to avoid overlap:
- Toggle button: `top: safeAreaTop + 8`
- Debug panel: `top: safeAreaTop + 56` (8 + 40 + 8 spacing)

## Testing Strategy

### Unit Tests (3 tests)

1. **Toggle button visible on screen**
   - Verify "DBG" text is present
   - Verify button is tappable

2. **Toggle button shows debug panel on tap**
   - Tap the DBG button
   - Verify debug panel content appears (Heading, Pitch, etc.)

3. **Toggle button hides debug panel on second tap**
   - Tap to show, tap again to hide
   - Verify debug panel content disappears

### Manual Device Testing

1. Run on real iOS device
2. Tap DBG button - verify panel appears with haptic feedback
3. Tap again - verify panel hides
4. Verify all 7 metrics display correctly

## Implementation Notes

### Design Decisions

1. **Button text "DBG" over icon:** Simpler, no asset dependencies, clearly indicates debug function
2. **Semi-transparent style:** Matches existing debug panel and altitude slider glassmorphism
3. **Keep 3-finger gesture:** No code removal, maintains backward compatibility for users who learned it
4. **40x40 size:** Meets iOS Human Interface Guidelines minimum touch target (44x44 recommended, 40 acceptable for utility controls)

### Code Patterns to Follow

From existing `ar_view_screen.dart`:
- Use `_buildXXX()` pattern for widget methods (e.g., `_buildDebugToggleButton()`)
- Use `MediaQuery.of(context).padding.top` for safe area
- Use `Colors.black.withOpacity()` for semi-transparent backgrounds
- Use `const` constructors where possible

### Non-Goals

- NOT changing the debug panel content or styling
- NOT removing the 3-finger gesture (keeping as secondary option)
- NOT adding settings/preferences for toggle method
- NOT adding long-press as alternative (button is simpler)

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Button obscures camera content | Low | Small size, semi-transparent, positioned in corner |
| Accidental taps | Low | Button is small and in corner, not in primary interaction area |
| Button not discoverable | Medium | Developers know to look for it; can document in README |

## Quality Gates

Before marking complete:
- [ ] DBG button renders in top-left corner
- [ ] Tapping button toggles debug panel
- [ ] Haptic feedback works on tap
- [ ] All 7 debug metrics display correctly
- [ ] Existing 3-finger gesture still works (if it ever did)
- [ ] All unit tests pass
- [ ] flutter analyze passes with no issues
- [ ] Tested on real iOS device

## Success Criteria

1. Debug panel can be reliably toggled on real devices
2. Toggle method is obvious and reliable (button tap)
3. No regression to existing functionality
4. All tests pass
