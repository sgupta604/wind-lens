# Research: polish

## Metadata
- **Feature:** polish
- **Created:** 2026-01-21T02:45
- **Status:** research-complete

## Requirements from Spec

From `ROADMAP.md` Feature 7 and `WIND_LENS_MVP_SPEC.md`:

### What to Build
- Debug panel (toggle visibility)
  - Show FPS, particle count, heading, pitch, sky fraction
- Loading states
- Error handling UI
- Haptic feedback (optional)
- Performance auto-tuning (reduce particles if <45 FPS)

### Acceptance Criteria
- [ ] Debug panel shows all metrics
- [ ] App handles errors gracefully
- [ ] Performance stays above 45 FPS
- [ ] Clean, polished UI

## From MVP Spec Section 10 - Debug Panel

### Debug Panel (Dev Only)
- Toggle with 3-finger tap
- Shows:
  - Raw compass heading (degrees)
  - Raw u/v components
  - Particle count
  - FPS counter
  - Device orientation

## From MVP Spec Section 9 - Performance Targets

### Adaptive Performance System
```dart
class PerformanceManager {
  int _particleCount = 2000;  // Start optimistic
  final List<double> _recentFps = [];
  static const int _fpsWindowSize = 30;  // Average over 30 frames

  int get particleCount => _particleCount;

  void recordFrame(Duration frameDuration) {
    double fps = 1000 / frameDuration.inMilliseconds.clamp(1, 1000);
    _recentFps.add(fps);

    if (_recentFps.length > _fpsWindowSize) {
      _recentFps.removeAt(0);
    }

    // Only adjust after we have enough samples
    if (_recentFps.length == _fpsWindowSize) {
      double avgFps = _recentFps.reduce((a, b) => a + b) / _fpsWindowSize;
      _adjustParticleCount(avgFps);
    }
  }

  void _adjustParticleCount(double avgFps) {
    if (avgFps < 45 && _particleCount > 500) {
      // Performance struggling, reduce particles
      _particleCount = (_particleCount * 0.7).round().clamp(500, 3000);
      _recentFps.clear();  // Reset window after adjustment
    } else if (avgFps > 58 && _particleCount < 2000) {
      // Room for more particles, slowly increase
      _particleCount = (_particleCount * 1.1).round().clamp(500, 3000);
      _recentFps.clear();
    }
  }
}
```

**Philosophy:** Better to have 800 smooth particles than 2000 choppy ones.

### Performance Targets
| Metric | Target | Fallback |
|--------|--------|----------|
| Particle count | 2000 | Auto-reduce to 1000 if <45fps |
| Frame rate | 60 fps | Acceptable at 30fps |
| Trail segments | 1 (simple line) | Could add more for smoothness |

## From MVP Spec Section 10 - Info Bar

### Info Bar (User-facing)
- Position: Bottom, above safe area
- Style: Frosted glass, rounded corners
- Content:
  - Compass direction indicator (small)
  - Wind speed in m/s (large text)
  - Wind cardinal direction (NW, SSE, etc.)
  - Current altitude level name

## Existing Code Analysis

### Current State
- Project at `/workspace/wind_lens`
- Debug overlay exists in ARViewScreen (top-left)
  - Shows: Heading, Pitch, Sky%, Altitude, Wind speed/direction
  - Always visible (no toggle yet)
- FPS logging exists in ParticleOverlay (to console, not on-screen)
- No PerformanceManager yet
- No error handling UI
- No loading states
- AltitudeSlider has haptic feedback (implemented in altitude-depth)

### What Needs to Change

1. **Debug Panel Toggle:** Add 3-finger tap to show/hide debug overlay
2. **FPS Display:** Move FPS from console log to debug overlay
3. **Performance Manager:** Create service for adaptive particle count
4. **Info Bar:** Create user-facing info bar at bottom
5. **Loading State:** Add loading indicator while camera initializes
6. **Error Handling:** Add error display for camera/sensor failures

### Architecture to Add
```
lib/
├── services/
│   └── performance_manager.dart    # Adaptive particle count
└── widgets/
    ├── debug_panel.dart            # Toggleable debug overlay
    └── info_bar.dart               # User-facing wind info
```

### Files to Modify
- `lib/widgets/particle_overlay.dart` - Use PerformanceManager particle count, expose FPS
- `lib/screens/ar_view_screen.dart` - Add 3-finger toggle, info bar, loading state
- `lib/widgets/camera_view.dart` - Add loading/error callbacks

## Technical Constraints

From CLAUDE.md and MVP Spec:
- **Performance:** Maintain above 45 FPS
- **No object allocation in render loop** - PerformanceManager must use pre-allocated list
- **3-finger tap gesture** - Use GestureDetector with required pointers
- **Graceful degradation** - Reduce particles automatically, don't crash

### FPS Calculation
Current FPS is logged every second in ParticleOverlay:
```dart
_frameCount++;
final now = DateTime.now();
if (now.difference(_lastFpsLog).inSeconds >= 1) {
  debugPrint('Rendering ${widget.particleCount} particles at $_frameCount FPS');
  _frameCount = 0;
  _lastFpsLog = now;
}
```

Need to expose FPS value to parent widget for debug panel.

## Open Questions

All resolved from spec:
- [x] Debug panel trigger? → 3-finger tap anywhere on screen
- [x] FPS averaging window? → 30 frames
- [x] Particle reduction threshold? → <45 FPS → reduce to 70%
- [x] Minimum particles? → 500
- [x] Info bar style? → Glassmorphism like altitude slider

## Recommended Approach

### 1. Create PerformanceManager Service
```dart
class PerformanceManager {
  int _particleCount = 2000;
  final List<double> _recentFps = [];
  static const int _fpsWindowSize = 30;
  double _currentFps = 60.0;

  int get particleCount => _particleCount;
  double get currentFps => _currentFps;

  void recordFrame(Duration elapsed, Duration lastElapsed) {
    final dt = elapsed - lastElapsed;
    final fps = dt.inMicroseconds > 0 ? 1000000 / dt.inMicroseconds : 60;
    _recentFps.add(fps.clamp(0, 120));
    // ... adjust particle count
  }
}
```

### 2. Create InfoBar Widget
```dart
class InfoBar extends StatelessWidget {
  final double windSpeed;
  final double windDirection;
  final AltitudeLevel altitude;

  // Glassmorphism, bottom of screen
  // Shows: Wind speed, cardinal direction, altitude level
}
```

### 3. Update ARViewScreen
- Add `_showDebugPanel` state (default false)
- Add GestureDetector for 3-finger tap
- Add InfoBar to Stack
- Add loading state while camera initializes
- Add error handling

### 4. Update ParticleOverlay
- Accept callback for FPS updates
- Use PerformanceManager's particle count
- Call PerformanceManager.recordFrame() each tick

### Architecture After Changes
```dart
ARViewScreen
├── GestureDetector (3-finger tap)
├── CameraView (with loading/error states)
├── ParticleOverlay (uses PerformanceManager)
├── DebugPanel (toggleable, top-left)
├── AltitudeSlider (existing)
└── InfoBar (bottom, glassmorphism)
```

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| 3-finger gesture conflicts | UX | Use ScaleGestureRecognizer with minPointers=3 |
| FPS callback overhead | Performance | Only call if debug panel visible |
| Info bar obscures content | Visual | Make semi-transparent with blur |
| Particle reduction too aggressive | Visual | Use 30-frame average, 70% reduction |

## Dependencies

- **Depends on:** `altitude-depth` (complete)
- **Required by:** Nothing (final MVP feature)

## Performance Budget

| Operation | Budget | Expected |
|-----------|--------|----------|
| PerformanceManager.recordFrame() | <0.1ms | ~0.01ms |
| Debug panel render | <1ms | ~0.5ms |
| Info bar render | <1ms | ~0.3ms |
| **Total added per frame** | **<2ms** | **~0.8ms** |

Current altitude-depth budget: ~7.6ms per 16ms frame
With polish: ~8.4ms per 16ms frame → Still well within budget

## Feature Components Summary

| Component | Type | Priority | Notes |
|-----------|------|----------|-------|
| Debug panel toggle | UI | High | 3-finger tap |
| FPS in debug panel | UI | High | Already calculated, just display |
| PerformanceManager | Service | Medium | Adaptive particle count |
| Info bar | UI | Medium | User-facing wind info |
| Loading state | UI | Low | Camera initialization |
| Error handling | UI | Low | Graceful failures |

## Next Step

Run `/plan polish` to design detailed implementation.
