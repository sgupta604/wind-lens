# Implementation Plan: polish

## Metadata
- **Feature:** polish
- **Created:** 2026-01-21T02:45
- **Status:** plan-complete
- **Based On:** 2026-01-21T02:45_research.md

---

## Architecture Overview

### Current State
```
ARViewScreen
+-- CameraView (with basic loading/error)
+-- ParticleOverlay (FPS logged to console only)
+-- Debug overlay (always visible, inline in build)
+-- AltitudeSlider
```

### Target State
```
ARViewScreen
+-- GestureDetector (3-finger tap detection)
    +-- CameraView (existing - already has loading/error states)
    +-- ParticleOverlay (with FPS callback + PerformanceManager integration)
    +-- DebugPanel (toggleable, top-left)
    +-- AltitudeSlider (existing)
    +-- InfoBar (bottom, glassmorphism)
```

### Data Flow Diagram
```
+------------------+
| PerformanceManager|<--- recordFrame() called each tick
+------------------+
        |
        | particleCount (adaptive)
        | currentFps
        v
+------------------+        +------------------+
| ParticleOverlay  |------->| onFpsUpdate()    |
+------------------+        | callback         |
                            +------------------+
                                     |
                                     v
                            +------------------+
                            | ARViewScreen     |
                            | _currentFps state|
                            +------------------+
                                     |
                    +----------------+----------------+
                    |                                 |
                    v                                 v
            +-------------+                   +-------------+
            | DebugPanel  |                   | InfoBar     |
            | (if visible)|                   | (always)    |
            +-------------+                   +-------------+
```

---

## Tech Stack Summary

- **Framework:** Flutter 3.x with Dart
- **UI:** CustomPaint, BackdropFilter (glassmorphism), GestureDetector
- **State:** Local StatefulWidget state (no external state management)
- **Testing:** flutter_test

---

## File Structure

### New Files to Create

| File | Purpose |
|------|---------|
| `lib/services/performance_manager.dart` | Adaptive particle count based on FPS |
| `lib/widgets/info_bar.dart` | User-facing wind info bar at bottom |
| `test/services/performance_manager_test.dart` | Unit tests for PerformanceManager |
| `test/widgets/info_bar_test.dart` | Widget tests for InfoBar |

### Files to Modify

| File | Changes | Lines Affected |
|------|---------|----------------|
| `lib/widgets/particle_overlay.dart` | Add FPS callback, integrate PerformanceManager | ~15-25 new lines |
| `lib/screens/ar_view_screen.dart` | Add 3-finger toggle, debug panel state, info bar | ~80-100 new lines |

---

## Component Architecture

### PerformanceManager (Service)

```dart
class PerformanceManager {
  // State
  int _particleCount = 2000;           // Current adaptive count
  final List<double> _recentFps = [];  // Pre-allocated, max 30 entries
  double _currentFps = 60.0;           // Most recent FPS for display

  // Constants
  static const int _fpsWindowSize = 30;
  static const int _minParticles = 500;
  static const int _maxParticles = 2000;
  static const double _lowFpsThreshold = 45.0;
  static const double _highFpsThreshold = 58.0;

  // Getters
  int get particleCount => _particleCount;
  double get currentFps => _currentFps;

  // Methods
  void recordFrame(Duration elapsed, Duration lastElapsed);
  void _adjustParticleCount(double avgFps);
  void reset(); // For testing
}
```

**Performance Adjustment Logic:**
1. Calculate FPS from frame duration
2. Add to rolling window (30 frames)
3. When window full, calculate average
4. If avgFps < 45: reduce particles to 70% (min 500)
5. If avgFps > 58: increase particles by 10% (max 2000)
6. Clear window after adjustment

### InfoBar (Widget)

```dart
class InfoBar extends StatelessWidget {
  final double windSpeed;        // m/s
  final double windDirection;    // degrees
  final AltitudeLevel altitude;

  // Helpers
  String _getCardinalDirection(double degrees);
  String _formatWindSpeed(double speed);
}
```

**Visual Design:**
- Position: Bottom of screen, above safe area
- Style: Glassmorphism (match AltitudeSlider)
  - BackdropFilter with blur(10, 10)
  - White 15% opacity background
  - White 30% opacity border
- Height: 60px
- Padding: 16px horizontal, safe area bottom

**Content Layout:**
```
+--------------------------------------------------+
|  [Wind Icon]  12.5 m/s  NNW  |  [Alt Icon] SFC   |
+--------------------------------------------------+
```

### ARViewScreen Changes

**New State Variables:**
```dart
bool _showDebugPanel = false;  // Toggle with 3-finger tap
double _currentFps = 60.0;     // From ParticleOverlay callback
int _currentParticleCount = 2000;  // From PerformanceManager
```

**3-Finger Tap Detection:**
```dart
GestureDetector(
  onScaleStart: (details) {
    if (details.pointerCount >= 3) {
      setState(() => _showDebugPanel = !_showDebugPanel);
      HapticFeedback.mediumImpact();
    }
  },
  child: Stack(...),
)
```

**Debug Panel Content:**
- Heading: xxx.x degrees
- Pitch: xx.x degrees
- Sky: xx.x%
- Altitude: [Surface|Cloud Level|Jet Stream]
- Wind: xx.x m/s @ xxx degrees
- FPS: xx (NEW)
- Particles: xxxx (NEW)

---

## Testing Strategy

### Unit Tests (PerformanceManager)

| Test | Description |
|------|-------------|
| `starts with default values` | Initial state: 2000 particles, 60 FPS |
| `records frame and calculates FPS` | FPS calculation from duration |
| `reduces particles when FPS low` | <45 FPS triggers 70% reduction |
| `increases particles when FPS high` | >58 FPS triggers 10% increase |
| `respects minimum particle count` | Never goes below 500 |
| `respects maximum particle count` | Never exceeds 2000 |
| `clears window after adjustment` | Window resets on particle change |
| `requires full window before adjusting` | Only adjusts after 30 frames |

### Widget Tests (InfoBar)

| Test | Description |
|------|-------------|
| `renders without crashing` | Basic render test |
| `displays wind speed` | Shows speed in m/s |
| `displays cardinal direction` | Converts degrees to N/NE/E/SE/S/SW/W/NW |
| `displays altitude level` | Shows current altitude name |
| `uses glassmorphism styling` | Has BackdropFilter |
| `positions at bottom with safe area` | Uses SafeArea or padding |

### Integration Tests (ARViewScreen)

| Test | Description |
|------|-------------|
| `debug panel hidden by default` | _showDebugPanel = false |
| `3-finger tap toggles debug panel` | Visibility toggle |
| `debug panel shows FPS` | FPS value displayed |
| `debug panel shows particle count` | Particle count displayed |
| `info bar always visible` | InfoBar renders |

---

## Implementation Notes

### Performance Considerations

1. **PerformanceManager in ParticleOverlay:**
   - Create instance in initState (not in build)
   - Call recordFrame() in _onTick before setState
   - Pass particle count via callback, don't trigger rebuild

2. **FPS Callback Optimization:**
   - Only call callback when value changes (debounce)
   - Limit callback frequency to ~1/second for display

3. **Debug Panel Visibility:**
   - Use `if (_showDebugPanel)` in Stack children
   - Not Visibility widget - avoid layout when hidden

### UI Patterns

1. **Glassmorphism (reuse from AltitudeSlider):**
   ```dart
   ClipRRect(
     borderRadius: BorderRadius.circular(12),
     child: BackdropFilter(
       filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
       child: Container(
         decoration: BoxDecoration(
           color: Colors.white.withValues(alpha: 0.15),
           border: Border.all(
             color: Colors.white.withValues(alpha: 0.3),
           ),
         ),
         // ... content
       ),
     ),
   )
   ```

2. **Cardinal Direction Conversion:**
   ```dart
   String _getCardinalDirection(double degrees) {
     const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
                         'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
     final index = ((degrees + 11.25) / 22.5).floor() % 16;
     return directions[index];
   }
   ```

### Trade-offs

| Decision | Rationale |
|----------|-----------|
| InfoBar always visible | User needs constant feedback on wind conditions |
| Debug panel hidden by default | Clean UI for regular users, accessible for devs |
| 3-finger tap (not button) | Hidden gesture for devs, doesn't clutter UI |
| 30-frame FPS window | Smooth averaging without too much lag in adjustment |
| 70% reduction, 10% increase | Aggressive reduction for performance, gradual recovery |

---

## Non-Goals

1. **ML-based sky detection** - Not implementing in this feature (Level 3)
2. **Real wind data API** - Using fake wind service
3. **Persistent debug panel state** - Resets on app restart
4. **Custom FPS targets** - Fixed 45/58 thresholds
5. **Haptic feedback on all interactions** - Only on altitude change and debug toggle

---

## Risk Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| 3-finger gesture conflicts with zoom | Low | Medium | Use onScaleStart, check pointerCount |
| PerformanceManager causes allocations | Medium | High | Pre-allocate list, use fixed window |
| InfoBar obscures particles | Low | Low | Semi-transparent, positioned at bottom edge |
| FPS callback causes jank | Medium | Medium | Debounce to 1/second, use ValueNotifier |

---

## Dependencies

- **Internal:** `altitude_level.dart`, `wind_data.dart` (existing models)
- **External:** None new (uses flutter/material.dart, flutter/services.dart)

---

## Success Criteria

1. Debug panel toggles with 3-finger tap
2. Debug panel shows FPS and particle count
3. FPS stays above 45 on target devices
4. InfoBar displays wind info in user-friendly format
5. All new code has passing tests
6. Build succeeds without warnings
