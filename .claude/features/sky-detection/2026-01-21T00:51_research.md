# Research: sky-detection

## Metadata
- **Feature:** sky-detection
- **Created:** 2026-01-21T00:51
- **Status:** research-complete

## Requirements from Spec

From `ROADMAP.md` Feature 3 and `WIND_LENS_MVP_SPEC.md` Section 3:

### What to Build
- Level 1: Pitch-based sky mask (SimpleSkyMask)
  - Phone tilted up > 20° → top of screen is sky
  - Returns skyFraction based on pitch
- SkyMask interface for future upgrades
- Integration with camera frame timing

### Acceptance Criteria
- [ ] Sky fraction changes with phone pitch
- [ ] skyFraction = 0 when looking down
- [ ] skyFraction increases when looking up
- [ ] Logs: "Sky fraction: X%"
- [ ] processFrame() < 16ms

### From MVP Spec Section 3 - Sky Detection

**The Goal:**
Given a camera frame, produce a **mask** where:
- `1` (white) = this pixel is sky → render particles here
- `0` (black) = this pixel is NOT sky → don't render particles

**Level 1: Pitch-Based (Simplest - Start Here)**
```dart
class SimpleSkyMask {
  final double pitchDegrees;

  SimpleSkyMask(this.pitchDegrees);

  double get skyFraction {
    if (pitchDegrees < 10) return 0.0;        // Looking down/level
    if (pitchDegrees > 70) return 0.95;       // Looking almost straight up
    // Linear interpolation between 10° and 70°
    return ((pitchDegrees - 10) / 60).clamp(0.0, 0.95);
  }

  bool isPointInSky(double normalizedY) {
    // normalizedY: 0.0 = top of screen, 1.0 = bottom
    return normalizedY < skyFraction;
  }
}
```

**Pros:** Dead simple, works immediately, no dependencies
**Cons:** Doesn't know about buildings/trees blocking sky
**Use for:** Initial testing, getting particle pipeline working

### SkyMask Interface (from spec)
```dart
abstract class SkyMask {
  double get skyFraction;
  bool isPointInSky(double normalizedX, double normalizedY);
}
```

## Existing Code Analysis

### Current State
- Project at `/workspace/wind_lens`
- CompassService provides `pitch` getter (from compass-sensors feature)
- CameraView exists (from camera-feed feature)
- No sky detection code exists yet
- No `lib/services/sky_detection/` directory

### Architecture from Spec
```
lib/
├── services/
│   └── sky_detection/
│       ├── sky_detector.dart           # Abstract interface
│       └── pitch_based_detector.dart   # Level 1: Simple pitch-based
```

### Integration Points
- `CompassService.pitch` - provides current device pitch angle
- Future: CameraView `onFrame` callback for image-based detection
- ARViewScreen will use `SkyMask.isPointInSky()` for particle rendering

## Technical Constraints

From CLAUDE.md:
- **Performance:** processFrame() < 16ms (60 FPS capable)
- **Sky fraction:** 0 when looking down, increases when looking up
- **Must work before particles** - this is the foundation

### Algorithm Details
- Pitch < 10° → skyFraction = 0.0
- Pitch > 70° → skyFraction = 0.95
- Linear interpolation between 10° and 70°
- Formula: `((pitch - 10) / 60).clamp(0.0, 0.95)`

## Open Questions

All resolved:
- [x] Start with Level 1 only? → Yes, pitch-based is sufficient for MVP
- [x] Interface needed? → Yes, SkyMask abstract class for future upgrades
- [x] Where to put code? → `lib/services/sky_detection/`
- [x] How to integrate? → ARViewScreen will hold SkyDetector instance

## Recommended Approach

### 1. Create Directory Structure
```
lib/
└── services/
    └── sky_detection/
        ├── sky_mask.dart               # Abstract interface
        └── pitch_based_sky_mask.dart   # Level 1 implementation
```

### 2. Implement SkyMask Interface
```dart
abstract class SkyMask {
  /// Returns what fraction of screen (from top) is sky (0.0 to 1.0)
  double get skyFraction;

  /// Check if a point is in the sky region
  /// normalizedX: 0.0 = left, 1.0 = right
  /// normalizedY: 0.0 = top, 1.0 = bottom
  bool isPointInSky(double normalizedX, double normalizedY);
}
```

### 3. Implement PitchBasedSkyMask
- Use pitch from CompassService
- Implement linear interpolation formula
- No image processing (fast!)
- Log sky fraction changes

### 4. Integrate with ARViewScreen
- Add SkyMask instance to state
- Update sky fraction from compass pitch
- Display sky fraction in debug overlay
- Prepare for particle overlay (next feature)

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Performance too slow | <60 FPS | Pitch-based is O(1), no risk |
| Inaccurate sky detection | Particles over buildings | Acceptable for Level 1, Level 2+ later |
| Pitch sensor noise | Flickering sky fraction | Already smoothed in CompassService |
| Edge cases (horizon) | Weird behavior | Clamp values, test thoroughly |

## Dependencies

- **Depends on:** `camera-feed` (complete), `compass-sensors` (complete - provides pitch)
- **Required by:** `particle-system` (uses isPointInSky())

## Performance Analysis

**Level 1 Pitch-Based:**
- No image processing
- O(1) computation
- < 1ms execution time
- Easily meets <16ms requirement

## Next Step

Run `/plan sky-detection` to design detailed implementation.
