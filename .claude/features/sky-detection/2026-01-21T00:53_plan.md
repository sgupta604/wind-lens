# Implementation Plan: sky-detection

## Metadata
- **Feature:** sky-detection
- **Created:** 2026-01-21T00:53
- **Status:** plan-complete
- **Based On:** 2026-01-21T00:51_research.md

---

## Architecture Overview

### Component Diagram

```
+-------------------+     +---------------------+
|   ARViewScreen    |     |    CompassService   |
|                   |     |                     |
|  - _heading       |<----|  - stream           |
|  - _pitch         |     |  - pitch            |
|  - _skyMask       |     +---------------------+
|  - _skyFraction   |
+--------+----------+
         |
         | uses
         v
+-------------------+
|    <<abstract>>   |
|      SkyMask      |
|-------------------|
| + skyFraction     |
| + isPointInSky()  |
+--------+----------+
         ^
         | implements
         |
+-------------------+
| PitchBasedSkyMask |
|-------------------|
| - _pitch: double  |
|-------------------|
| + updatePitch()   |
| + skyFraction     |
| + isPointInSky()  |
+-------------------+
```

### Data Flow

```
                     Sensor Events
                          |
                          v
+---------------------+   |   +-------------------+
|  CompassService     |<--+   |  ARViewScreen     |
|  (sensors_plus)     |       |                   |
|                     |       |  1. Listen to     |
|  pitch: double -----|------>|     compass stream|
+---------------------+       |                   |
                              |  2. Update        |
                              |     PitchBased    |
                              |     SkyMask       |
                              |                   |
                              |  3. Display sky   |
                              |     fraction in   |
                              |     debug overlay |
                              +-------------------+
```

---

## Tech Stack Summary

| Component | Technology | Notes |
|-----------|------------|-------|
| Framework | Flutter 3.x | Dart language |
| Sensors | sensors_plus ^7.0.0 | Already integrated via CompassService |
| Testing | flutter_test | Built-in Flutter testing framework |

---

## File Structure

### New Files to Create

| File Path | Purpose |
|-----------|---------|
| `lib/services/sky_detection/sky_mask.dart` | Abstract SkyMask interface defining the contract for sky detection implementations |
| `lib/services/sky_detection/pitch_based_sky_mask.dart` | Level 1 implementation using device pitch angle |
| `test/services/sky_detection/sky_mask_test.dart` | Tests for SkyMask interface behavior |
| `test/services/sky_detection/pitch_based_sky_mask_test.dart` | Unit tests for PitchBasedSkyMask |

### Files to Modify

| File Path | Lines | Changes |
|-----------|-------|---------|
| `lib/screens/ar_view_screen.dart` | 1-112 | Add SkyMask import, create PitchBasedSkyMask instance, update from compass pitch, add sky fraction to debug overlay |

---

## Component Architecture

### SkyMask Interface (`sky_mask.dart`)

```dart
/// Abstract interface for sky detection implementations.
///
/// The SkyMask determines which portions of the screen represent sky
/// where wind particles should be rendered. Different implementations
/// can use various detection methods (pitch-based, color-based, ML).
abstract class SkyMask {
  /// Returns what fraction of screen (from top) is sky.
  /// Value range: 0.0 (no sky visible) to 1.0 (entire screen is sky).
  /// Note: Typically capped at 0.95 to always leave some ground.
  double get skyFraction;

  /// Check if a normalized screen point is in the sky region.
  ///
  /// Parameters:
  /// - normalizedX: 0.0 = left edge, 1.0 = right edge
  /// - normalizedY: 0.0 = top edge, 1.0 = bottom edge
  ///
  /// Returns true if the point should display particles.
  bool isPointInSky(double normalizedX, double normalizedY);
}
```

### PitchBasedSkyMask Implementation (`pitch_based_sky_mask.dart`)

```dart
/// Level 1 sky detection using device pitch angle.
///
/// This simple implementation assumes:
/// - When phone is tilted up (pitch > 10), top of screen is sky
/// - Sky fraction increases linearly from pitch 10 to 70
/// - Above 70, we're looking almost straight up (95% sky)
///
/// Pros: Dead simple, O(1), no image processing
/// Cons: Doesn't detect buildings/trees blocking sky
class PitchBasedSkyMask implements SkyMask {
  /// Minimum pitch (degrees) before any sky is visible
  static const double minPitch = 10.0;

  /// Maximum pitch (degrees) for full sky coverage
  static const double maxPitch = 70.0;

  /// Maximum sky fraction (never 100% to leave room for horizon)
  static const double maxSkyFraction = 0.95;

  double _pitch = 0;

  /// Updates the pitch value and logs the resulting sky fraction.
  void updatePitch(double pitchDegrees) {
    _pitch = pitchDegrees;
    debugPrint('Sky fraction: ${(skyFraction * 100).toStringAsFixed(1)}%');
  }

  @override
  double get skyFraction {
    if (_pitch < minPitch) return 0.0;
    if (_pitch > maxPitch) return maxSkyFraction;
    return ((_pitch - minPitch) / (maxPitch - minPitch) * maxSkyFraction)
        .clamp(0.0, maxSkyFraction);
  }

  @override
  bool isPointInSky(double normalizedX, double normalizedY) {
    // Y=0 is top of screen, Y=1 is bottom
    // Point is in sky if it's above the sky/ground boundary
    return normalizedY < skyFraction;
  }
}
```

### Integration with ARViewScreen

The ARViewScreen will be modified to:

1. Import sky detection classes
2. Create and manage PitchBasedSkyMask instance
3. Update sky mask when pitch changes
4. Display sky fraction in debug overlay

Key integration points (approximate line numbers):
- Import statement: Line ~8
- State variables: Line ~28-30 (add `_skyMask` and `_skyFraction`)
- initState: Line ~36 (create PitchBasedSkyMask)
- _onCompassUpdate: Line ~50 (update sky mask pitch)
- _buildDebugOverlay: Line ~78 (add sky fraction display)

---

## State Management

### State Variables Added to ARViewScreen

```dart
/// The sky mask for determining sky regions
late PitchBasedSkyMask _skyMask;

/// Current sky fraction (0.0 to 1.0)
double _skyFraction = 0;
```

### State Updates

When CompassData arrives:
1. Update `_heading` and `_pitch` (existing)
2. Call `_skyMask.updatePitch(_pitch)`
3. Update `_skyFraction = _skyMask.skyFraction`
4. Trigger UI rebuild with `setState()`

---

## Algorithm Details

### Sky Fraction Calculation

```
Input: pitchDegrees (device tilt angle)

if pitchDegrees < 10:
    return 0.0      // Looking down or level - no sky
elif pitchDegrees > 70:
    return 0.95     // Looking almost straight up - mostly sky
else:
    // Linear interpolation
    fraction = (pitchDegrees - 10) / 60
    return fraction * 0.95
```

### Point-in-Sky Check

```
Input: normalizedX (0-1), normalizedY (0-1)

// For pitch-based, X is irrelevant (uniform horizontal boundary)
// Y=0 is top, Y=1 is bottom
// Point is sky if Y < skyFraction

return normalizedY < skyFraction
```

### Visual Representation

```
When pitch = 40 degrees (skyFraction = 0.475):

Screen coordinates:
+------------------+ Y=0.0 (top)
|                  |
|      SKY         | Y=0.0 to 0.475
|      (particles) |
|                  |
|------------------| Y=0.475 (boundary)
|                  |
|     GROUND       | Y=0.475 to 1.0
|   (no particles) |
|                  |
+------------------+ Y=1.0 (bottom)
```

---

## Testing Strategy

### Unit Tests (5 tests minimum)

**PitchBasedSkyMask Tests:**

1. **test_skyFraction_zero_when_pitch_below_minimum**
   - Input: pitch = 5
   - Expected: skyFraction = 0.0

2. **test_skyFraction_max_when_pitch_above_maximum**
   - Input: pitch = 80
   - Expected: skyFraction = 0.95

3. **test_skyFraction_linear_interpolation_midpoint**
   - Input: pitch = 40
   - Expected: skyFraction approximately 0.475

4. **test_isPointInSky_returns_true_for_top_of_screen**
   - Setup: pitch = 50 (skyFraction ~0.63)
   - Input: normalizedY = 0.3
   - Expected: true

5. **test_isPointInSky_returns_false_for_bottom_of_screen**
   - Setup: pitch = 50 (skyFraction ~0.63)
   - Input: normalizedY = 0.8
   - Expected: false

6. **test_isPointInSky_ignores_x_coordinate**
   - Setup: pitch = 50
   - Input: (x=0.1, y=0.3) and (x=0.9, y=0.3)
   - Expected: both return same value

7. **test_updatePitch_changes_skyFraction**
   - Action: updatePitch(10), check skyFraction, updatePitch(70)
   - Expected: skyFraction changes from 0 to 0.95

### Integration Tests

1. **ARViewScreen displays sky fraction in debug overlay**
   - Verify Text widget with "Sky:" label exists
   - Verify value updates when compass data changes

### Real Device Testing (Manual)

1. Point phone down - verify sky fraction = 0%
2. Point phone at horizon - verify sky fraction increases
3. Point phone at sky - verify sky fraction approaches 95%
4. Verify "Sky fraction: X%" appears in console logs

---

## Performance Analysis

| Operation | Complexity | Time |
|-----------|------------|------|
| updatePitch() | O(1) | < 0.01ms |
| skyFraction getter | O(1) | < 0.01ms |
| isPointInSky() | O(1) | < 0.01ms |

**Total per frame: < 0.1ms** - well under 16ms budget

The pitch-based approach has zero image processing, making it extremely fast.
This prepares for the particle system which will call isPointInSky() for each
particle (~2000 calls per frame).

---

## Implementation Notes

### Design Decisions

1. **Abstract interface first**: SkyMask interface allows swapping implementations (Level 1 -> Level 2) without changing ARViewScreen
2. **Constants exposed**: minPitch, maxPitch, maxSkyFraction are static const for testability and documentation
3. **Debug logging**: updatePitch() logs sky fraction for verification checkpoint
4. **X coordinate in interface**: isPointInSky takes X even though pitch-based ignores it - future implementations (color-based) will need it

### Patterns Used

- **Strategy Pattern**: SkyMask interface with multiple implementations
- **Dependency Injection Ready**: ARViewScreen could accept SkyMask in constructor for testing

### Trade-offs

| Decision | Benefit | Cost |
|----------|---------|------|
| Simple pitch-based | Fast, reliable, no dependencies | Can't detect buildings |
| Abstract interface | Future extensibility | Slight complexity |
| Logging in updatePitch | Easy debugging | Minor performance (negligible) |

---

## Non-Goals

Explicitly NOT implementing in this feature:

1. **Color-based sky detection** (Level 2) - Future feature
2. **ML/TFLite detection** (Level 3) - Future feature
3. **Building/tree masking** - Requires image processing
4. **Particle rendering** - Next feature (particle-system)
5. **Camera frame processing** - Not needed for Level 1

---

## Dependencies

### Requires (Complete)

- `camera-feed` - CameraView widget
- `compass-sensors` - CompassService with pitch

### Required By (Future)

- `particle-system` - Will use isPointInSky() for particle visibility

---

## Verification Checklist

After implementation, verify:

- [ ] `flutter analyze` passes with no errors
- [ ] `flutter test` passes all tests
- [ ] Debug overlay shows "Sky: X.X%"
- [ ] Console logs "Sky fraction: X.X%"
- [ ] Sky fraction = 0% when phone pointed down
- [ ] Sky fraction increases when tilting up
- [ ] Sky fraction ~95% when pointing at sky (on real device)

---

## Next Step

After this plan is approved, run `/implement sky-detection` to execute the tasks.
