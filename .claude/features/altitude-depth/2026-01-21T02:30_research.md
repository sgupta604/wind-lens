# Research: altitude-depth

## Metadata
- **Feature:** altitude-depth
- **Created:** 2026-01-21T02:30
- **Status:** research-complete

## Requirements from Spec

From `ROADMAP.md` Feature 6 and `WIND_LENS_MVP_SPEC.md`:

### What to Build
- AltitudeLevel enum (Surface, MidLevel, JetStream)
- Altitude slider UI widget
- Per-altitude properties:
  | Level | Color | Speed | Parallax |
  |-------|-------|-------|----------|
  | Surface | White | ~5 m/s | 1.0 |
  | Mid-level | Cyan | ~10 m/s | 0.6 |
  | Jet Stream | Purple | ~50 m/s | 0.3 |
- Parallax effect based on phone movement
- Higher altitude = more sky coverage

### Acceptance Criteria
- [ ] Slider switches between altitude levels
- [ ] Each level has distinct color
- [ ] Higher altitudes feel "further away"
- [ ] Parallax responds to phone tilt

## From MVP Spec Section 5 - AltitudeLevel

```dart
enum AltitudeLevel {
  surface,    // 0-500ft / 0-150m
  midLevel,   // ~5,000ft / ~1,500m (850 hPa)
  jetStream,  // ~34,000ft / ~10,500m (250 hPa)
}

extension AltitudeLevelProperties on AltitudeLevel {
  String get displayName => switch (this) {
    AltitudeLevel.surface => 'Surface',
    AltitudeLevel.midLevel => 'Cloud Level',
    AltitudeLevel.jetStream => 'Jet Stream',
  };

  double get metersAGL => switch (this) {
    AltitudeLevel.surface => 10,
    AltitudeLevel.midLevel => 1500,
    AltitudeLevel.jetStream => 10500,
  };

  Color get particleColor => switch (this) {
    AltitudeLevel.surface => Color(0xAAFFFFFF),    // ghostly white
    AltitudeLevel.midLevel => Color(0xAA00DDFF),   // cyan
    AltitudeLevel.jetStream => Color(0xAADD00FF),  // magenta/purple
  };

  double get particleSpeedMultiplier => switch (this) {
    AltitudeLevel.surface => 1.0,
    AltitudeLevel.midLevel => 1.5,
    AltitudeLevel.jetStream => 3.0,
  };
}
```

## From MVP Spec Section 9 - Spatial Depth

### Technique 1: Parallax Effect
When you rotate the phone, particles at different "depths" move at different speeds.

```dart
void updateParticleWithParallax(Particle p, double compassDelta, AltitudeLevel level) {
  double rotation = compassDelta;  // How much phone rotated this frame

  // Parallax factor: higher altitude = further away = LESS apparent motion
  double parallaxFactor = switch (level) {
    AltitudeLevel.surface => 1.0,    // Close: moves a lot when you turn
    AltitudeLevel.midLevel => 0.6,   // Medium: moves moderately
    AltitudeLevel.jetStream => 0.3,  // Far: barely moves (like real clouds)
  };

  // Apply parallax offset
  p.x -= (rotation / 360.0) * parallaxFactor;
}
```

### Technique 2: Scale by Altitude
Particles "further away" appear smaller.

```dart
double getTrailLength(AltitudeLevel level, double windSpeed) {
  double perspectiveScale = switch (level) {
    AltitudeLevel.surface => 1.0,
    AltitudeLevel.midLevel => 0.7,
    AltitudeLevel.jetStream => 0.5,
  };
  return windSpeed * 0.5 * perspectiveScale;
}
```

### Technique 3: Density by Altitude
Higher altitudes cover more area, so particles spread out more.

```dart
int getParticleCount(AltitudeLevel level, int baseCount) {
  return switch (level) {
    AltitudeLevel.surface => baseCount,           // 2000 particles
    AltitudeLevel.midLevel => (baseCount * 0.8).round(),  // 1600
    AltitudeLevel.jetStream => (baseCount * 0.5).round(), // 1000
  };
}
```

### Technique 4: Speed Perception
Higher altitudes have faster winds, but appear to move slower due to distance.

```dart
double getApparentSpeed(AltitudeLevel level, double actualWindSpeed) {
  double distanceFactor = switch (level) {
    AltitudeLevel.surface => 1.0,
    AltitudeLevel.midLevel => 0.5,
    AltitudeLevel.jetStream => 0.25,
  };
  return actualWindSpeed * distanceFactor;
}
```

## From MVP Spec Section 10 - Altitude Slider UI

### Altitude Slider
- Position: Right edge, vertically centered
- Width: 60px
- Height: 200px
- Style: Glassmorphism (frosted glass effect)
- Interaction: Tap segment OR drag
- Haptic: Light impact on level change

### Layout
```
┌─────┐
│ JET │
│     │
│ MID │  ← Altitude Slider
│     │
│ SFC │
└─────┘
```

## Existing Code Analysis

### Current State
- Project at `/workspace/wind_lens`
- WindData model exists (`lib/models/wind_data.dart`)
- FakeWindService exists (`lib/services/fake_wind_service.dart`) - currently surface-only
- ParticleOverlay exists with:
  - Fixed white color
  - Single particle count (2000)
  - No parallax effect
  - windData + compassHeading parameters
- CompassService provides heading (needed for parallax calculation)

### Files to Create
```
lib/
├── models/
│   └── altitude_level.dart         # AltitudeLevel enum + extension
└── widgets/
    └── altitude_slider.dart        # Altitude selection UI widget
```

### Files to Modify
- `lib/services/fake_wind_service.dart` - Add getWindForAltitude(AltitudeLevel)
- `lib/widgets/particle_overlay.dart` - Add altitude, parallax, color
- `lib/screens/ar_view_screen.dart` - Add altitude slider, state management

## Technical Constraints

From CLAUDE.md and MVP Spec:
- **Performance:** Maintain 60 FPS
- **No object allocation in render loop**
- **Parallax must be smooth** - Use previous heading for delta calculation
- **Per-altitude wind** - Different wind speeds per altitude level

### Altitude Properties Reference
| Level | Altitude | Color | Speed | Parallax | Stroke Scale |
|-------|----------|-------|-------|----------|--------------|
| Surface | 10m | White (0xAAFFFFFF) | ~5 m/s | 1.0 | 1.0 |
| Mid-level | 1,500m | Cyan (0xAA00DDFF) | ~10 m/s | 0.6 | 0.7 |
| Jet Stream | 10,500m | Purple (0xAADD00FF) | ~50 m/s | 0.3 | 0.5 |

## Open Questions

All resolved from spec:
- [x] Parallax implementation? → Track previous heading, calculate delta, apply per-altitude factor
- [x] Wind per altitude? → Extend FakeWindService with getWindForAltitude()
- [x] Color format? → Use Color(0xAARRGGBB) with alpha
- [x] Slider interaction? → Tap segment or drag
- [x] Haptic feedback? → Light impact on level change (HapticFeedback.lightImpact())

## Recommended Approach

### 1. Create AltitudeLevel Model
```dart
enum AltitudeLevel { surface, midLevel, jetStream }

extension AltitudeLevelProperties on AltitudeLevel {
  String get displayName;
  double get metersAGL;
  Color get particleColor;
  double get particleSpeedMultiplier;
  double get parallaxFactor;
  double get trailScale;
}
```

### 2. Create Altitude Slider Widget
```dart
class AltitudeSlider extends StatelessWidget {
  final AltitudeLevel value;
  final ValueChanged<AltitudeLevel> onChanged;

  // Glassmorphism style
  // Vertical layout: JET at top, SFC at bottom
  // Tap or drag to select
}
```

### 3. Update FakeWindService
```dart
class FakeWindService {
  WindData getWindForAltitude(AltitudeLevel level) {
    // Different wind patterns per altitude
  }
}
```

### 4. Update ParticleOverlay
- Add `altitudeLevel` parameter
- Apply parallax based on compass delta
- Use altitude-specific color
- Apply trail scale by altitude
- Track previous heading for delta calculation

### 5. Update ARViewScreen
- Add `_altitudeLevel` state
- Add AltitudeSlider to Stack
- Pass altitude to ParticleOverlay and FakeWindService

### Architecture After Changes
```dart
ARViewScreen
├── CompassService (existing)
│   └── provides: heading, pitch
├── FakeWindService (MODIFIED)
│   └── provides: getWindForAltitude(AltitudeLevel)
├── PitchBasedSkyMask (existing)
│   └── provides: skyFraction, isPointInSky()
├── AltitudeSlider (NEW)
│   └── selects: AltitudeLevel
└── ParticleOverlay (MODIFIED)
    ├── particles colored by altitude
    ├── parallax based on compass delta
    └── trail scale by altitude
```

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Parallax jitter | Visual quality | Use smoothed compass heading |
| Color readability | Visibility | Test on real sky backgrounds |
| Slider touch target | UX | Ensure 48x48pt minimum touch areas |
| FPS drop at jet stream | Performance | Reduce particle count at higher altitudes |

## Dependencies

- **Depends on:** `wind-animation` (complete - provides WindData, FakeWindService)
- **Required by:** `polish` (final feature)

## Performance Budget

| Operation | Budget | Expected |
|-----------|--------|----------|
| Parallax calculation | <1ms | ~0.1ms |
| Color lookup | <1ms | negligible |
| Altitude slider render | <1ms | ~0.5ms |
| **Total added per frame** | **<3ms** | **~0.6ms** |

Current wind animation budget: ~7ms per 16ms frame
With altitude-depth: ~7.6ms per 16ms frame → Still well within budget

## Next Step

Run `/plan altitude-depth` to design detailed implementation.
