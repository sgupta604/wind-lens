# Plan: altitude-depth

## Metadata
- **Feature:** altitude-depth
- **Created:** 2026-01-21T02:30
- **Status:** plan-complete
- **Based On:** 2026-01-21T02:30_research.md

## Architecture Overview

### Component Hierarchy

```
ARViewScreen (MODIFIED)
├── State: _altitudeLevel (NEW)
├── State: _previousHeading (NEW for parallax)
│
├── CameraView (existing)
│
├── ParticleOverlay (MODIFIED)
│   ├── Input: altitudeLevel (NEW)
│   ├── Input: previousHeading (NEW for parallax)
│   │
│   └── ParticleOverlayPainter (MODIFIED)
│       ├── Uses altitude-specific color
│       ├── Applies parallax offset
│       └── Scales trail length by altitude
│
└── AltitudeSlider (NEW)
    ├── Position: Right edge, vertically centered
    ├── Style: Glassmorphism (frosted glass)
    ├── Segments: JET | MID | SFC (top to bottom)
    └── Haptic: lightImpact on change
```

### Data Flow Diagram

```
                                 ┌─────────────────────┐
                                 │   AltitudeLevel     │
                                 │   (enum + ext)      │
                                 └──────────┬──────────┘
                                            │
        ┌───────────────────────────────────┼───────────────────────────────────┐
        │                                   │                                   │
        ▼                                   ▼                                   ▼
┌───────────────────┐              ┌────────────────────┐              ┌─────────────────┐
│  FakeWindService  │              │   ARViewScreen     │              │  AltitudeSlider │
│  (MODIFIED)       │              │   (MODIFIED)       │              │  (NEW)          │
│                   │◄─────────────│                    │◄─────────────│                 │
│  getWindFor-      │  altitude    │  _altitudeLevel    │  onChanged   │  value          │
│  Altitude(level)  │              │  _previousHeading  │              │  onChanged      │
└───────────────────┘              └─────────┬──────────┘              └─────────────────┘
        │                                    │
        │ WindData                           │ altitude, previousHeading
        ▼                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        ParticleOverlay (MODIFIED)                    │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                ParticleOverlayPainter (MODIFIED)            │    │
│  │                                                             │    │
│  │  for each particle:                                         │    │
│  │    1. Check skyMask.isPointInSky()                          │    │
│  │    2. Apply parallax: x -= (headingDelta/360) * parallax    │    │
│  │    3. Scale trail: trailLength * altitude.trailScale        │    │
│  │    4. Use color: altitude.particleColor                     │    │
│  │    5. Render with 2-pass glow                               │    │
│  │                                                             │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

### State Management

```
ARViewScreen State:
├── _heading: double (existing)
├── _pitch: double (existing)
├── _skyFraction: double (existing)
├── _windData: WindData (existing)
├── _altitudeLevel: AltitudeLevel (NEW - default: surface)
└── _previousHeading: double (NEW - for parallax calculation)

Flow:
1. User taps/drags AltitudeSlider
2. _altitudeLevel updates via setState()
3. _windData refreshed via _windService.getWindForAltitude(_altitudeLevel)
4. ParticleOverlay receives new altitude and renders appropriately
```

## Tech Stack Summary

- **Language:** Dart 3.x
- **Framework:** Flutter 3.x
- **State:** StatefulWidget with setState()
- **Animation:** Ticker-based (existing in ParticleOverlay)
- **Haptics:** HapticFeedback.lightImpact() from flutter/services.dart

## File Structure

### New Files

| File | Purpose |
|------|---------|
| `lib/models/altitude_level.dart` | AltitudeLevel enum with properties extension |
| `lib/widgets/altitude_slider.dart` | Glassmorphism vertical slider UI widget |
| `test/models/altitude_level_test.dart` | Unit tests for enum properties |
| `test/widgets/altitude_slider_test.dart` | Widget tests for slider behavior |

### Modified Files

| File | Line Numbers | Changes |
|------|--------------|---------|
| `lib/services/fake_wind_service.dart` | Add after line 51 | Add `getWindForAltitude(AltitudeLevel level)` method |
| `lib/widgets/particle_overlay.dart` | Lines 27-53, 130-136, 170-175, 217-256 | Add altitudeLevel param, parallax logic, color/scale from altitude |
| `lib/screens/ar_view_screen.dart` | Lines 27-51, 72-81, 88-108 | Add altitude state, slider, pass altitude to ParticleOverlay |
| `test/services/fake_wind_service_test.dart` | Add after line 83 | Tests for getWindForAltitude() |
| `test/widgets/particle_overlay_test.dart` | Add after line 443 | Tests for altitude parameter and parallax |

## Data Model: AltitudeLevel

### Enum Definition

```dart
enum AltitudeLevel {
  surface,    // 0-500ft / 0-150m
  midLevel,   // ~5,000ft / ~1,500m (850 hPa)
  jetStream,  // ~34,000ft / ~10,500m (250 hPa)
}
```

### Extension Properties

| Property | Surface | Mid-Level | Jet Stream |
|----------|---------|-----------|------------|
| `displayName` | "Surface" | "Cloud Level" | "Jet Stream" |
| `metersAGL` | 10.0 | 1500.0 | 10500.0 |
| `particleColor` | 0xAAFFFFFF (white) | 0xAA00DDFF (cyan) | 0xAADD00FF (purple) |
| `particleSpeedMultiplier` | 1.0 | 1.5 | 3.0 |
| `parallaxFactor` | 1.0 | 0.6 | 0.3 |
| `trailScale` | 1.0 | 0.7 | 0.5 |
| `particleDensity` | 1.0 | 0.8 | 0.5 |

## Component Architecture

### AltitudeSlider Widget

```
Widget Tree:
AltitudeSlider (StatelessWidget)
└── ClipRRect (border radius)
    └── BackdropFilter (blur for glassmorphism)
        └── Container (glass background)
            └── Column
                ├── _AltitudeSegment (jetStream)
                ├── _AltitudeSegment (midLevel)
                └── _AltitudeSegment (surface)

Properties:
- value: AltitudeLevel (current selection)
- onChanged: ValueChanged<AltitudeLevel>

Styling:
- Width: 60px
- Height: 200px
- Position: Right edge, vertically centered
- Background: Colors.white.withOpacity(0.15)
- Border: 1px Colors.white.withOpacity(0.3)
- Blur: ImageFilter.blur(sigmaX: 10, sigmaY: 10)
- Selected segment: Colors.white.withOpacity(0.3)
- Touch feedback: HapticFeedback.lightImpact()
```

### ParticleOverlay Modifications

```dart
// NEW parameters to add:
class ParticleOverlay {
  final AltitudeLevel altitudeLevel;    // NEW
  final double previousHeading;          // NEW for parallax
  // ... existing params
}

// In _onTick():
// Calculate parallax offset
double headingDelta = widget.compassHeading - widget.previousHeading;
// Normalize to -180 to 180 range
if (headingDelta > 180) headingDelta -= 360;
if (headingDelta < -180) headingDelta += 360;

for (final p in _particles) {
  // Apply parallax (higher altitude = less movement)
  p.x -= (headingDelta / 360.0) * widget.altitudeLevel.parallaxFactor;

  // Scale trail length by altitude
  p.trailLength = widget.windData.speed * 0.5 * widget.altitudeLevel.trailScale;

  // ... existing movement logic
}

// In ParticleOverlayPainter:
// Use altitude-specific color
final color = widget.altitudeLevel.particleColor;
```

## Testing Strategy

### Unit Tests (8 tests)

**altitude_level_test.dart:**
1. `surface has displayName "Surface"`
2. `midLevel has displayName "Cloud Level"`
3. `jetStream has displayName "Jet Stream"`
4. `metersAGL values are correct for all levels`
5. `particleColor values are correct for all levels`
6. `parallaxFactor decreases with altitude`
7. `trailScale decreases with altitude`
8. `particleSpeedMultiplier increases with altitude`

### Widget Tests (12 tests)

**altitude_slider_test.dart:**
1. `renders without crashing`
2. `displays all three segments`
3. `shows correct labels (JET, MID, SFC)`
4. `highlights selected segment`
5. `calls onChanged when tapped`
6. `supports drag gesture`
7. `triggers haptic feedback on change`
8. `has minimum touch target size (48x48)`

**particle_overlay_test.dart (additions):**
9. `accepts altitudeLevel parameter`
10. `uses altitude-specific color`
11. `accepts previousHeading parameter`
12. `applies parallax based on heading delta`

### Integration Tests (4 tests)

**ar_view_screen_test.dart (additions):**
1. `contains AltitudeSlider widget`
2. `altitude changes when slider tapped`
3. `debug overlay shows altitude level`
4. `particle color changes with altitude`

## Implementation Notes

### Decisions Made

1. **Parallax in ParticleOverlay, not ARViewScreen** - Keep particle-related calculations in the particle system for cohesion.

2. **previousHeading passed from ARViewScreen** - ARViewScreen already manages compass state, so it tracks previous heading and passes delta to ParticleOverlay.

3. **Trail scale applied in _onTick(), not Painter** - Trail length is a particle property, so update it during physics step.

4. **Color passed to Painter via altitude property** - Painter uses altitude.particleColor directly for cleaner code.

5. **No particle count reduction for MVP** - The spec mentions reducing particles at higher altitudes, but this is optimization that can be added later if needed.

### Patterns Used

- **Extension on enum** - AltitudeLevel properties via extension (Dart 3.x pattern)
- **Glassmorphism UI** - BackdropFilter + ClipRRect + semi-transparent container
- **Haptic feedback** - HapticFeedback.lightImpact() for tactile response
- **Value-based callback** - ValueChanged<AltitudeLevel> for slider

### Trade-offs

| Decision | Pro | Con |
|----------|-----|-----|
| Single altitude (not multi-layer) | Simpler, clearer UX | Can't see multiple altitudes at once |
| Glassmorphism slider | Modern, matches spec | More complex than plain widget |
| Parallax per-frame | Smooth effect | Extra calculation per particle |

## Non-Goals (Explicit Exclusions)

1. **Multi-layer display** - Not showing multiple altitudes simultaneously
2. **Animated transitions** - No smooth fade between altitude levels
3. **Particle count adjustment** - Not reducing particles at higher altitudes (can add later)
4. **Real wind API** - Using FakeWindService only
5. **Custom slider physics** - Standard tap/drag, no momentum scrolling

## Risk Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Parallax jitter from compass noise | Poor UX | Use smoothed heading from CompassService |
| Color hard to see on sky | Visibility | Test on real sky photos; adjust alpha if needed |
| Slider touch targets too small | Accessibility | Enforce 48x48pt minimum per segment |
| FPS drop from parallax calc | Performance | Parallax is O(n) with n=particles, trivial overhead |

## Performance Budget

| Operation | Budget | Expected |
|-----------|--------|----------|
| AltitudeLevel property lookups | <0.1ms | ~0 (compile-time) |
| Parallax calculation (per particle) | <0.001ms | ~0.0001ms |
| Total parallax for 2000 particles | <1ms | ~0.2ms |
| Trail scale calculation | <0.001ms | ~0.0001ms |
| Color lookup | <0.001ms | ~0 |
| **Total added per frame** | **<2ms** | **~0.3ms** |

Current budget used by wind animation: ~7ms per 16ms frame
After altitude-depth: ~7.3ms per 16ms frame (well within 60 FPS budget)

## Handoff to Implement Agent

After planning is complete, the implement agent should:

1. Start with Phase 2 (Tests) - Write failing tests first
2. Implement Phase 3 (Core) in order listed in tasks.md
3. Run tests after each task to verify TDD compliance
4. Phase 4 (Integration) wires everything together
5. Phase 5 (Verification) confirms all acceptance criteria

## Success Criteria

- [ ] AltitudeLevel enum with all properties
- [ ] AltitudeSlider widget with glassmorphism style
- [ ] FakeWindService.getWindForAltitude() returns altitude-specific wind
- [ ] ParticleOverlay uses altitude color, parallax, and trail scale
- [ ] ARViewScreen integrates slider and altitude state
- [ ] All unit tests pass
- [ ] All widget tests pass
- [ ] 60 FPS maintained on real device
